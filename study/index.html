<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">勉強時間管理</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/webp" href="favicon.webp">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="description" content="勉強とともにタイマーをスタートし、作業時間を記録しましょう。">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js">const todoInput = document.getElementById("todoInput"); todoInput.isComposing = false;
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@300;400&family=Hina+Mincho&family=JetBrains+Mono:wght@300;400&family=Jost:wght@300;400&family=Klee+One:wght@300;400&family=Lora:wght@400&family=Montserrat:wght@300;400&family=Noto+Sans+JP:wght@300;400&family=Quicksand:wght@300;400&family=Sawarabi+Gothic&family=Zen+Kaku+Gothic+Antique:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@300;400&display=swap"
        rel="stylesheet">

    <style>
        @font-face {
            font-family: 'Utsukushi Font';
            src: url('UtsukushiFONT.otf') format('opentype');
        }

        @font-face {
            font-family: 'Misaki Gothic';
            src: url('misaki_gothic_2nd.ttf') format('truetype');
        }

        @font-face {
            font-family: 'Kodenmachou';
            src: url('KH-Dot-Kodenmachou-16.ttf') format('truetype');
        }

        @font-face {
            font-family: 'Shirokuma';
            src: url('001Shirokuma-Regular.otf') format('opentype');
        }

        @font-face {
            font-family: 'Mushin';
            src: url('mushin.otf') format('opentype');
        }

        :root {
            --font-ja: 'Zen Kaku Gothic Antique';
            --font-en: '';
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-en), var(--font-ja), system-ui, sans-serif;
            font-weight: 400;
        }

        body {
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.light {
            background-color: var(--bg-light);
            color: #323232;
        }

        body.dark {
            background-color: var(--bg-dark);
            color: #e8e8e8;
        }

        .container {
            text-align: center;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            font-weight: 400;
        }

        a {
            color: inherit;
            text-decoration: underline;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        strong,
        b,
        th {
            font-weight: 400;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .tyuui-mini-text {
            font-size: 0.8%;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .menu {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .menu button {
            padding: 10px 25px;
            font-size: 0.95rem;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 400;
        }

        .light .menu button {
            background-color: var(--panel-light);
            color: #323232;
        }

        .light .menu button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark .menu button {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .dark .menu button.active {
            background-color: var(--primary-color-dark);
            color: white;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .timer {
            font-size: 4rem;
            font-weight: 400;
            margin: 40px 0;
            font-variant-numeric: tabular-nums;
        }

        .session-info {
            font-size: 0.95rem;
            margin: 30px 0;
            opacity: 0.7;
            line-height: 1.8;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 40px;
        }

        button {
            padding: 15px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 400;
        }

        .light button.primary {
            background-color: var(--primary-color);
            color: white;
        }



        .dark button.primary {
            background-color: var(--primary-color-dark);
            color: white;
        }



        .light button.secondary {
            background-color: var(--panel-light);
            color: #323232;
        }



        .dark button.secondary {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }



        .top-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .theme-toggle,
        .settings-btn {
            width: 50px;
            height: 50px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
        }

        .light .theme-toggle,
        .light .settings-btn {
            background-color: var(--panel-light);
        }

        .dark .theme-toggle,
        .dark .settings-btn {
            background-color: var(--panel-dark);
        }

        .theme-toggle img,
        .settings-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        button:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none;
        }

        .history-list {
            max-height: 550px;
            overflow-y: auto;
            margin-top: 25px;
        }

        .history-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 24px;
            text-align: left;
            position: relative;
            transition: all 0.2s;
        }

        .history-item.selected {
            border: 2px solid;
        }

        .light .history-item.selected {
            border-color: var(--primary-color);
            background-color: var(--panel-light-2);
        }

        .dark .history-item.selected {
            border-color: var(--primary-color-dark);
            background-color: var(--panel-dark-2);
        }

        .history-item-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .light .history-item {
            background-color: var(--panel-light);
        }

        .dark .history-item {
            background-color: var(--panel-dark);
        }

        .history-item-date {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 10px;
        }

        .history-item-time {
            font-size: 0.95rem;
            opacity: 0.8;
            line-height: 1.6;
        }

        .history-item-duration {
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: 400;
        }

        .light .history-item-duration {
            color: var(--primary-color);
        }

        .dark .history-item-duration {
            color: var(--primary-color-dark);
        }

        .empty-state {
            margin-top: 50px;
            opacity: 0.5;
            font-size: 1rem;
        }

        .clear-history {
            margin-top: 35px;
        }

        .search-box {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
            padding: 12px 25px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .light .search-box input {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .search-box input {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .light .search-box input::placeholder {
            color: #8a8a8a;
        }

        .dark .search-box input::placeholder {
            color: #a8a8a8;
        }

        .search-box input:focus {
            outline: none;
        }

        .light .search-box input:focus {
            background-color: var(--panel-light-focus);
        }

        .dark .search-box input:focus {
            background-color: var(--panel-dark-2);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 35px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 24px;
            text-align: center;
        }

        .light .stat-card {
            background-color: var(--panel-light);
        }

        .dark .stat-card {
            background-color: var(--panel-dark);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 400;
        }

        .light .stat-value {
            color: var(--primary-color);
        }

        .dark .stat-value {
            color: var(--primary-color-dark);
        }

        .group-selector {
            margin-bottom: 25px;
        }

        .group-selector select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
        }

        .light .group-selector select {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .group-selector select {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .group-input {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .group-input input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .light .group-input input {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .group-input input {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .group-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 24px;
            font-size: 0.85rem;
            margin-top: 8px;
            font-weight: 400;
        }

        .light .group-badge {
            background-color: var(--primary-color);
            color: white;
        }

        .dark .group-badge {
            background-color: var(--primary-color-dark);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .action-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-group-container {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            gap: 12px;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }

        .move-group-container.active {
            display: flex;
        }

        .move-count {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-right: 8px;
            min-width: 86px;
            text-align: center;
        }

        .light .move-group-container {
            background-color: var(--bg-light);
            border-top: 1px solid var(--panel-light-border);
        }

        .dark .move-group-container {
            background-color: var(--panel-dark);
            border-top: 1px solid var(--panel-dark);
        }

        .light .move-group-container input {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .move-group-container input {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .light .move-group-container input:focus {
            outline: none;
            background-color: var(--panel-light-focus);
            box-shadow: 0 0 0 3px rgba(107, 123, 140, 0.1);
        }

        .dark .move-group-container input:focus {
            outline: none;
            background-color: var(--panel-dark-2);
            box-shadow: 0 0 0 3px rgba(122, 139, 156, 0.1);
        }

        .light .move-group-container input::placeholder {
            color: #9a9a9a;
        }

        .dark .move-group-container input::placeholder {
            color: #8a8a8a;
        }

        .move-group-container button {
            padding: 14px 24px;
            white-space: nowrap;
            border-radius: 24px;
        }

        .move-group-buttons {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .move-group-buttons button {
            padding: 10px 16px;
            white-space: nowrap;
            border-radius: 24px;
        }

        .modal {
            display: none;
        }

        .theme-selector {
            margin-bottom: 35px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .theme-option {
            padding: 15px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            text-align: center;
        }

        .theme-option:hover {
            transform: scale(1.05);
        }

        .theme-option.selected {
            border-color: #000;
        }

        .dark .theme-option.selected {
            border-color: #fff;
        }

        .theme-option-name {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .theme-option-preview {
            width: 100%;
            height: 40px;
            border-radius: 12px;
            display: flex;
            gap: 3px;
            padding: 5px;
        }

        .theme-option-preview div {
            flex: 1;
            border-radius: 8px;
        }

        .copyright {
            margin-top: 50px;
            padding-top: 25px;
            border-top: 1px solid;
            font-size: 0.85rem;
            opacity: 0.5;
        }

        .light .copyright {
            border-color: var(--panel-light-border);
        }

        .dark .copyright {
            border-color: var(--panel-dark-2);
        }

        .settings-section {
            margin-bottom: 35px;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 24px;
            margin-bottom: 10px;
        }

        .light .toggle-item {
            background-color: var(--panel-light);
        }

        .dark .toggle-item {
            background-color: var(--panel-dark);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #ccc;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: var(--primary-color);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Focus mode toggle removed - uses standard toggle-item styling */

        .music-player {
            margin-bottom: 35px;
            text-align: left;
        }

        .music-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }


        .file-select-group {
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            width: 100%;
        }

        /* file label contains left arrow + text */
        .file-select-label {
            display: block;
            position: relative;
            flex: 1;
            padding: 12px 15px;
            padding-right: 44px;
            /* space for right arrow */
            border-radius: 24px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            text-align: center;
            background: var(--panel-light);
        }

        /* place arrow at fixed right inside the label, text stays centered */
        .file-select-label .file-select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: inline-block;
            cursor: pointer;
        }

        .file-select-label .file-select-text {
            display: inline-block;
            width: 100%;
            pointer-events: none;
            /* allow label to receive clicks */
            text-align: center;
        }

        .file-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 160px;
            background: var(--panel-light);
            color: #323232;
            border-radius: 24px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            z-index: 60;
            display: none;
            overflow: hidden;
        }

        .file-dropdown-menu .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .file-dropdown-menu .dropdown-item:hover {
            background: var(--panel-light-hover);
        }

        .music-controls input[type="file"] {
            display: none;
        }

        .light .music-controls label {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .music-controls label {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .music-controls label:hover {
            opacity: 0.8;
        }

        .music-controls button {
            padding: 12px 20px;
            font-size: 0.9rem;
        }

        .player-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .player-controls button {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .player-controls .control-icon {
            font-size: 1.2rem;
        }

        .playlist {
            max-height: 300px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 12px 15px;
            border-radius: 24px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 10px;
        }

        .light .playlist-item {
            background-color: var(--panel-light);
        }

        .dark .playlist-item {
            background-color: var(--panel-dark);
        }

        .playlist-item:hover {
            opacity: 0.8;
        }

        .playlist-item.playing {
            border: 2px solid var(--primary-color);
            background-color: rgba(157, 180, 200, 0.1);
        }

        .dark .playlist-item.playing {
            border-color: var(--primary-color-dark);
        }

        .filter-control-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 24px;
            transition: all 0.2s;
        }

        .light .filter-control-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark .filter-control-btn.active {
            background-color: var(--primary-color-dark);
            color: white;
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-buttons {
            display: flex;
            gap: 5px;
        }

        .playlist-item button {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .todo-list {
            text-align: left;
            max-width: 100%;
            overflow-x: hidden
        }

        .todo-input {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            max-width: 100%;
            overflow-x: hidden
        }

        .todo-input input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .light .todo-input input {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .todo-input input {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .todo-items {
            max-height: 400px;
            overflow-y: auto;
        }

        .todo-item {
            padding: 15px;
            border-radius: 24px;
            margin-bottom: 10px;
            /* 中央カラムを持つ grid レイアウトにして、タイトルを中央揃えにする */
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
        }

        .light .todo-item {
            background-color: var(--panel-light);
        }

        .dark .todo-item {
            background-color: var(--panel-dark);
        }

        .todo-item.completed {
            opacity: 0.5;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
        }

        .todo-checkbox {
            /* サイズと余白のみ維持 */
            width: 20px;
            height: 20px;
        }

        .todo-text {
            flex: 1;
            word-break: break-word;
            text-align: center;
            justify-self: center;
        }

        .todo-delete {
            padding: 6px 12px;
            font-size: 0.8rem;
            background-color: #d66;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .todo-delete:hover {
            background-color: #c55;
        }

        /* カスタム確認ダイアログ */
        .custom-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .custom-confirm-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUpCentered {
            from {
                transform: translate(-50%, -40%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .custom-confirm-dialog {
            border-radius: 24px;
            padding: 30px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .light .custom-confirm-dialog {
            background-color: var(--bg-light);
            color: #323232;
        }

        .dark .custom-confirm-dialog {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        /* カスタム確認ダイアログのアイコン部分を変更 */
        .custom-confirm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .custom-confirm-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .light .custom-confirm-icon {
            background-color: var(--panel-light);
        }

        .dark .custom-confirm-icon {
            background-color: var(--panel-dark-2);
        }

        .custom-confirm-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .custom-confirm-message {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 28px;
            text-align: center;
            opacity: 0.85;
        }

        .custom-confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-confirm-buttons button {
            flex: 1;
            padding: 14px 24px;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .custom-confirm-cancel {
            background-color: transparent;
            border: 2px solid;
        }

        .light .custom-confirm-cancel {
            border-color: var(--panel-light-border);
            color: #5a5a5a;
        }

        .dark .custom-confirm-cancel {
            border-color: var(--panel-dark-2);
            color: #c8c8c8;
        }

        .custom-confirm-cancel:hover {
            transform: scale(1.02);
        }

        .light .custom-confirm-cancel:hover {
            background-color: var(--panel-light);
        }

        .dark .custom-confirm-cancel:hover {
            background-color: var(--panel-dark-2);
        }

        .custom-confirm-ok {
            color: white;
        }

        .light .custom-confirm-ok {
            background-color: var(--primary-color);
        }

        .dark .custom-confirm-ok {
            background-color: var(--primary-color-dark);
        }

        .light .custom-confirm-ok:hover {
            background-color: var(--primary-hover);
        }

        .dark .custom-confirm-ok:hover {
            background-color: var(--primary-hover-dark);
        }

        @media (min-width: 769px) {
            .move-group-container {
                position: static;
                box-shadow: none;
                border: none;
                padding: 0;
                margin-bottom: 24px;
            }

            .light .move-group-container {
                background-color: transparent;
                border: none;
            }

            .dark .move-group-container {
                background-color: transparent;
                border: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px 12px;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            .timer {
                font-size: 3rem;
                margin: 30px 0;
            }

            .top-buttons {
                top: 15px;
                right: 15px;
            }

            .theme-toggle,
            .settings-btn {
                width: 45px;
                height: 45px;
            }

            .menu button {
                padding: 8px 20px;
                font-size: 0.9rem;
            }

            button {
                padding: 12px 25px;
                font-size: 0.95rem;
            }

            .history-item {
                padding: 15px;
            }

            .move-group-container {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
                gap: 12px;
            }

            .move-group-container input {
                min-width: 100%;
            }

            .move-group-container button {
                width: 100%;
            }

            .move-group-buttons {
                display: flex;
                gap: 12px;
            }

            .move-group-buttons button {
                flex: 1;
            }

            .move-group-container.active~.history-list {
                padding-bottom: 180px;
            }

            .theme-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .custom-confirm-dialog {
                padding: 25px;
            }

            .custom-confirm-buttons {
                flex-direction: column;
            }

            .custom-confirm-buttons button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .timer {
                font-size: 2.5rem;
            }

            .session-info {
                font-size: 0.9rem;
            }

            .history-item-date {
                font-size: 1rem;
            }

            .history-item-time {
                font-size: 0.85rem;
            }

            .history-item-duration {
                font-size: 1.1rem;
            }
        }

        :root {
            --primary-color: #9db4c8;
            --primary-hover: #8ba4b8;
            --primary-color-dark: #7a95ab;
            --primary-hover-dark: #6a859b;
            --bg-light: #f8f9fb;
            --bg-dark: #2d3142;
            /* Panel colors - soft/pale defaults */
            --panel-dark: #474654;
            --panel-dark-2: #3d4454;
            --panel-light: #f0f2f7;
            /* Light-mode helpers (theme-aware) */
            --panel-light-hover: #e6e8ed;
            --panel-light-2: #f0f2f7;
            --panel-light-border: #dfe1e6;
            --panel-light-focus: #eceef3;
        }

        body[data-theme="green"] {
            --primary-color: #a8c9a8;
            --primary-hover: #96b996;
            --primary-color-dark: #88ab88;
            --primary-hover-dark: #789b78;
            --bg-light: #f7faf7;
            --bg-dark: #2d3a30;
            --panel-dark: #242e28;
            --panel-dark-2: #3a4740;
            --panel-light: #eff5ef;
            --panel-light-2: #eff5ef;
        }

        body[data-theme="purple"] {
            --primary-color: #b8a8c9;
            --primary-hover: #9f8ff2;
            --primary-color-dark: #9a88ab;
            --primary-hover-dark: #9f8ff2;
            --bg-light: #faf7fb;
            --bg-dark: #332d3a;
            --panel-dark: #2c2430;
            --panel-dark-2: #443a4a;
            --panel-light: #f5eff7;
            --panel-light-2: #f5eff7;
        }

        body[data-theme="orange"] {
            --primary-color: #d9b4a0;
            --primary-hover: #c9a490;
            --primary-color-dark: #b99480;
            --primary-hover-dark: #a98470;
            --bg-light: #faf6f3;
            --bg-dark: #3a312d;
            --panel-dark: #2e2621;
            --panel-dark-2: #4a3f38;
            --panel-light: #f5f0ed;
            --panel-light-2: #f5f0ed;
        }

        body[data-theme="pink"] {
            --primary-color: #d9a8b4;
            --primary-hover: #c996a4;
            --primary-color-dark: #b98896;
            --primary-hover-dark: #a97886;
            --bg-light: #faf7f8;
            --bg-dark: #3a2d30;
            --panel-dark: #2e2426;
            --panel-dark-2: #4a3a3e;
            --panel-light: #f5eff1;
            --panel-light-2: #f5eff1;
        }

        body[data-theme="teal"] {
            --primary-color: #a0c9c9;
            --primary-hover: #90b9b9;
            --primary-color-dark: #80abab;
            --primary-hover-dark: #709b9b;
            --bg-light: #f7fafa;
            --bg-dark: #2d3a3a;
            --panel-dark: #243030;
            --panel-dark-2: #3a4848;
            --panel-light: #eff5f5;
            --panel-light-2: #eff5f5;
        }

        body[data-theme="white"] {
            --primary-color: rgba(178, 178, 178);
            --primary-hover: #dadada;
            --primary-color-dark: rgba(178, 178, 178);
            --primary-hover-dark: #bbb;
            --bg-light: #fdfdfd;
            --bg-dark: #0a0a0a;
            --panel-dark: #151515;
            --panel-dark-2: #323232;
            --panel-light: #f5f5f5;
            --panel-light-2: #f5f5f5;
        }

        /* Blue theme (default) panel overrides */
        body[data-theme="blue"] {
            --panel-dark: #252a38;
            --panel-dark-2: #3d4454;
            --panel-light: #f0f2f7;
        }

        /* Custom styled dropdown for group filter */
        .custom-select {
            position: relative;
            display: inline-block;
            width: 260px;
            max-width: 100%;
            font-size: 0.95rem;
        }

        .custom-select select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 100%;
            padding: 10px 40px 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: var(--panel-light);
            color: inherit;
            box-shadow: none;
            cursor: pointer;
            transition: box-shadow 120ms ease, transform 120ms ease;
        }

        .custom-select:focus-within select {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .custom-select .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.78rem;
            opacity: 0.9;
        }

        .dark .custom-select select {
            background: var(--panel-dark);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dark .custom-select .select-arrow {
            color: rgba(255, 255, 255, 0.7);
        }

        .light .custom-select .select-arrow {
            color: rgba(0, 0, 0, 0.45);
        }

        @media (max-width: 480px) {
            .custom-select {
                width: 100%;
            }
        }

        /* About modal styles */
        .about-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            z-index: 2000;
            padding: 20px;
        }

        .about-overlay.show {
            display: flex;
        }

        .about-dialog {
            width: 100%;
            max-width: 720px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            background: var(--panel-light);
            color: inherit;
            border-radius: 24px;
            padding: 22px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(6px);
            animation: slideUp .18s ease-out;
        }

        .dark .about-dialog {
            background: var(--panel-dark);
        }

        .about-dialog h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.25rem;
        }

        .about-content {
            line-height: 1.7;
            opacity: 0.95;
            text-align: left;
            overflow-y: auto;
        }

        .about-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .no-scroll {
            overflow: hidden;
        }

        /* About button (minimal pill) */
        .about-link {
            text-align: center;
            margin-top: 12px;
        }

        .about-button {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            width: 200px;
            max-width: 100%;
            padding: 8px 12px;
            font-size: 0.92rem;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: transparent;
            color: inherit;
            cursor: pointer;
            transition: background-color 160ms ease, transform 120ms ease, box-shadow 160ms ease;
            box-shadow: none;
        }

        .about-button .about-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
        }

        .about-button .about-icon svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .about-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(107, 123, 140, 0.07);
            transform: translateY(-1px);
        }

        .about-button:hover {
            transform: translateY(-2px);
        }

        .light .about-button {
            border-color: rgba(0, 0, 0, 0.06);
        }

        .dark .about-button {
            border-color: rgba(255, 255, 255, 0.06);
        }

        .light .about-button:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .dark .about-button:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Data management section */
        .data-management {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .data-management button {
            flex: 1;
            min-width: 160px;
            padding: 12px 20px;
            font-size: 0.9rem;
            border-radius: 24px;
        }

        /* チュートリアル関連スタイル */
        .tutorial-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            backdrop-filter: blur(3px);
            pointer-events: none;
        }

        .tutorial-overlay.show {
            display: block;
        }

        .tutorial-welcome {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--panel-light);
            color: inherit;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
        }

        .dark .tutorial-welcome {
            background: var(--panel-dark);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .tutorial-welcome h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .tutorial-welcome p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 16px;
            opacity: 0.9;
        }

        .tutorial-welcome-buttons {
            display: flex;
            gap: 10px;
        }

        .tutorial-welcome-buttons button {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.9rem;
            border-radius: 24px;
        }

        .tutorial-box {
            position: fixed;
            background: var(--panel-light);
            color: inherit;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 10002;
            max-width: 400px;
            width: calc(100vw - 40px);
            animation: fadeIn 0.3s ease-out;
            pointer-events: auto;
        }

        .dark .tutorial-box {
            background: var(--panel-dark);
        }

        .tutorial-box h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .tutorial-box p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 16px;
            opacity: 0.9;
        }

        .tutorial-step-info {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 12px;
        }

        .tutorial-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .tutorial-buttons button {
            padding: 10px 20px;
            font-size: 0.9rem;
            border-radius: 24px;
        }

        .tutorial-highlight {
            position: relative;
            z-index: 10001 !important;
            box-shadow: 0 0 0 4px rgba(157, 180, 200, 0.5) !important;
            border-radius: 24px !important;
        }

        .tutorial-click-area {
            position: fixed;
            z-index: 10001;
            cursor: pointer;
            border-radius: 24px;
        }

        .tutorial-arrow {
            position: absolute;
            width: 0;
            height: 0;
            z-index: 10002;
        }

        .tutorial-arrow-up {
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid var(--panel-light);
        }

        .dark .tutorial-arrow-up {
            border-bottom-color: var(--panel-dark);
        }

        .tutorial-arrow-down {
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--panel-light);
        }

        .dark .tutorial-arrow-down {
            border-top-color: var(--panel-dark);
        }

        .tutorial-arrow-left {
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid var(--panel-light);
        }

        .dark .tutorial-arrow-left {
            border-right-color: var(--panel-dark);
        }

        .tutorial-arrow-right {
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 10px solid var(--panel-light);
        }

        .dark .tutorial-arrow-right {
            border-left-color: var(--panel-dark);
        }

        @media (max-width: 768px) {
            .tutorial-welcome {
                top: 70px;
                right: 10px;
                width: calc(100vw - 20px);
            }

            .tutorial-box {
                max-width: calc(100vw - 20px);
            }

            .todo-input {
                display: flex;
                gap: 8px;
                margin-bottom: 20px;
                max-width: 100%;
                box-sizing: border-box;
            }

            .todo-input button {
                padding: 12px 20px;
                white-space: nowrap;
                max-width: 100%;
            }

            .todo-list,
            .todo-items {
                max-width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }

            .todo-item {
                padding: 16px;
                border-radius: 24px;
                margin-bottom: 10px;
                display: flex;
                align-items: flex-start;
                gap: 12px;
            }

            .todo-text {
                flex: 1;
                line-height: 1.5;
                word-break: break-all;
                margin-top: 2px;
            }

            .todo-meta {
                margin-top: 6px;
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .todo-checkbox {
                width: 22px;
                height: 22px;
                flex-shrink: 0;
                margin-top: 2px;
            }

            .todo-delete {
                padding: 6px 12px;
                font-size: 0.75rem;
                background-color: #ff6b6b;
                color: white;
                margin-left: 4px;
                flex-shrink: 0;
            }

            .todo-options {
                display: flex;
                gap: 10px;
                flex-direction: column;
                margin-bottom: 20px;
            }

            .todo-options>div {
                display: flex;
                gap: 10px;
            }

            .todo-filter {
                display: flex;
                overflow-x: auto;
                padding-bottom: 5px;
                gap: 8px;
                -webkit-overflow-scrolling: touch;
            }

            .todo-filter-btn {
                flex-shrink: 0;
            }
        }

        /* Todo関連の追加スタイル */
        .todo-priority-high {
            border-left: 4px solid #e74c3c;
        }

        .todo-priority-normal {
            border-left: 4px solid #3498db;
        }

        .todo-priority-low {
            border-left: 4px solid #95a5a6;
        }

        .todo-repeat-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 24px;
            font-size: 0.75rem;
            margin-left: 8px;
            font-weight: 500;
        }

        .light .todo-repeat-badge {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .dark .todo-repeat-badge {
            background-color: rgba(255, 255, 255, 0.1);
            color: #efefef;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .todo-category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 24px;
            font-size: 0.75rem;
            margin-left: 8px;
            font-weight: 500;
        }

        .todo-category-study {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .todo-category-work {
            background-color: rgba(230, 126, 34, 0.2);
            color: #e67e22;
        }

        .todo-category-personal {
            background-color: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .todo-category-shopping {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .todo-category-health {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .todo-category-other {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }



        .dark .todo-filter-btn.active {
            background-color: var(--primary-color-dark) !important;
        }

        .todo-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        /* グラフ設定の追加スタイル */
        #graphSettings {
            padding: 15px;
            border-radius: 24px;
            margin-top: 15px;
        }

        .light #graphSettings {
            background-color: var(--panel-light);
        }

        .dark #graphSettings {
            background-color: var(--panel-dark);
        }

        #studyGraphContainer,
        #statsGraphContainer {
            padding: 20px;
            border-radius: 24px;
        }

        .light #studyGraphContainer,
        .light #statsGraphContainer {
            background-color: var(--panel-light);
        }

        .dark #studyGraphContainer,
        .dark #statsGraphContainer {
            background-color: var(--panel-dark);
        }

        #studyGraphContainer h2,
        #statsGraphContainer h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-align: left;
        }

        .todo-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
        }

        .todo-checkbox {
            flex-shrink: 0;
            margin-top: 0;
            align-self: center;
        }

        .todo-text {
            display: flex;
            align-items: center;
            line-height: 1.5;
            padding-top: 0;
            justify-self: center;
            text-align: center;
        }


        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .todo-checkbox {
            flex-shrink: 0;
            margin-top: 6px;
        }

        .todo-text {
            line-height: 1.6;
            padding-top: 3px;
        }

        .todo-delete {
            align-self: flex-start;
            margin-top: 3px;
        }

        /* ドラッグハンドル画像 */
        .drag-handle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            opacity: 0.8;
            margin-right: 8px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* ドラッグ中のスタイル */
        .playlist-item.dragging {
            opacity: 0.6;
            border: 2px dashed #999;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #8ba4b8;
            /* Initial color (Default blue theme hover) */
            z-index: 999999;
            pointer-events: none;
        }

        #loadingOverlay.wipe-out {
            animation: diagonalEraser 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes diagonalEraser {
            0% {
                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            }

            100% {
                clip-path: polygon(200% 0%, 200% 0%, 100% 100%, 100% 100%);
            }
        }

        .playlist-item.drag-over {
            border: 2px solid #2196F3;
            background-color: rgba(33, 150, 243, 0.1);
        }

        /* 一貫した削除ボタン */
        .delete-btn,
        .todo-delete {
            padding: 6px 12px;
            font-size: 0.8rem;
            background-color: #d66;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }


        /* スマホ対策 & UI改善 */
        @media (hover: hover) {
            .light button.primary:hover {
                background-color: var(--primary-hover);
            }

            .dark button.primary:hover {
                background-color: var(--primary-hover-dark);
            }

            .light button.secondary:hover {
                background-color: var(--panel-light-hover);
                transform: scale(1.02);
            }

            .dark button.secondary:hover {
                background-color: var(--panel-dark-2);
                transform: scale(1.02);
            }

            .delete-btn:hover,
            .todo-delete:hover {
                background-color: #c55;
            }
        }

        /* ToDo Ver.2 スタイル */
        .todo-v2-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .todo-v2-popup-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-v2-popup {
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            text-align: center;
        }

        .light .todo-v2-popup {
            background-color: var(--bg-light);
            color: #323232;
        }

        .dark .todo-v2-popup {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .todo-v2-popup-title {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 20px;
        }

        .todo-v2-popup-message {
            font-size: 1rem;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .todo-v2-popup-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .todo-v2-popup-toggle-label {
            font-size: 1.1rem;
        }

        .todo-v2-popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .todo-v2-popup-buttons button {
            padding: 12px 30px;
            font-size: 1rem;
        }

        .todo-v2-details {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        .dark .todo-v2-details {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.03);
        }

        .todo-stage-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .todo-stage-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            opacity: 0.9;
            user-select: none;
            padding: 4px 0;
        }

        .todo-stage-checkbox {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        /* カスタムチェックボックスの枠線などの基本設定は input[type="checkbox"] で一括定義済み */

        .todo-progress-container {
            margin-top: 8px;
            width: 100%;
        }

        .todo-progress-bar {
            height: 4px;
            background: #ddd;
            border-radius: 24px;
            overflow: hidden;
            width: 100%;
        }

        .light .todo-progress-bar {
            background: rgba(0, 0, 0, 0.1);
        }

        .dark .todo-progress-bar {
            background: rgba(255, 255, 255, 0.1);
        }

        .todo-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
            border-radius: 24px;
        }

        .dark .todo-progress-fill {
            background: var(--primary-color-dark);
        }

        .todo-period {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 6px;
        }

        /* カレンダービュー */
        .calendar-view {
            padding: 20px 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header button {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .calendar-month-year {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        @media (max-width: 480px) {
            .calendar-grid {
                gap: 2px;
                width: 100%;
                max-width: 100%;
                margin: 0 auto;
            }
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            padding: 8px;
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .calendar-day-header {
                padding: 2px;
                font-size: 0.7rem;
            }
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid;
            border-radius: 16px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 480px) {
            .calendar-day {
                padding: 1px;
                min-height: auto;
                aspect-ratio: auto;
                height: 45px;
                max-width: calc((100vw - 24px - 12px) / 7);
                /* container padding + gap */
            }
        }

        .light .calendar-day {
            border-color: rgba(0, 0, 0, 0.1);
            background: var(--panel-light);
        }

        .dark .calendar-day {
            border-color: rgba(255, 255, 255, 0.1);
            background: var(--panel-dark);
        }

        .calendar-day:hover {
            transform: scale(1.02);
        }

        .light .calendar-day:hover {
            background: var(--panel-light-hover);
        }

        .dark .calendar-day:hover {
            background: var(--panel-dark-2);
        }

        .calendar-day-number {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        @media (max-width: 480px) {
            .calendar-day-number {
                font-size: 0.8rem;
            }
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            /* 枠線は廃止し、数字の強調のみにする */
            border-width: 1px;
        }

        .light .calendar-day.today {
            border-color: rgba(0, 0, 0, 0.1);
        }

        .dark .calendar-day.today {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.today::after {
            display: none;
        }

        /* 今日の日付数字を丸く囲む */
        .calendar-day.today .calendar-day-number {
            display: inline-flex;
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: #fff;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px auto;
            /* 中央寄せに変更 */
            line-height: 1;
            /* 垂直位置調整 */
            padding-top: 1px;
            /* フォントによる微調整 */
        }

        .dark .calendar-day.today .calendar-day-number {
            background-color: var(--primary-color-dark);
            color: #fff;
        }

        .calendar-day.has-todos {
            background-color: transparent !important;
            border-left: 4px solid var(--primary-color) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        .dark .calendar-day.has-todos {
            border-left-color: var(--primary-color-dark) !important;
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        }

        .calendar-todo-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .calendar-todo-indicator {
            display: none;
            /* 従来のドットは非表示 */
        }

        .calendar-todo-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: var(--primary-color);
            color: white;
            font-size: 0.65rem;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            padding: 0 4px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        @media (max-width: 480px) {
            .calendar-day.today .calendar-day-number {
                width: 20px;
                height: 20px;
                font-size: 0.75rem;
                margin-bottom: 2px;
            }
        }

        .light .calendar-todo-badge {
            color: #fff;
        }

        /* 重複する定義を削除 */

        .light .calendar-todo-indicator {
            background: var(--primary-color);
        }

        .dark .calendar-todo-indicator {
            background: var(--primary-color-dark);
        }

        /* ToDoビュー切り替えメニュー */
        .todo-view-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .todo-view-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .light .todo-view-btn {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .todo-view-btn {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .light .todo-view-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark .todo-view-btn.active {
            background-color: var(--primary-color-dark);
            color: white;
        }

        /* カスタム日付ピッカー */
        .custom-date-picker {
            position: relative;
            width: 100%;
        }

        .custom-date-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .light .custom-date-input {
            background-color: var(--panel-light);
            color: #323232;
        }

        .dark .custom-date-input {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .custom-date-input:hover {
            opacity: 0.9;
        }

        .date-picker-dropdown {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            z-index: 10001;
            width: 90%;
            max-width: 380px;
            animation: slideUpCentered 0.3s ease-out;
        }

        /* 外部クリックを検知するためのオーバーレイを擬似的に表現するか、スクリプトで制御 */
        .date-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .date-picker-overlay.show,
        .date-picker-dropdown.show {
            display: block;
        }

        .date-picker-overlay.show {
            display: block;
        }

        .date-picker-dropdown.show {
            display: block;
        }

        .light .date-picker-dropdown {
            background-color: var(--bg-light);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #323232;
        }

        .dark .date-picker-dropdown {
            background-color: var(--panel-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
        }

        .date-picker-dropdown.show {
            display: block;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-picker-header button {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .date-picker-month-year {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .date-picker-day-header {
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.7;
            padding: 8px 4px;
        }

        .date-picker-day {
            aspect-ratio: 1;
            border-radius: 50%;
            /* 丸に変更 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            line-height: 1;
            /* 垂直位置調整 */
            padding-top: 1px;
            /* 微調整 */
        }

        .light .date-picker-day {
            background: var(--panel-light);
        }

        .dark .date-picker-day {
            background: var(--panel-dark-2);
        }

        .date-picker-day:hover {
            transform: scale(1.1);
        }

        .light .date-picker-day:hover {
            background: var(--panel-light-hover);
        }

        .dark .date-picker-day:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .date-picker-day.other-month {
            opacity: 0.3;
        }

        .date-picker-day.today {
            font-weight: 600;
        }

        .light .date-picker-day.today {
            background-color: var(--primary-color);
            color: white;
        }

        .dark .date-picker-day.today {
            background-color: var(--primary-color-dark);
            color: white;
        }

        .date-picker-day.selected {
            font-weight: 600;
        }

        .light .date-picker-day.selected {
            background: var(--primary-color);
            color: white;
        }

        .dark .date-picker-day.selected {
            background: var(--primary-color-dark);
            color: white;
        }

        /* カレンダー日付詳細ダイアログ */
        .calendar-day-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .calendar-day-dialog-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day-dialog {
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .light .calendar-day-dialog {
            background-color: var(--bg-light);
            color: #323232;
        }

        .dark .calendar-day-dialog {
            background-color: var(--panel-dark);
            color: #e8e8e8;
        }

        .calendar-day-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-day-dialog-title {
            font-size: 1.3rem;
            font-weight: 500;
        }

        .calendar-day-dialog-close {
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
        }

        .calendar-day-todos {
            margin-bottom: 20px;
        }

        .calendar-day-todo-item {
            padding: 12px;
            border-radius: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .light .calendar-day-todo-item {
            background-color: var(--panel-light);
        }

        .dark .calendar-day-todo-item {
            background-color: var(--panel-dark-2);
        }

        .calendar-day-add-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid;
        }

        .light .calendar-day-add-form {
            border-color: rgba(0, 0, 0, 0.1);
        }

        .dark .calendar-day-add-form {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* カスタムチェックボックス (全般) */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            background-color: transparent;
            margin: 0;
            padding: 0;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            display: inline-block;
            vertical-align: middle;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;

            /* デフォルトサイズ (クラスで指定がない場合) */
            width: 18px;
            height: 18px;
        }

        /* 履歴アイテムのチェックボックスを右上に強制固定 */
        .history-item-checkbox {
            position: absolute !important;
            top: 15px !important;
            right: 15px !important;
            width: 24px !important;
            height: 24px !important;
            margin: 0;
        }

        /* ToDoリストのチェックボックスの位置微調整 */
        .todo-checkbox {
            /* 移動用のマージンを廃止し、flex の中央揃えで対処 */
            margin-top: 0 !important;
            display: inline-block;
            vertical-align: middle;
            align-self: center;
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .todo-checkbox {
                margin-top: 0 !important;
            }
        }

        .dark input[type="checkbox"] {
            border-color: rgba(255, 255, 255, 0.3);
        }

        input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark input[type="checkbox"]:checked {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* チェックマークアイコン */
        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            /* より厳密に中央に寄せる */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 30%;
            height: 55%;
            /* 少し細めにして小さなボックスでもバランスが良くなるように */
            border-bottom: 2px solid white;
            border-right: 2px solid white;
            opacity: 0;
            animation: checkAnim 0.2s forwards;
        }

        /* ToDo 用にさらに細かく補正(小さいボックスでの縦ずれ対策) */
        .todo-checkbox:checked::after {
            top: 50%;
            transform: translate(-50%, -52%) rotate(45deg);
            width: 34%;
            height: 62%;
            border-bottom-width: 2px;
            border-right-width: 2px;
        }

        @keyframes checkAnim {
            from {
                opacity: 0;
                width: 0;
                height: 0;
            }

            to {
                opacity: 1;
                width: 30%;
                height: 55%;
            }
        }

        /* ホバー効果 */
        @media (hover: hover) {
            input[type="checkbox"]:hover {
                border-color: var(--primary-color);
                background-color: rgba(157, 180, 200, 0.1);
            }

            .dark input[type="checkbox"]:hover {
                border-color: var(--primary-color-dark);
                background-color: rgba(255, 255, 255, 0.05);
            }

            input[type="checkbox"]:checked:hover {
                background-color: var(--primary-hover);
                border-color: var(--primary-hover);
            }

            .dark input[type="checkbox"]:checked:hover {
                background-color: var(--primary-hover-dark);
                border-color: var(--primary-hover-dark);
            }
        }

        /* モバイル対応レスポンシブスタイル */
        @media (max-width: 600px) {
            .todo-v2-popup {
                padding: 25px;
                width: 85%;
            }

            .todo-v2-popup-title {
                font-size: 1.25rem;
            }

            .todo-v2-popup-message {
                font-size: 0.9rem;
            }

            .todo-item {
                /* モバイルでは grid を解除して横並びにして可読性を保つ */
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 12px;
            }

            .todo-text {
                /* モバイルでは左寄せ */
                text-align: left;
                justify-self: start;
            }

            .todo-stage-checkboxes {
                gap: 4px;
                margin-right: 6px;
                margin-top: 4px;
                /* Align with text top */
            }

            .todo-stage-checkbox {
                width: 16px;
                height: 16px;
            }

            .calendar-header button {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .calendar-month-year {
                font-size: 1rem;
            }

            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                padding: 4px;
                min-height: 50px;
                border-radius: 20px;
            }

            .calendar-day-number {
                font-size: 0.8rem;
            }

            .calendar-todo-indicator {
                width: 4px;
                height: 4px;
            }

            .date-picker-dropdown {
                min-width: unset;
                width: 90%;
                max-width: 350px;
                padding: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            }

            .calendar-day-dialog {
                padding: 20px;
                width: 85%;
            }

            .calendar-day-dialog-title {
                font-size: 1.1rem;
            }
        }
    </style>

</head>

<body class="light" data-theme="blue">
    <script>
        // Apply saved theme/mode immediately before first paint to prevent flash
        try {
            var _m = localStorage.getItem('mode');
            var _t = localStorage.getItem('theme');
            if (_m === 'dark') { document.body.className = 'dark'; }
            if (_t) { document.body.setAttribute('data-theme', _t.trim()); }
        } catch(e) {}
    </script>
    <div id="loadingOverlay"></div>

    <div class="custom-confirm-overlay" id="customConfirmOverlay">
        <div class="custom-confirm-dialog">
            <div class="custom-confirm-icon" id="confirmIcon">
                <img id="confirmIconImg" src="warning.webp" alt="確認" data-i18n-alt="confirmIconAlt">
            </div>
            <div class="custom-confirm-title" id="confirmTitle" data-i18n="confirmDefaultTitle">確認</div>
            <div class="custom-confirm-message" id="confirmMessage" data-i18n="confirmMessage">この操作を実行しますか?</div>
            <div class="custom-confirm-buttons">
                <button class="custom-confirm-cancel" id="confirmCancel" data-i18n="cancelButton">キャンセル</button>
                <button class="custom-confirm-ok" id="confirmOk" data-i18n="okButton">OK</button>
            </div>
        </div>
    </div>

    <div class="custom-confirm-overlay" id="renameOverlay">
        <div class="custom-confirm-dialog">
            <div class="custom-confirm-title" id="renameTitle" data-i18n="renameSong">曲名を変更</div>
            <input type="text" id="renameInput" placeholder="曲名を入力" data-i18n="songNamePlaceholder"
                style="width:100%; padding:12px 15px; border:none; border-radius:24px; font-size:0.95rem; font-family:inherit; margin-bottom:20px;">
            <div class="custom-confirm-buttons">
                <button class="custom-confirm-cancel" id="renameCancelBtn" data-i18n="cancelButton">キャンセル</button>
                <button class="custom-confirm-ok" id="renameOkBtn" data-i18n="saveButton">保存</button>
            </div>
        </div>
    </div>

    <!-- ToDo Ver.2 ポップアップ -->
    <div class="todo-v2-popup-overlay" id="todoV2PopupOverlay">
        <div class="todo-v2-popup">
            <div class="todo-v2-popup-title" data-i18n="todoV2PopupTitle">ToDo Ver.2を有効にしますか?</div>
            <div class="todo-v2-popup-message" data-i18n="todoV2PopupMessage">
                新しいToDo Ver.2では、段階的完了機能、期間設定、カレンダービューなどの高度な機能が利用できます。
            </div>
            <div class="todo-v2-popup-toggle">
                <span class="todo-v2-popup-toggle-label" data-i18n="todoV2ToggleLabel">ToDo Ver.2を有効にする</span>
                <div class="toggle-switch" id="todoV2Toggle" onclick="toggleTodoV2Popup()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="todo-v2-popup-buttons">
                <button class="secondary" onclick="closeTodoV2Popup()" data-i18n="todoV2Confirm">決定</button>
            </div>
        </div>
    </div>

    <!-- デイトピッカー用オーバーレイ -->
    <div class="date-picker-overlay" id="datePickerOverlay" onclick="closeAllDatePickers()"></div>
    <div class="date-picker-dropdown" id="commonDatePicker"></div>
    <div class="calendar-day-dialog-overlay" id="calendarDayDialog">
        <div class="calendar-day-dialog">
            <div class="calendar-day-dialog-header">
                <div class="calendar-day-dialog-title" id="calendarDayDialogTitle"></div>
                <button class="secondary calendar-day-dialog-close" onclick="closeCalendarDayDialog()"
                    data-i18n="closeButton">閉じる</button>
            </div>
            <div class="calendar-day-todos" id="calendarDayTodos">
                <!-- ToDoリストがここに表示される -->
            </div>
            <div class="calendar-day-add-form">
                <h4 style="margin: 0 0 15px 0; font-size: 1rem;" data-i18n="calendarAddTodoTitle">新しいToDoを追加</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="calendarAddTodoInput" placeholder="タスクを入力"
                        data-i18n="calendarAddTodoPlaceholder"
                        style="flex: 1; padding: 10px; border: none; border-radius: 24px; font-family: inherit;">
                    <button class="primary" onclick="addTodoFromCalendar()" data-i18n="addButton">追加</button>
                </div>
            </div>
        </div>
    </div>

    <div class="top-buttons">
        <!-- チュートリアル -->
        <div class="tutorial-overlay" id="tutorialOverlay"></div>
        <div class="tutorial-welcome" id="tutorialWelcome" style="display: none;">
            <h3>
                <img src="guide.webp" alt="ガイド" data-i18n-alt="guideAlt"
                    style="width:20px;height:20px;margin-right:6px;vertical-align:middle;">
                <span data-i18n="tutorialWelcome">使い方を説明しますか?</span>
            </h3>
            <p data-i18n="tutorialWelcomeMessage">初めての方向けに、このサイトの使い方を順番に説明します。</p>
            <div class="tutorial-welcome-buttons">
                <button class="secondary" onclick="closeTutorial()" data-i18n="closeButton">閉じる</button>
                <button class="primary" onclick="startTutorial()" data-i18n="tutorialYes">はい</button>
            </div>
        </div>
        <div class="tutorial-box" id="tutorialBox" style="display: none;">
            <div class="tutorial-step-info" id="tutorialStepInfo"></div>
            <h3 id="tutorialTitle" data-i18n="tutorialPlaceholderTitle">タイトル</h3>
            <p id="tutorialMessage" data-i18n="tutorialPlaceholderMessage">メッセージ</p>
            <div class="tutorial-buttons">
                <button class="secondary" onclick="skipTutorial()" data-i18n="skipButton">スキップ</button>
                <div style="display: flex; gap: 10px;">
                    <button class="secondary" id="tutorialPrevBtn" onclick="prevTutorialStep()"
                        data-i18n="tutorialPrev">戻る</button>
                    <button class="primary" id="tutorialNextBtn" onclick="nextTutorialStep()"
                        data-i18n="tutorialNext">次へ</button>
                </div>
            </div>
        </div>
        <div class="tutorial-arrow" id="tutorialArrow"></div>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="テーマ切り替え" data-i18n-aria="themeToggleAlt">
            <img id="themeIcon" src="moon.webp" alt="テーマ切り替え" data-i18n-alt="themeToggleAlt">
        </button>
        <button id="settingsBtn" class="settings-btn" onclick="showPage('settings')" aria-label="設定"
            data-i18n-aria="settingsAlt">
            <img id="settingsIcon" src="settings.webp" alt="設定" data-i18n-alt="settingsAlt">
        </button>
    </div>

    <div class="container">
        <h1 data-i18n="studyTimeManagement">勉強時間管理</h1>

        <div class="menu" id="mainMenu">
            <button class="active" onclick="showPage('timer')" data-page="timer" data-i18n="menuTimer">タイマー</button>
            <button onclick="showPage('stats')" data-page="stats" data-i18n="menuStats">統計</button>
            <button onclick="showPage('list')" data-page="list" data-i18n="menuList">リスト</button>
        </div>

        <div id="timerPage" class="page active">
            <div class="timer" id="timer" style="font-weight: 300;">00:00:00</div>
            <div class="timer-display-sub" id="totalTimerDisplay"
                style="font-size: 1.5rem; opacity: 0.6; margin-top: -30px; margin-bottom: 20px; display: none;">00:00:00
            </div>
            <div class="group-input">
                <input type="text" id="groupInput" placeholder="グループ名(任意)" data-i18n="groupPlaceholder">
            </div>
            <div class="session-info" id="sessionInfo" data-i18n="sessionStart">開始ボタンを押して学習を始めましょう</div>
            <div id="focusModeToggleContainer" style="display: none; margin-bottom: 15px;">
                <div class="toggle-item" style="margin-bottom: 0;">
                    <span data-i18n="focusMode">フォーカスモード</span>
                    <div class="toggle-switch" id="toggleFocusModeMain" onclick="toggleFocusModeMain()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button id="startBtn" class="primary" onclick="startStudy()" data-i18n="startButton">勉強開始</button>
                <button id="pauseBtn" class="secondary hidden" onclick="pauseStudy()"
                    data-i18n="pauseButton">一時停止</button>
                <button id="endBtn" class="secondary hidden" onclick="endStudy()" data-i18n="endButton">終了</button>
            </div>
        </div>

        <div id="statsPage" class="page">
            <div class="stats-container" id="statsContainer"></div>
            <div id="statsGraphContainer" style="display: none; margin-bottom: 30px;">
                <canvas id="statsChart" style="max-height: 300px;"></canvas>
            </div>
            <div class="group-selector" id="groupStatsSelector"></div>
            <div id="groupStats"></div>
        </div>

        <div id="listPage" class="page">
            <div class="group-selector">
                <div class="custom-select">
                    <select id="groupFilter" onchange="loadHistory()" aria-label="グループで絞り込む"
                        data-i18n-aria="filterByGroup">
                        <option value="" data-i18n="allGroupsFilter">すべてのグループ</option>
                    </select>
                    <div class="select-arrow">▾</div>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="日付や時刻で検索(例: 2025年12月11日や、14:30)"
                    data-i18n="searchPlaceholder" oninput="loadHistory()">
            </div>

            <div class="sort-controls"
                style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button class="secondary filter-control-btn active" onclick="sortHistory('date-desc')"
                    data-sort="date-desc" data-i18n="sortNewest">新しい順</button>
                <button class="secondary filter-control-btn" onclick="sortHistory('date-asc')" data-sort="date-asc"
                    data-i18n="sortOldest">古い順</button>
                <button class="secondary filter-control-btn" onclick="sortHistory('duration-desc')"
                    data-sort="duration-desc" data-i18n="sortLongest">時間が長い順</button>
                <button class="secondary filter-control-btn" onclick="sortHistory('duration-asc')"
                    data-sort="duration-asc" data-i18n="sortShortest">時間が短い順</button>
            </div>

            <div class="action-buttons">
                <button class="secondary" onclick="toggleSelectAll()" data-i18n="selectAll">すべて選択</button>
                <button class="secondary" id="deleteBtn" onclick="deleteSelected()" disabled
                    data-i18n="deleteSelected">選択を削除</button>
            </div>
            <div class="move-group-container" id="moveGroupContainer">
                <div class="move-count" id="moveCount"></div>
                <div class="custom-select" style="display:inline-block; margin-right:8px;">
                    <select id="moveGroupSelect" aria-label="移動先のグループを選択" data-i18n-aria="moveDestination">
                        <option value="" data-i18n="moveDestination">移動先を選択</option>
                    </select>
                    <div class="select-arrow">▾</div>
                </div>
                <div class="move-group-buttons">
                    <button class="secondary" onclick="hideMoveGroup()" data-i18n="cancelButton">キャンセル</button>
                    <button class="primary" onclick="moveSelectedToGroup()" data-i18n="moveButton">移動</button>
                </div>
            </div>
            <div id="studyGraphContainer" style="display: none; margin-bottom: 30px;">
                <h2 data-i18n="graphTitle">勉強時間グラフ</h2>
                <canvas id="studyChart" style="max-height: 300px;"></canvas>
            </div>
            <div id="historyList" class="history-list"></div>
            <button class="secondary clear-history" onclick="clearHistory()"
                data-i18n="clearHistory">すべての履歴をクリア</button>
        </div>

        <div id="musicPage" class="page">
            <div class="music-player">
                <div class="music-controls">
                    <div class="file-select-group">
                        <label class="file-select-label" id="musicFileLabel" tabindex="0" role="button"
                            aria-haspopup="true">
                            <img id="musicDropdownArrow" class="file-select-arrow" src="arrow_down.webp" alt="メニュー"
                                data-i18n-alt="menu">
                            <span class="file-select-text" data-i18n="selectFile">ファイルを選択</span>
                        </label>
                        <input type="file" id="musicFileInput" accept=".mp3,.wav,.flac,.m4a,.aac,.ogg,.webm,audio/*"
                            onchange="addMusicFile(event)" multiple style="display:none;">

                        <div class="file-dropdown-menu" id="musicDropdownMenu" role="menu" aria-hidden="true">
                            <div class="dropdown-item" id="chooseFolderItem" data-i18n="selectFolder">フォルダを選択</div>
                        </div>

                        <input type="file" id="musicFolderInput" webkitdirectory directory multiple
                            style="display:none;" onchange="addMusicFile(event)">
                    </div>
                </div>
                <audio id="audioPlayer" style="display:none;" playsinline webkit-playsinline></audio>
                <div class="custom-player" style="width:100%; margin-bottom:12px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div id="timeDisplay" style="min-width:110px; font-size:0.95rem;">0:00 / 0:00</div>
                        <div id="progressContainer"
                            style="flex:1; height:10px; background:#ddd; border-radius:24px; position:relative; cursor:pointer;">
                            <div id="progressBar"
                                style="position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--primary-color); border-radius:24px;">
                            </div>
                            <div id="progressHandle"
                                style="position:absolute; left:0; top:50%; transform:translate(-50%,-50%); width:12px; height:12px; border-radius:50%; background:#fff; box-shadow:0 0 2px rgba(0,0,0,0.2); display:none;">
                            </div>
                        </div>
                        <div style="width:36px; text-align:right;">
                            <button class="secondary" id="volumeBtn"
                                style="background:transparent;border:none;cursor:pointer;padding:4px;">
                                <img id="volumeBtnImg" src="volume.webp" alt="音量" style="width:20px;height:20px;"
                                    data-i18n-alt="volume">
                            </button>
                        </div>
                    </div>
                    <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1"
                        style="width:100%; margin-top:8px; display:none;">
                </div>
                <div class="player-controls">
                    <button class="secondary" onclick="playPrevious()" aria-label="前へ" data-i18n-aria="previous">
                        <img id="prevBtnImg" src="prev.webp" alt="前へ" style="width:24px;height:24px;"
                            data-i18n-alt="previous">
                    </button>
                    <button class="secondary" onclick="togglePlay()" aria-label="再生/一時停止" data-i18n-aria="playPause">
                        <img id="playIconImg" src="play.webp" alt="再生" style="width:24px;height:24px;"
                            data-i18n-alt="play">
                    </button>
                    <button class="secondary" onclick="playNext()" aria-label="次へ" data-i18n-aria="next">
                        <img id="nextBtnImg" src="next.webp" alt="次へ" style="width:24px;height:24px;"
                            data-i18n-alt="next">
                    </button>
                    <button class="secondary" onclick="toggleLoop()" id="loopBtn" aria-label="ループ"
                        data-i18n-aria="loop">
                        <img id="loopBtnImg" src="loop_off.webp" alt="ループオフ" style="width:24px;height:24px;"
                            data-i18n-alt="loopOff">
                    </button>
                    <button class="secondary" onclick="toggleShuffle()" id="shuffleBtn" aria-label="シャッフル"
                        data-i18n-aria="shuffle">
                        <img id="shuffleBtnImg" src="shuffle_off.webp" alt="シャッフルオフ" style="width:24px;height:24px;"
                            data-i18n-alt="shuffleOff">
                    </button>
                </div>
                <div class="playlist" id="playlist"></div>
            </div>
        </div>
        <div id="todoPage" class="page">
            <!-- ビュー切り替えメニュー -->
            <div class="todo-view-menu">
                <button class="todo-view-btn active" onclick="switchTodoView('list')" id="todoViewList"
                    data-i18n="todoViewList">ToDoリスト</button>
                <button class="todo-view-btn" onclick="switchTodoView('calendar')" id="todoViewCalendar"
                    data-i18n="todoViewCalendar">カレンダー</button>
            </div>

            <!-- ToDoリストビュー -->
            <div id="todoListView" class="todo-list">
                <div class="todo-input">
                    <input type="text" id="todoInput" placeholder="新しいタスクを入力" data-i18n="todoPlaceholder">
                    <button type="button" class="primary" onclick="addTodo()" data-i18n="todoAddButton">追加</button>
                </div>

                <div class="todo-options" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 140px;">
                            <label style="font-size: 0.85rem; opacity: 0.8; display: block; margin-bottom: 6px;"
                                data-i18n="repeat">繰り返し</label>
                            <div class="custom-select" style="width: 100%;">
                                <select id="todoRepeat" style="width: 100%;">
                                    <option value="none" data-i18n="repeatNone">なし</option>
                                    <option value="daily" data-i18n="repeatDaily">毎日</option>
                                    <option value="weekly" data-i18n="repeatWeekly">毎週</option>
                                    <option value="monthly" data-i18n="repeatMonthly">毎月</option>
                                </select>
                                <div class="select-arrow">▾</div>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 140px;">
                            <label style="font-size: 0.85rem; opacity: 0.8; display: block; margin-bottom: 6px;"
                                data-i18n="priority">優先度</label>
                            <div class="custom-select" style="width: 100%;">
                                <select id="todoPriority" style="width: 100%;">
                                    <option value="low" data-i18n="priorityLow">低</option>
                                    <option value="normal" selected data-i18n="priorityNormal">通常</option>
                                    <option value="high" data-i18n="priorityHigh">高</option>
                                </select>
                                <div class="select-arrow">▾</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ver.2: 期間設定 -->
                    <div id="todoPeriodSettings"
                        style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 140px;">
                            <label style="font-size: 0.85rem; opacity: 0.8; display: block; margin-bottom: 6px;"
                                data-i18n="startOptional">開始日(任意)</label>
                            <div class="custom-date-picker">
                                <input type="text" id="todoPeriodStart" class="custom-date-input" placeholder="日付を選択"
                                    data-i18n="selectStartDate" readonly onclick="openDatePicker('start')">
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 140px;">
                            <label style="font-size: 0.85rem; opacity: 0.8; display: block; margin-bottom: 6px;"
                                data-i18n="endOptional">終了日(任意)</label>
                            <div class="custom-date-picker">
                                <input type="text" id="todoPeriodEnd" class="custom-date-input" placeholder="日付を選択"
                                    data-i18n="selectEndDate" readonly onclick="openDatePicker('end')">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="todo-filter" style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="secondary todo-filter-btn filter-control-btn active" onclick="filterTodos('all')"
                        data-filter="all" data-i18n="filterAll">すべて</button>
                    <button class="secondary todo-filter-btn filter-control-btn" onclick="filterTodos('active')"
                        data-filter="active" data-i18n="filterActive">未完了</button>
                    <button class="secondary todo-filter-btn filter-control-btn" onclick="filterTodos('completed')"
                        data-filter="completed" data-i18n="filterCompleted">完了</button>
                    <button class="secondary todo-filter-btn filter-control-btn" onclick="filterTodos('daily')"
                        data-filter="daily" data-i18n="filterDaily">毎日</button>
                    <button class="secondary todo-filter-btn filter-control-btn" onclick="filterTodos('weekly')"
                        data-filter="weekly" data-i18n="filterWeekly">毎週</button>
                </div>

                <div class="todo-items" id="todoItems"></div>
            </div>

            <!-- カレンダービュー -->
            <div id="todoCalendarView" class="calendar-view" style="display: none;">
                <div class="calendar-header">
                    <button class="secondary" onclick="changeCalendarMonth(-1)" data-i18n="prevMonth">◀ 前月</button>
                    <div class="calendar-month-year" id="calendarMonthYear"></div>
                    <button class="secondary" onclick="changeCalendarMonth(1)" data-i18n="nextMonth">次月 ▶</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>
        <div id="settingsPage" class="page">
            <div class="settings-section">
                <h2 data-i18n="settingsDisplay">表示設定</h2>
                <div class="toggle-item">
                    <span data-i18n="musicPlayer">音楽プレイヤー</span>
                    <div class="toggle-switch" id="toggleMusic" onclick="toggleFeature('music')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="toggle-item">
                    <span data-i18n="todoList">ToDoリスト</span>
                    <div class="toggle-switch" id="toggleTodo" onclick="toggleFeature('todo')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="toggle-item">
                    <span>ToDo Ver.2</span>
                    <div class="toggle-switch" id="toggleTodoV2" onclick="toggleTodoV2Setting()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="toggle-item">
                    <span data-i18n="titleTimeDisplay">タイトルの時間表示</span>
                    <div class="toggle-switch" id="toggleTitleTime" onclick="toggleTitleTime()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="toggle-item">
                    <span data-i18n="lockSettingsDuringTimer">タイマー作動中は設定を無効化</span>
                    <div class="toggle-switch" id="toggleLockSettings" onclick="toggleLockSettingsDuringTimer()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="toggle-item">
                    <span data-i18n="loadingAnimSetting">ローディングアニメーション表示</span>
                    <div class="toggle-switch" id="toggleLoadingAnim" onclick="toggleLoadingAnim()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="languageSettings">言語設定</h2>
                <div class="toggle-item">
                    <div class="language-options" style="display: flex; gap: 10px; width: 100%;">
                        <button class="secondary language-option active" data-lang="ja" onclick="changeLanguage('ja')"
                            style="flex: 1; padding: 12px;">
                            <span data-i18n="japanese">日本語</span>
                        </button>
                        <button class="secondary language-option" data-lang="en" onclick="changeLanguage('en')"
                            style="flex: 1; padding: 12px;">
                            <span data-i18n="english">English</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="fontSettings">フォント設定</h2>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                        data-i18n="fontJapanese">日本語フォント</label>
                    <div class="custom-select" style="width: 100%;">
                        <select id="fontJaSelect" onchange="saveFontSettings()">
                            <option value="Zen Kaku Gothic Antique">Zen Kaku Gothic Antique</option>
                            <option value="Klee One">Klee One</option>
                            <option value="BIZ UDPGothic">BIZ UDPGothic</option>
                            <option value="Zen Maru Gothic">Zen Maru Gothic</option>
                            <option value="Noto Sans JP">Noto Sans JP</option>
                            <option value="Sawarabi Gothic">Sawarabi Gothic</option>
                            <option value="Hina Mincho">Hina Mincho</option>
                            <option value="Mushin" data-i18n="fontMushin">無心</option>
                            <option value="Utsukushi Font" data-i18n="fontUtsukushi">うつくし明朝体</option>
                            <option value="Misaki Gothic" data-i18n="fontMisaki">美咲ゴシック</option>
                            <option value="Kodenmachou" data-i18n="fontKodenmachou">小伝馬町</option>
                        </select>
                        <div class="select-arrow">▾</div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                        data-i18n="fontEnglish">英語フォント</label>
                    <div class="custom-select" style="width: 100%;">
                        <select id="fontEnSelect" onchange="saveFontSettings()">
                            <option value="" data-i18n="fontNone">未設定</option>
                            <option value="Zen Kaku Gothic Antique">Zen Kaku Gothic Antique</option>
                            <option value="Jost">Jost</option>
                            <option value="JetBrains Mono">JetBrains Mono</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Lora">Lora</option>
                            <option value="Quicksand">Quicksand</option>
                        </select>
                        <div class="select-arrow">▾</div>
                    </div>
                </div>
            </div>

            <div class="theme-selector">
                <h2 data-i18n="themeColor">テーマカラー</h2>
                <div class="theme-options">
                    <div class="theme-option selected" data-theme="blue" onclick="changeTheme('blue')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #9db4c8;"></div>
                            <div style="background-color: #8ba4b8;"></div>
                            <div style="background-color: #7a95ab;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themeBlue">ブルー</div>
                    </div>
                    <div class="theme-option" data-theme="green" onclick="changeTheme('green')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #a8c9a8;"></div>
                            <div style="background-color: #96b996;"></div>
                            <div style="background-color: #88ab88;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themeGreen">グリーン</div>
                    </div>
                    <div class="theme-option" data-theme="purple" onclick="changeTheme('purple')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #b8a8c9;"></div>
                            <div style="background-color: #a896b9;"></div>
                            <div style="background-color: #9a88ab;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themePurple">パープル</div>
                    </div>
                    <div class="theme-option" data-theme="orange" onclick="changeTheme('orange')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #d9b4a0;"></div>
                            <div style="background-color: #c9a490;"></div>
                            <div style="background-color: #b99480;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themeOrange">オレンジ</div>
                    </div>
                    <div class="theme-option" data-theme="pink" onclick="changeTheme('pink')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #d9a8b4;"></div>
                            <div style="background-color: #c996a4;"></div>
                            <div style="background-color: #b98896;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themePink">ピンク</div>
                    </div>
                    <div class="theme-option" data-theme="teal" onclick="changeTheme('teal')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #a0c9c9;"></div>
                            <div style="background-color: #90b9b9;"></div>
                            <div style="background-color: #80abab;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themeTeal">ティール</div>
                    </div>
                    <div class="theme-option" data-theme="white" onclick="changeTheme('white')">
                        <div class="theme-option-preview" style="background-color: var(--panel-light);">
                            <div style="background-color: #ededed;"></div>
                            <div style="background-color: #dadada;"></div>
                            <div style="background-color: #101010;"></div>
                        </div>
                        <div class="theme-option-name" data-i18n="themeWhite">ホワイト/ブラック</div>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h2 data-i18n="focusModeSettings">フォーカスモード設定</h2>
                <div class="toggle-item">
                    <span data-i18n="showFocusModeToggle">フォーカスモード切替を表示</span>
                    <div class="toggle-switch active" id="toggleFocusDisplay" onclick="toggleFocusDisplaySetting()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <!-- <div class="toggle-item" style="margin-top: 12px;"> -->
                    <!-- <span style="font-size: 0.9rem; opacity: 0.7;">開発者モード</span> -->
                    <!-- <div class="toggle-switch" id="toggleDevMode" onclick="toggleDevMode()"> -->
                        <!-- <div class="toggle-slider"></div> -->
                    <!-- </div> -->
                <!-- </div> -->
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                            data-i18n="focusDuration">集中時間</label>
                        <div class="custom-select" style="width: 100%;">
                            <select id="focusDurationSelect" onchange="saveFocusSettings()">
                                <option value="20">20分</option>
                                <option value="25" selected>25分</option>
                                <option value="30">30分</option>
                            </select>
                            <div class="select-arrow">▾</div>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                            data-i18n="breakDuration">休憩時間</label>
                        <div class="custom-select" style="width: 100%;">
                            <select id="breakDurationSelect" onchange="saveFocusSettings()">
                                <option value="1">1分</option>
                                <option value="5" selected>5分</option>
                                <option value="10">10分</option>
                            </select>
                            <div class="select-arrow">▾</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="graphDisplay">グラフ表示</h2>
                <div class="toggle-item">
                    <span data-i18n="studyGraph">勉強時間のグラフ表示</span>
                    <div class="toggle-switch" id="toggleGraph" onclick="toggleGraph()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div id="graphSettings" style="display: none; margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                            data-i18n="graphType">グラフの種類</label>
                        <div class="custom-select" style="width: 100%;">
                            <select id="graphType" onchange="saveGraphSettings()">
                                <option value="bar" data-i18n="graphBar">棒グラフ</option>
                                <option value="line" data-i18n="graphLine">折れ線グラフ</option>
                                <option value="area" data-i18n="graphArea">面グラフ</option>
                            </select>
                            <div class="select-arrow">▾</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                            data-i18n="displayPeriod">表示期間</label>
                        <div class="custom-select" style="width: 100%;">
                            <select id="graphPeriod" onchange="saveGraphSettings()">
                                <option value="7" data-i18n="period7days">過去7日間</option>
                                <option value="14" data-i18n="period14days">過去14日間</option>
                                <option value="30" selected data-i18n="period30days">過去30日間</option>
                                <option value="90" data-i18n="period90days">過去90日間</option>
                                <option value="365" data-i18n="period1year">過去1年間</option>
                                <option value="all" data-i18n="periodAll">すべての期間</option>
                            </select>
                            <div class="select-arrow">▾</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 8px;"
                            data-i18n="displayLocation">表示場所</label>
                        <div class="custom-select" style="width: 100%;">
                            <select id="graphLocation" onchange="saveGraphSettings()">
                                <option value="list" data-i18n="locationList">リスト画面</option>
                                <option value="stats" data-i18n="locationStats">統計画面</option>
                                <option value="both" data-i18n="locationBoth">両方</option>
                            </select>
                            <div class="select-arrow">▾</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h2 data-i18n="dataManagement">データ管理</h2>
                <div class="data-management">
                    <button class="secondary" onclick="exportData()">
                        <img src="export.webp" alt="エクスポート" data-i18n-alt="exportData"
                            style="width:16px;height:16px;margin-right:6px;vertical-align:middle;">
                        <span data-i18n="exportData">データをエクスポート</span>
                    </button>
                    <button class="secondary" onclick="document.getElementById('importFile').click()">
                        <img src="import.webp" alt="インポート" data-i18n-alt="importData"
                            style="width:16px;height:16px;margin-right:6px;vertical-align:middle;">
                        <span data-i18n="importData">データをインポート</span>
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display:none;"
                        onchange="importData(event)">
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="helpSection">ヘルプ</h2>
                <button class="secondary" onclick="restartTutorial()" style="width: 100%; padding: 12px 20px;">
                    <img src="guide.webp" alt="ガイド" data-i18n-alt="guideAlt"
                        style="width:16px;height:16px;margin-right:6px;vertical-align:middle;">
                    <span data-i18n="showGuide">使い方ガイドを再表示</span>
                </button>
            </div>

            <div class="copyright" data-i18n="copyright">© 高級ジェネ™ All rights reserved.</div>

            <div class="about-link">
                <button class="about-button" onclick="showAboutModal()" aria-label="このサイトについて"
                    data-i18n-aria="aboutButton">
                    <span class="about-icon" aria-hidden="true">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                            focusable="false">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6"></circle>
                            <line x1="12" y1="11" x2="12" y2="16" stroke="currentColor" stroke-width="1.6"
                                stroke-linecap="round"></line>
                            <circle cx="12" cy="7" r="0.8" fill="currentColor"></circle>
                        </svg>
                    </span>
                    <span class="about-text" data-i18n="aboutButton">このサイトについて</span>
                </button>
            </div>

            <div class="about-link" style="margin-top: 8px;">
                <button class="about-button" onclick="showQAModal()" aria-label="よくある質問" data-i18n-aria="qaButton">
                    <span class="about-icon" aria-hidden="true">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                            focusable="false">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" stroke-width="1.6"
                                stroke-linecap="round"></path>
                            <circle cx="12" cy="17" r="0.8" fill="currentColor"></circle>
                        </svg>
                    </span>
                    <span class="about-text" data-i18n="qaButton">よくある質問(Q&A)</span>
                </button>
            </div>

            <div class="about-link" style="margin-top: 8px;">
                <button class="about-button" onclick="showLicenseModal()" aria-label="ライセンス"
                    data-i18n-aria="licenseButton">
                    <span class="about-icon" aria-hidden="true">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor"
                                stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M16 13H8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M16 17H8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M10 9H8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </span>
                    <span class="about-text" data-i18n="licenseButton">ライセンス</span>
                </button>
            </div>

            <div class="about-overlay" id="aboutOverlay" aria-hidden="true">
                <div class="about-dialog" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
                    <h2 id="aboutTitle" data-i18n="aboutTitle">このサイトについて</h2>
                    <div class="about-content" id="aboutContent" data-i18n-html="aboutContent">
                        <!-- Content will be replaced by JS -->
                    </div>
                    <div class="about-actions">
                        <button class="secondary" id="aboutCloseBtn" data-i18n="closeButton">閉じる</button>
                        <button class="primary" id="aboutOkBtn" data-i18n="okButton">了解</button>
                    </div>
                </div>
            </div>

            <div class="about-overlay" id="qaOverlay" aria-hidden="true">
                <div class="about-dialog" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
                    <h2 id="qaTitle" data-i18n="qaTitle">よくある質問(Q&A)</h2>
                    <div id="qaContent" class="about-content" data-i18n-html="qaContent">
                        <!-- Content will be replaced by JS -->
                    </div>
                    <div class="about-actions">
                        <button class="secondary" id="qaCloseBtn" data-i18n="closeButton">閉じる</button>
                        <button class="primary" id="qaOkBtn" data-i18n="okButton">了解</button>
                    </div>
                </div>
            </div>

            <div class="about-overlay" id="licenseOverlay" aria-hidden="true">
                <div class="about-dialog" role="dialog" aria-modal="true" aria-labelledby="licenseTitle">
                    <h2 id="licenseTitle" data-i18n="licenseTitle">フォントライセンス</h2>
                    <div id="licenseContent" class="about-content"
                        style="font-size: 0.85rem; max-height: 60vh; overflow-y: auto; text-align: left;">
                        <b>[Google Fonts]</b><br>
                        <b>Jost</b><br>
                        by Indestructible Type (SIL OFL 1.1)<br>
                        <br>
                        <b>Zen Kaku Gothic Antique</b><br>
                        by Astrolab Inc. (SIL OFL 1.1)<br>
                        <br>
                        <b>JetBrains Mono</b><br>
                        by JetBrains s.r.o. (SIL OFL 1.1)<br>
                        <br>
                        <b>Montserrat</b><br>
                        by Julieta Ulanovsky (SIL OFL 1.1)<br>
                        <br>
                        <b>Lora</b><br>
                        by Cyreal (SIL OFL 1.1)<br>
                        <br>
                        <b>Quicksand</b><br>
                        by Andrew Paglinawan (SIL OFL 1.1)<br>
                        <br>
                        <b>Klee One</b><br>
                        by Fontworks Inc. (SIL OFL 1.1)<br>
                        <br>
                        <b>BIZ UDPGothic</b><br>
                        by Morisawa Inc. (SIL OFL 1.1)<br>
                        <br>
                        <b>Zen Maru Gothic</b><br>
                        by Yoshimichi Ohira (SIL OFL 1.1)<br>
                        <br>
                        <b>Noto Sans JP</b><br>
                        by Google (SIL OFL 1.1)<br>
                        <br>
                        <b>Sawarabi Gothic</b><br>
                        by mplus-fonts-dev (SIL OFL 1.1 / CC BY 4.0)<br>
                        <br>
                        <b>Hina Mincho</b><br>
                        by Shujiro Sano (SIL OFL 1.1)<br>
                        <br>
                        <hr style="opacity: 0.2; margin: 15px 0;">
                        <br>
                        <b>[Local Fonts]</b><br>
                        <b>うつくし明朝体 (Utsukushi Font)</b><br>
                        by FLOP DESIGN (IPA Font License v1.0)<br>
                        <br>
                        <b>美咲ゴシック (Misaki Gothic)</b><br>
                        by 門真 なむ / Little Limit (Free License)<br>
                        <br>
                        <b>小伝馬町 (Kodenmachou)</b><br>
                        by 自家製フォント工房 (SIL OFL 1.1)<br>
                        <br>
                        <b>無心 (Mushin)</b><br>
                        by Maniackers Design (SIL OFL 1.1)
                    </div>
                    <div class="about-actions">
                        <button class="primary" id="licenseOkBtn" data-i18n="closeButton">閉じる</button>
                    </div>
                </div>
            </div>

            <script>
                let startTime = null;
                let pausedTime = 0;
                let timerInterval = null;
                let isPaused = false;
                let selectedItems = new Set();
                let allHistoryItems = [];
                let currentMusicIndex = -1;
                let musicFiles = [];
                let isLoop = false;
                let isShuffle = false;
                let _musicDB = null;

                // 多言語対応システム
                let currentLanguage = 'ja'; // デフォルトは日本語

                const translations = {
                    ja: {
                        // メタ
                        title: '勉強時間管理',
                        description: '勉強とともにタイマーをスタートし、作業時間を記録しましょう。',


                        // フォント設定
                        fontSettings: 'フォント設定',
                        fontJapanese: '日本語･その他用フォント',
                        fontEnglish: '英数字用フォント(アルファベット･数字)',
                        fontNone: '未設定',
                        fontMushin: '無心',
                        fontUtsukushi: 'うつくし明朝体',
                        fontMisaki: '美咲ゴシック',
                        fontKodenmachou: '小伝馬町',
                        licenseButton: 'ライセンス',
                        licenseTitle: 'フォントライセンス',

                        // 追加: 削除確認メッセージ等
                        deleteTaskConfirm: 'このタスクを削除しますか?',
                        deleteMusicConfirm: 'この音楽ファイルを削除しますか?',
                        backButton: '戻る',
                        finishButton: '完了',
                        nextButton: '次へ',

                        // メインメニュー
                        menuTimer: 'タイマー',
                        menuStats: '統計',
                        menuList: 'リスト',
                        menuMusic: '音楽',
                        menuTodo: 'ToDo',

                        // タイマーページ
                        groupPlaceholder: 'グループ名(任意)',
                        sessionStart: '開始ボタンを押して学習を始めましょう',
                        startButton: '勉強開始',
                        pauseButton: '一時停止',
                        resumeButton: '再開',
                        endButton: '終了',
                        startTime: '開始時刻',
                        endTime: '終了時刻',
                        studyTime: '学習時間',
                        previousSession: '前回の学習',
                        group: 'グループ',

                        // 統計ページ
                        totalTime: '総勉強時間',
                        todayTime: '今日の勉強時間',
                        weekTime: '今週の勉強時間',
                        monthTime: '今月の勉強時間',
                        averageTime: '平均勉強時間/日',
                        selectGroup: 'グループを選択',
                        filterByGroup: 'グループで絞り込む',
                        allGroups: 'すべてのグループ',

                        // リストページ
                        allGroupsFilter: 'すべてのグループ',
                        searchPlaceholder: '日付や時刻で検索(例: 2025年12月11日や、14:30)',
                        sortNewest: '新しい順',
                        sortOldest: '古い順',
                        sortLongest: '時間が長い順',
                        sortShortest: '時間が短い順',
                        selectAll: 'すべて選択',
                        deleteSelected: '選択を削除',
                        moveGroup: 'グループ移動',
                        moveCount: '件選択中',
                        moveDestination: '移動先を選択',
                        moveButton: '移動',
                        cancelButton: 'キャンセル',
                        graphTitle: '勉強時間グラフ',
                        clearHistoryConfirm: 'すべての学習記録を削除しますか?',
                        clearAllConfirmTitle: '全削除確認',
                        deleteSelectedConfirm: '選択した{n}件の記録を削除しますか?',
                        deleteConfirmTitle: '削除確認',
                        clearHistory: 'すべての履歴をクリア',
                        noHistory: 'まだ履歴がありません',
                        hours: '時間',

                        // 音楽プレイヤー
                        selectFile: 'ファイルを選択',
                        selectFolder: 'フォルダを選択',
                        previous: '前へ',
                        play: '再生',
                        pause: '一時停止',
                        next: '次へ',
                        loop: 'ループ',
                        loopOn: 'ループオン',
                        loopOff: 'ループオフ',
                        shuffle: 'シャッフル',
                        shuffleOn: 'シャッフルオン',
                        shuffleOff: 'シャッフルオフ',
                        volume: '音量',
                        playlist: 'プレイリスト',
                        deleteButton: '削除',
                        renameButton: '名前変更',
                        renameSong: '曲名を変更',
                        songNamePlaceholder: '曲名を入力',
                        saveButton: '保存',

                        // ToDoリスト
                        todoPlaceholder: '新しいタスクを入力',
                        todoAddButton: '追加',
                        addButton: '追加',
                        // 追加翻訳: ToDo Ver2 / カレンダー関連
                        todoV2PopupTitle: 'ToDo Ver.2を有効にしますか?',
                        todoV2PopupMessage: '新しいToDo Ver.2では、段階的完了機能、期間設定、カレンダービューなどの高度な機能が利用できます。',
                        todoV2ToggleLabel: 'ToDo Ver.2を有効にする',
                        todoV2Confirm: '決定',
                        calendarAddTodoTitle: '新しいToDoを追加',
                        calendarAddTodoPlaceholder: 'タスクを入力',
                        todoViewList: 'ToDoリスト',
                        todoViewCalendar: 'カレンダー',
                        prevMonth: '◀ 前月',
                        nextMonth: '次月 ▶',
                        confirmMessage: 'この操作を実行しますか?',
                        confirmIconAlt: '確認',
                        okButton: 'OK',
                        // 追加訳: UIの汎用ラベル
                        menu: 'メニュー',
                        startOptional: '開始日(任意)',
                        endOptional: '終了日(任意)',
                        tutorialPlaceholderTitle: 'タイトル',
                        tutorialPlaceholderMessage: 'メッセージ',
                        playPause: '再生/一時停止',
                        guideAlt: 'ガイド',
                        themeToggleAlt: 'テーマ切替',
                        settingsAlt: '設定',
                        repeat: '繰り返し',
                        repeatNone: 'なし',
                        repeatDaily: '毎日',
                        repeatWeekly: '毎週',
                        repeatMonthly: '毎月',
                        priority: '優先度',
                        priorityLow: '低',
                        priorityNormal: '通常',
                        priorityHigh: '高',
                        filterAll: 'すべて',
                        filterActive: '未完了',
                        filterCompleted: '完了',
                        filterDaily: '毎日',
                        filterWeekly: '毎週',

                        // 設定ページ
                        settingsDisplay: '表示設定',
                        musicPlayer: '音楽プレイヤー',
                        todoList: 'ToDoリスト',
                        titleTimeDisplay: 'タイトルの時間表示',
                        themeColor: 'テーマカラー',
                        themeBlue: 'ブルー',
                        themeGreen: 'グリーン',
                        themePurple: 'パープル',
                        themeOrange: 'オレンジ',
                        themePink: 'ピンク',
                        themeTeal: 'ティール',
                        themeWhite: 'ホワイト/ブラック',
                        lockSettingsDuringTimer: 'タイマー作動中は設定を無効化',
                        loadingAnimSetting: 'ローディングアニメーション表示',
                        graphDisplay: 'グラフ表示',
                        studyGraph: '勉強時間のグラフ表示',
                        graphType: 'グラフの種類',
                        graphBar: '棒グラフ',
                        graphLine: '折れ線グラフ',
                        graphArea: '面グラフ',
                        displayPeriod: '表示期間',
                        period7days: '過去7日間',
                        period14days: '過去14日間',
                        period30days: '過去30日間',
                        period90days: '過去90日間',
                        period1year: '過去1年間',
                        periodAll: 'すべての期間',
                        displayLocation: '表示場所',
                        locationList: 'リスト画面',
                        locationStats: '統計画面',
                        locationBoth: '両方',
                        dataManagement: 'データ管理',
                        exportData: 'データをエクスポート',
                        importData: 'データをインポート',
                        helpSection: 'ヘルプ',
                        showGuide: '使い方ガイドを再表示',
                        copyright: '© 高級ジェネ™ All rights reserved.',
                        languageSettings: '言語設定',
                        japanese: '日本語',
                        english: 'English',

                        // About
                        aboutButton: 'このサイトについて',
                        qaButton: 'よくある質問(Q&A)',
                        aboutTitle: 'このサイトについて',
                        qaTitle: 'よくある質問(Q&A)',
                        closeButton: '閉じる',
                        okButton: '了解',

                        // 確認ダイアログ
                        confirm: '確認',
                        confirmDelete: '削除してもよろしいですか?',
                        confirmClear: 'すべての履歴を削除してもよろしいですか?',

                        // チュートリアル
                        tutorialWelcome: '使い方を説明しますか?',
                        tutorialWelcomeMessage: '初めての方向けに、このサイトの使い方を順番に説明します。',
                        tutorialClose: '閉じる',
                        tutorialYes: 'はい',
                        tutorialSkip: 'スキップ',
                        tutorialPrev: '戻る',
                        tutorialNext: '次へ',
                        tutorialFinish: '終了',
                        tutorialStep: 'ステップ',
                        tutorialComplete: 'チュートリアル完了!',
                        tutorialCompleteMessage: 'お疲れ様でした!これで基本的な使い方の説明は終了です。また分からなくなったら、設定画面の「使い方ガイドを再表示」からいつでも確認できます。',
                        // アクセシビリティ用ラベル
                        dragHandle: '並べ替えハンドル',

                        // チュートリアル
                        tutorialStartTitle: 'ストップウォッチの開始',
                        tutorialStartMessage: 'この「勉強開始」ボタンをクリックすると、タイマーがスタートします。',
                        tutorialTimerStartedTitle: 'タイマーがスタートしました',
                        tutorialTimerStartedMessage: '今はチュートリアルですが、実際の勉強では、このまま集中して作業を続けましょう。',
                        tutorialPauseTitle: '一時停止',
                        tutorialPauseMessage: '休憩したい時は、この「一時停止」ボタンをクリックして時間を止めることができます。試してみましょう。',
                        tutorialPausedTitle: '一時停止中',
                        tutorialPausedMessage: 'タイマーが一時停止しました。もう一度ボタンを押すと再開できます。',
                        tutorialEndTitle: '記録の終了',
                        tutorialEndMessage: '勉強が完全に終わったら「終了」ボタンを押します。これで学習時間が自動的に記録されます。クリックしてみましょう。',
                        tutorialGroupTitle: 'グループ分け',
                        tutorialGroupMessage: 'グループ名を入力すると、後で科目別や分野別に記録を分類できます。例:「数学」や、「英語」など',
                        tutorialStatsTitle: '統計の確認',
                        tutorialStatsMessage: 'ここをクリックして統計画面に移動してみましょう。累計の勉強時間、連続日数、グループ別の集計などが確認できます。',
                        tutorialHistoryTitle: '履歴の確認',
                        tutorialHistoryMessage: 'ここをクリックしてリスト画面に移動してみましょう。過去の学習記録を一覧で見ることができます。検索、ソート、グループ移動などの機能があります。',
                        tutorialDarkModeTitle: 'ダークモード',
                        tutorialDarkModeMessage: 'このボタンをクリックするとライト/ダークモードを切り替えられます。目に優しい表示で集中できます。試しに切り替えてみましょう。',
                        tutorialSettingsTitle: '設定画面',
                        tutorialSettingsMessage: 'ここから設定画面を開けます。テーマカラーの変更、音楽プレイヤーやToDoリストの表示切替、データのバックアップなどができます。クリックして確認してみましょう!',
                        tutorialDisplaySettingsTitle: '表示設定',
                        tutorialDisplaySettingsMessage: 'ここで音楽プレイヤーやToDoリストの表示/非表示を切り替えられます。必要な機能だけを表示してシンプルに使えます。',
                        tutorialThemeColorTitle: 'テーマカラー',
                        tutorialThemeColorMessage: 'お好みのテーマカラーを選択できます。ブルー、グリーン、パープル、オレンジ、ピンク、ティールの6色から選べます。',
                        tutorialGraphDisplayTitle: 'グラフ表示',
                        tutorialGraphDisplayMessage: '勉強時間のグラフの種類や表示期間、表示場所をカスタマイズできます。',
                        tutorialDataManagementTitle: 'データ管理',
                        tutorialDataManagementMessage: 'データのエクスポート/インポート機能です。バックアップを取ったり、他のデバイスにデータを移行できます。',
                        tutorialCompletedTitle: 'チュートリアル完了!',
                        tutorialCompletedMessage: 'お疲れ様でした!これで基本的な使い方の説明は終了です。また分からなくなったら、設定画面の「使い方ガイドを再表示」からいつでも確認できます。',
                        skipButton: 'スキップ',
                        step: 'ステップ',

                        // 汎用
                        confirmDefaultTitle: '確認',
                        studyTimeManagement: '勉強時間管理',
                        cancelButton: 'キャンセル',

                        // About & QA
                        aboutContent: `<div style="text-align: center; margin-bottom: 20px;">
                        <div><img src="guide.webp" style="width: 3rem; height: 3rem;"></div>
                        <h3 style="margin-top: 0;">Study Time Manager</h3>
                        <p>シンプルで使いやすい勉強時間管理ツール。</p>
                        このサイトは<a href="https://kokyujene.super-hiko14.com/members/super-hiko14/">Super Hiko14</a>が開発しました。<div class="tyuui-mini-text">※ 一部AIが使用されています。</div>
                        </div>`,
                        qaContent: `<div style="text-align: left;">
                            <p style="margin-left: 15px;">A. すべてのデータはブラウザのローカルストレージに保存されます。サーバーには一切送信されません。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. 他のデバイスでデータへ移行やバックアップを取りたい。</h3>
                            <p style="margin-left: 15px;">A. エクスポートからJsonファイルをダウンロードできます。インポートで他デバイスに移行やバックアップとして保存できます。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. 音楽プレイヤーで再生できるファイル形式は?</h3>
                            <p style="margin-left: 15px;">A. mp3, wav, flac, m4a, aac, ogg, webmなどの一般的な音楽ファイルに対応しています。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. タイマーを一時停止したまま閉じてしまった場合は?</h3>
                            <p style="margin-left: 15px;">A. 大丈夫です。再度サイトを閉じてもタイマーは作動し続けます。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. 音楽プレイヤーにYoutube動画とかを追加する予定ってないの?</h3>
                            <p style="margin-left: 15px;">A. する予定はないです。各サービスの利用規約に違反する可能性があるからです。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. 今後も機能を追加する予定は?</h3>
                            <p style="margin-left: 15px;">A. 決まってはいません。ただし、最低限に使用したい方もいらっしゃると思うので追加する場合はその機能を設定のON/OFFなどで表示を切り替えられるようにする予定です。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. 収益化などの広告導入のつもりはある?</h3>
                            <p style="margin-left: 15px;">A. な い で す ( 断 言 )</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. アプリとかリリースする?</h3>
                            <p style="margin-left: 15px;">A. 逆にリリースしたいです...。技術的にまだ足りないので無理ですね。</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. にゃにゃにゃにゃぁ?(Q&A増える?)</h3>
                            <p style="margin-left: 15px;">A. にゃにゃにゃにゃぁ。(Q&Aは今後多分増えます。)</p>
                            <h3 style="font-size: 0.9rem; margin-top: 20px; margin-bottom: 10px;">こんなもんですかね...</h3>
                        </div>`,

                        // 日付形式
                        year: '年',
                        month: '月',
                        day: '日',

                        notSet: '未設定',
                        periodLabel: '期間',
                        rangeSeparator: '〜',
                        selectStartDate: '開始日を選択',
                        selectEndDate: '終了日を選択',
                        weekday_sun: '日',
                        weekday_mon: '月',
                        weekday_tue: '火',
                        weekday_wed: '水',
                        weekday_thu: '木',
                        weekday_fri: '金',
                        weekday_sat: '土',
                        noTodosOnThisDay: 'この日にToDoはありません',

                        // 統計ページ - 追加
                        totalStudyTime: '総勉強時間',
                        consecutiveDays: '連続日数',
                        totalSessions: '総セッション数',
                        groupStats: 'グループ統計',
                        uncategorized: '未分類',
                        days: '日',
                        sessions: 'セッション',

                        // リストページ - 追加
                        start: '開始',
                        end: '終了',
                        itemsToMove: '件を移動',
                        selectDestinationGroup: '移動先を選択',

                        // 音楽プレイヤー - 追加
                        addFilesMessage: 'ファイルを追加してください',
                        emptyPlaylist: 'ファイルを追加してください',

                        // ToDoリスト - 追加
                        noTasks: 'タスクがありません',
                        newTask: '新しいタスクを入力',

                        sinchokudo: '進捗度',

                        // チュートリアルステップ
                        tutorialStep1Title: 'メインメニュー',
                        tutorialStep1Desc: 'ここから各機能にアクセスできます。タイマー、統計、履歴リストなどを切り替えられます。',
                        tutorialStep2Title: 'タイマー',
                        tutorialStep2Desc: 'このタイマーで勉強時間を計測します。開始ボタンを押すと計測が始まります。',
                        tutorialStep3Title: '勉強開始',
                        tutorialStep3Desc: 'このボタンを押すと勉強時間の計測が開始されます。',
                        tutorialStep4Title: 'グループ名',

                        // Focus Mode
                        focusMode: 'フォーカスモード',
                        focusModeSettings: 'フォーカスモード設定',
                        showFocusModeToggle: 'フォーカスモード切替を表示',
                        focusDuration: '集中時間',
                        breakDuration: '休憩時間',
                        tutorialFocusModeMessage: '集中時間と休憩時間を交互に切り替えるフォーカスモード（ポモドーロテクニック）を利用できます。',
                        tutorialStep4Desc: 'ここにグループ名を入力すると、後で統計やリストで分類できます(任意)。',
                        tutorialStep5Title: '統計',
                        tutorialStep5Desc: '統計画面では、今日・今週・今月の勉強時間や、グループごとの統計を確認できます。',
                        tutorialStep6Title: '履歴リスト',
                        tutorialStep6Desc: 'これまでの学習履歴を一覧で確認できます。検索やソート、グループでの絞り込みも可能です。',
                        tutorialStep7Title: '設定',
                        tutorialStep7Desc: 'ここでテーマの変更、音楽プレイヤーやToDoリストの有効化、データのエクスポート/インポートができます。',
                        tutorialStep8Title: 'テーマ切り替え',
                        tutorialStep8Desc: 'このボタンでダークモードとライトモードを切り替えられます。',
                    },
                    en: {
                        // Font Settings
                        fontSettings: 'Font Settings',
                        fontJapanese: 'Font for Japanese & Others',
                        fontEnglish: 'Font for Alphanumeric',
                        fontNone: 'None (Unset)',
                        fontMushin: 'Mushin',
                        fontUtsukushi: 'Utsukushi Mincho',
                        fontMisaki: 'Misaki Gothic',
                        fontKodenmachou: 'Kodenmachou',
                        fontShirokuma: 'Shirokuma',
                        licenseButton: 'License',
                        licenseTitle: 'Font Licenses',

                        // Meta
                        title: 'Study Time Manager',
                        description: 'Start the timer with your study session and track your work time.',

                        // Main Menu
                        menuTimer: 'Timer',
                        menuStats: 'Stats',
                        menuList: 'List',
                        menuMusic: 'Music',
                        menuTodo: 'ToDo',

                        // Timer Page
                        groupPlaceholder: 'Group name (optional)',
                        sessionStart: 'Press the start button to begin studying',
                        startButton: 'Start Study',
                        pauseButton: 'Pause',
                        resumeButton: 'Resume',
                        endButton: 'End',
                        startTime: 'Start time',
                        endTime: 'End time',
                        studyTime: 'Study time',
                        previousSession: 'Previous session',
                        group: 'Group',

                        // Stats Page
                        totalTime: 'Total Study Time',
                        todayTime: 'Today\'s Study Time',
                        weekTime: 'This Week\'s Study Time',
                        monthTime: 'This Month\'s Study Time',
                        averageTime: 'Average Study Time/Day',
                        selectGroup: 'Select Group',
                        filterByGroup: 'Filter by group',
                        allGroups: 'All Groups',

                        // List Page
                        allGroupsFilter: 'All Groups',
                        searchPlaceholder: 'Search by date or time (e.g., Dec 11, 2025 or 14:30)',
                        sortNewest: 'Newest First',
                        sortOldest: 'Oldest First',
                        sortLongest: 'Longest First',
                        sortShortest: 'Shortest First',
                        selectAll: 'Select All',
                        deleteSelected: 'Delete Selected',
                        moveGroup: 'Move to Group',
                        moveCount: 'selected',
                        moveDestination: 'Select destination',
                        moveButton: 'Move',
                        cancelButton: 'Cancel',
                        graphTitle: 'Study Time Graph',
                        clearHistory: 'Clear All History',
                        noHistory: 'No history yet',
                        hours: 'hours',

                        // Music Player
                        selectFile: 'Select File',
                        selectFolder: 'Select Folder',
                        previous: 'Previous',
                        play: 'Play',
                        pause: 'Pause',
                        next: 'Next',
                        loop: 'Loop',
                        loopOn: 'Loop On',
                        loopOff: 'Loop Off',
                        shuffle: 'Shuffle',
                        shuffleOn: 'Shuffle On',
                        shuffleOff: 'Shuffle Off',
                        volume: 'Volume',
                        playlist: 'Playlist',
                        deleteButton: 'Delete',
                        renameButton: 'Rename',
                        renameSong: 'Rename Song',
                        songNamePlaceholder: 'Enter song name',
                        saveButton: 'Save',

                        // ToDo List
                        newTaskPlaceholder: 'Enter a new task',
                        addButton: 'Add',
                        repeat: 'Repeat',
                        repeatNone: 'None',
                        repeatDaily: 'Daily',
                        repeatWeekly: 'Weekly',
                        repeatMonthly: 'Monthly',
                        priority: 'Priority',
                        priorityLow: 'Low',
                        priorityNormal: 'Normal',
                        priorityHigh: 'High',
                        filterAll: 'All',
                        filterActive: 'Active',
                        filterCompleted: 'Completed',
                        filterDaily: 'Daily',
                        filterWeekly: 'Weekly',

                        // Settings Page
                        settingsDisplay: 'Display Settings',
                        musicPlayer: 'Music Player',
                        todoList: 'ToDo List',
                        titleTimeDisplay: 'Show Time in Title',
                        themeColor: 'Theme Color',
                        themeBlue: 'Blue',
                        themeGreen: 'Green',
                        themePurple: 'Purple',
                        themeOrange: 'Orange',
                        themePink: 'Pink',
                        themeTeal: 'Teal',
                        themeWhite: 'White/Black',
                        lockSettingsDuringTimer: 'Lock Settings during Timer',
                        loadingAnimSetting: 'Show Loading Animation on Start',
                        graphDisplay: 'Graph Display',
                        studyGraph: 'Show Study Time Graph',
                        graphType: 'Graph Type',
                        graphBar: 'Bar Chart',
                        graphLine: 'Line Chart',
                        graphArea: 'Area Chart',
                        displayPeriod: 'Display Period',
                        period7days: 'Last 7 Days',
                        period14days: 'Last 14 Days',
                        period30days: 'Last 30 Days',
                        period90days: 'Last 90 Days',
                        period1year: 'Last Year',
                        periodAll: 'All Time',
                        displayLocation: 'Display Location',
                        locationList: 'List Screen',
                        locationStats: 'Stats Screen',
                        locationBoth: 'Both',
                        dataManagement: 'Data Management',
                        exportData: 'Export Data',
                        importData: 'Import Data',
                        helpSection: 'Help',
                        showGuide: 'Show User Guide',
                        languageSettings: 'Language Settings',
                        japanese: '日本語',
                        english: 'English',

                        // About
                        aboutButton: 'About This Site',
                        qaButton: 'FAQ (Q&A)',
                        aboutTitle: 'About This Site',
                        qaTitle: 'Frequently Asked Questions (FAQ)',
                        closeButton: 'Close',
                        okButton: 'OK',

                        // Confirm Dialog
                        confirm: 'Confirm',
                        confirmDelete: 'Are you sure you want to delete?',
                        confirmClear: 'Are you sure you want to clear all history?',

                        // Tutorial
                        tutorialWelcome: 'Would you like a tutorial?',
                        tutorialWelcomeMessage: 'For first-time users, we\'ll guide you through how to use this site step by step.',
                        tutorialClose: 'Close',
                        tutorialYes: 'Yes',
                        tutorialSkip: 'Skip',
                        tutorialPrev: 'Back',
                        tutorialNext: 'Next',
                        tutorialFinish: 'Finish',
                        tutorialStep: 'Step',
                        tutorialComplete: 'Tutorial Complete!',
                        tutorialCompleteMessage: 'Great job! You\'ve completed the basic tutorial. If you need help again, you can access the guide anytime from "Show User Guide" in the settings.',
                        // Accessibility labels
                        dragHandle: 'Drag handle',
                        copyright: '© 高級ジェネ™ All rights reserved.',
                        // Date format
                        year: '/',
                        month: '/',
                        day: '',

                        notSet: 'Not set',
                        periodLabel: 'Period',
                        rangeSeparator: 'to',
                        selectStartDate: 'Select start date',
                        selectEndDate: 'Select end date',
                        weekday_sun: 'Sun',
                        weekday_mon: 'Mon',
                        weekday_tue: 'Tue',
                        weekday_wed: 'Wed',
                        weekday_thu: 'Thu',
                        weekday_fri: 'Fri',
                        weekday_sat: 'Sat',
                        noTodosOnThisDay: 'No ToDos on this day',
                        // Additional UI labels
                        menu: 'Menu',
                        startOptional: 'Start date (optional)',
                        endOptional: 'End date (optional)',
                        tutorialPlaceholderTitle: 'Title',
                        tutorialPlaceholderMessage: 'Message',
                        playPause: 'Play/Pause',

                        // Stats Page - Additional
                        totalStudyTime: 'Total Study Time',
                        consecutiveDays: 'Consecutive Days',
                        totalSessions: 'Total Sessions',
                        groupStats: 'Group Statistics',
                        uncategorized: 'Uncategorized',
                        days: 'days',
                        sessions: 'sessions',

                        // List Page - Additional
                        start: 'Start',
                        end: 'End',
                        itemsToMove: 'items to move',
                        selectDestinationGroup: 'Select destination',

                        // Music Player - Additional
                        addFilesMessage: 'Please add files',
                        emptyPlaylist: 'Please add files',

                        deleteTaskConfirm: 'Are you sure you want to delete this task?',
                        deleteMusicConfirm: 'Are you sure you want to delete this music file?',
                        backButton: 'Back',
                        finishButton: 'Finish',
                        nextButton: 'Next',

                        // ToDo List - Additional
                        noTasks: 'No tasks',
                        newTask: 'Enter a new task',

                        sinchokudo: 'Progress',

                        // Tutorial Steps
                        tutorialStep1Title: 'Main Menu',
                        tutorialStep1Desc: 'Access all features from here. Switch between Timer, Stats, History list, and more.',
                        tutorialStep2Title: 'Timer',
                        tutorialStep2Desc: 'This timer tracks your study time. Press the start button to begin measuring.',
                        tutorialStep3Title: 'Start Studying',
                        tutorialStep3Desc: 'Click this button to start tracking your study time.',
                        tutorialStep4Title: 'Group Name',

                        // Focus Mode
                        focusMode: 'Focus Mode',
                        focusModeSettings: 'Focus Mode Settings',
                        showFocusModeToggle: 'Show Focus Mode Toggle',
                        focusDuration: 'Focus Duration',
                        breakDuration: 'Break Duration',
                        tutorialFocusModeMessage: 'You can use Focus Mode (Pomodoro technique) to alternate between focus and break times.',
                        tutorialStep4Desc: 'Enter a group name here to categorize your sessions in stats and lists (optional).',
                        tutorialStep5Title: 'Statistics',
                        tutorialStep5Desc: 'View study time for today, this week, this month, and statistics by group.',
                        tutorialStep6Title: 'History List',
                        tutorialStep6Desc: 'View all your past study sessions. Search, sort, and filter by group.',
                        tutorialStep7Title: 'Settings',
                        tutorialStep7Desc: 'Change themes, enable music player and todo list, export/import data.',
                        tutorialStep8Title: 'Theme Toggle',
                        tutorialStep8Desc: 'Switch between Dark mode and Light mode with this button.',

                        // Tutorial
                        tutorialStartTitle: 'Start Stopwatch',
                        tutorialStartMessage: 'Click here to start the timer.',
                        tutorialTimerStartedTitle: 'Timer Started',
                        tutorialTimerStartedMessage: 'In actual study, focus on your work from here.',
                        tutorialPauseTitle: 'Pause',
                        tutorialPauseMessage: 'Click "Pause" button to take a break.',
                        tutorialPausedTitle: 'Paused',
                        tutorialPausedMessage: 'Timer is paused. Click again to resume.',
                        tutorialEndTitle: 'Finish Recording',
                        tutorialEndMessage: 'Click "Finish" when you are done. Time will be recorded.',
                        tutorialGroupTitle: 'Grouping',
                        tutorialGroupMessage: 'Enter group name to categorize your study (e.g., Math, English).',
                        tutorialStatsTitle: 'Check Statistics',
                        tutorialStatsMessage: 'Click here to see total time, consecutive days, and group stats.',
                        tutorialHistoryTitle: 'Check History',
                        tutorialHistoryMessage: 'Click here to view past study records. Search, sort, and edit.',
                        tutorialDarkModeTitle: 'Dark Mode',
                        tutorialDarkModeMessage: 'Toggle light/dark mode for eye comfort.',
                        tutorialSettingsTitle: 'Settings',
                        tutorialSettingsMessage: 'Open settings for themes, data backup, and feature toggles.',
                        tutorialDisplaySettingsTitle: 'Display Settings',
                        tutorialDisplaySettingsMessage: 'Toggle features like Music Player or ToDo list on/off.',
                        tutorialThemeColorTitle: 'Theme Color',
                        tutorialThemeColorMessage: 'Choose your favorite theme color from 6 options.',
                        tutorialGraphDisplayTitle: 'Graph Settings',
                        tutorialGraphDisplayMessage: 'Customize graph type and display period.',
                        tutorialDataManagementTitle: 'Data Management',
                        tutorialDataManagementMessage: 'Export/Import data for backup or migration.',
                        tutorialCompletedTitle: 'Tutorial Completed!',
                        tutorialCompletedMessage: 'That\'s it! You can review this guide anytime from Settings.',
                        skipButton: 'Skip',
                        step: 'step',

                        // General
                        confirmDefaultTitle: 'Confirm',
                        studyTimeManagement: 'Study Time Manager',
                        cancelButton: 'Cancel',

                        // About & QA
                        aboutContent: `<div style="text-align: center; margin-bottom: 20px;">
                        <div><img src="guide.webp" style="width: 3rem; height: 3rem;"></div>
                        <h3 style="margin-top: 0;">Study Time Manager</h3>
                        <p>Simple and easy-to-use study time management tool.</p>
                        Developed by <a href="https://kokyujene.super-hiko14.com/members/super-hiko14/">Super Hiko14</a>.<div class="tyuui-mini-text">* AI is used in some parts.</div>
                        </div>`,
                        qaContent: `<div style="text-align: left;">
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. Where is data saved?</h3>
                            <p style="margin-left: 15px;">A. All data is saved in your browser's local storage. Not sent to any server.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. I want to migrate/backup data.</h3>
                            <p style="margin-left: 15px;">A. You can download a JSON file from Export. Use Import to restore or migrate.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. What music files are supported?</h3>
                            <p style="margin-left: 15px;">A. Supports mp3, wav, flac, m4a, aac, ogg, webm etc.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. If I close while timer paused?</h3>
                            <p style="margin-left: 15px;">A. Timer continues running even if site is closed.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. Do you have any plans to add YouTube videos or anything like that to the music player?</h3>
                            <p style="margin-left: 15px;">A. No plans due to Terms of Service compliance.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. Future features?</h3>
                            <p style="margin-left: 15px;">A. Undecided. If added, will be togglable in settings.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. Monetization/Ads?</h3>
                            <p style="margin-left: 15px;">A. N O (Assertive)</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. App release?</h3>
                            <p style="margin-left: 15px;">A. I want to... but not technically capable yet.</p>
                            <h3 style="font-size: 1.1rem; margin-top: 20px; margin-bottom: 10px;">Q. Meow meow? (More Q&A?)</h3>
                            <p style="margin-left: 15px;">A. Meow meow. (More Q&A maybe later.)</p>
                            <h3 style="font-size: 0.9rem; margin-top: 20px; margin-bottom: 10px;">That's about it...</h3>
                        </div>`,

                        clearHistoryConfirm: 'Are you sure you want to delete all study history?',
                        clearAllConfirmTitle: 'Confirm Delete All',
                        deleteSelectedConfirm: 'Delete selected {n} items?',
                        deleteConfirmTitle: 'Confirm Delete',

                        // ToDo List
                        todoPlaceholder: 'Enter a new task',
                        todoAddButton: 'Add',
                        todoV2PopupTitle: 'Enable ToDo Ver.2?',
                        todoV2PopupMessage: 'The new ToDo Ver.2 introduces advanced features such as incremental completion, period settings, and a calendar view.',
                        todoV2ToggleLabel: 'Enable ToDo Ver.2',
                        todoV2Confirm: 'Confirm',
                        calendarAddTodoTitle: 'Add New ToDo',
                        calendarAddTodoPlaceholder: 'Enter a task',
                        todoViewList: 'ToDo List',
                        todoViewCalendar: 'Calendar',
                        prevMonth: '◀ Prev',
                        nextMonth: 'Next ▶',
                        confirmMessage: 'Are you sure you want to perform this action?',
                        confirmIconAlt: 'Confirm',
                        okButton: 'OK',
                        guideAlt: 'Guide',
                        themeToggleAlt: 'Toggle theme',
                        settingsAlt: 'Settings',
                    }
                };

                // 翻訳テキストを取得
                function getText(key) {
                    return translations[currentLanguage][key] || translations['ja'][key] || key;
                }

                // 言語を変更
                function changeLanguage(lang) {
                    currentLanguage = lang;
                    saveData('app_language', lang);
                    applyTranslations();

                    // 動的に生成される要素も更新
                    if (getData('graph_enabled') === 'true') {
                        updateGraphs();
                    }
                    loadHistory();
                    loadStats();
                    loadPlaylist();
                    loadTodos();
                }

                // すべての翻訳を適用
                function applyTranslations() {
                    // data-i18n属性を持つ要素を更新
                    document.querySelectorAll('[data-i18n]').forEach(element => {
                        const key = element.getAttribute('data-i18n');
                        const text = getText(key);

                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            if (element.placeholder !== undefined) {
                                element.placeholder = text;
                            }
                        } else if (element.tagName === 'SELECT') {
                            // select要素は子要素のoptionを個別に処理
                        } else if (element.tagName === 'OPTION') {
                            element.textContent = text;
                        } else {
                            // ボタンやラベルなど
                            element.textContent = text;
                        }
                    });

                    // data-i18n-html属性を持つ要素を更新(HTML含む)
                    document.querySelectorAll('[data-i18n-html]').forEach(element => {
                        const key = element.getAttribute('data-i18n-html');
                        element.innerHTML = getText(key);
                    });

                    // meta description を更新
                    const metaDesc = document.querySelector('meta[name="description"]');
                    if (metaDesc) metaDesc.setAttribute('content', getText('description'));
                    const ogDesc = document.querySelector('meta[property="og:description"]');
                    if (ogDesc) ogDesc.setAttribute('content', getText('description'));

                    // data-i18n-alt を持つ要素は alt 属性を更新
                    document.querySelectorAll('[data-i18n-alt]').forEach(el => {
                        const key = el.getAttribute('data-i18n-alt');
                        el.alt = getText(key);
                    });

                    // data-i18n-aria を持つ要素は aria-label を更新
                    document.querySelectorAll('[data-i18n-aria]').forEach(el => {
                        const key = el.getAttribute('data-i18n-aria');
                        el.setAttribute('aria-label', getText(key));
                    });

                    // 言語切り替えボタンの状態を更新
                    document.querySelectorAll('.language-option').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`[data-lang="${currentLanguage}"]`)?.classList.add('active');

                    // ページタイトルも更新
                    if (!startTime) {
                        document.title = getText('title');
                    }

                    // HTML lang属性を更新
                    document.documentElement.lang = currentLanguage;
                }

                // カスタム確認ダイアログ
                let confirmResolve = null;


                function customConfirm(message, title = null, iconSrc = 'warning.webp') {
                    return new Promise((resolve) => {
                        confirmResolve = resolve;
                        const overlay = document.getElementById('customConfirmOverlay');
                        const titleEl = document.getElementById('confirmTitle');
                        const messageEl = document.getElementById('confirmMessage');
                        const iconImg = document.getElementById('confirmIconImg');

                        titleEl.textContent = title || getText('confirmDefaultTitle');
                        messageEl.textContent = message;

                        // キャンセルボタンのテキスト更新
                        const cancelBtn = document.getElementById('confirmCancel');
                        if (cancelBtn) cancelBtn.textContent = getText('cancelButton');

                        if (iconImg) {
                            iconImg.src = iconSrc;
                        }

                        overlay.classList.add('show');
                    });
                }

                document.getElementById('confirmOk').addEventListener('click', () => {
                    const overlay = document.getElementById('customConfirmOverlay');
                    overlay.classList.remove('show');
                    if (confirmResolve) {
                        confirmResolve(true);
                        confirmResolve = null;
                    }
                });

                document.getElementById('confirmCancel').addEventListener('click', () => {
                    const overlay = document.getElementById('customConfirmOverlay');
                    overlay.classList.remove('show');
                    if (confirmResolve) {
                        confirmResolve(false);
                        confirmResolve = null;
                    }
                });

                // オーバーレイクリックで閉じる
                document.getElementById('customConfirmOverlay').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        const overlay = document.getElementById('customConfirmOverlay');
                        overlay.classList.remove('show');
                        if (confirmResolve) {
                            confirmResolve(false);
                            confirmResolve = null;
                        }
                    }
                });

                // About モーダル(最終確認風ポップアップ)表示/非表示
                function showAboutModal() {
                    const overlay = document.getElementById('aboutOverlay');
                    if (!overlay) return;
                    overlay.classList.add('show');
                    overlay.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('no-scroll');
                    const ok = document.getElementById('aboutOkBtn');
                    try { ok && ok.focus(); } catch (e) { }
                }

                function hideAboutModal() {
                    const overlay = document.getElementById('aboutOverlay');
                    if (!overlay) return;
                    overlay.classList.remove('show');
                    overlay.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('no-scroll');
                }

                // Q&A モーダル表示/非表示
                function showQAModal() {
                    const overlay = document.getElementById('qaOverlay');
                    if (!overlay) return;
                    overlay.classList.add('show');
                    overlay.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('no-scroll');
                    const ok = document.getElementById('qaOkBtn');
                    try { ok && ok.focus(); } catch (e) { }
                }

                function hideQAModal() {
                    const overlay = document.getElementById('qaOverlay');
                    if (!overlay) return;
                    overlay.classList.remove('show');
                    overlay.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('no-scroll');
                }

                // クリックでオーバーレイ閉じる
                document.addEventListener('click', (e) => {
                    const aboutOverlay = document.getElementById('aboutOverlay');
                    const qaOverlay = document.getElementById('qaOverlay');

                    if (aboutOverlay && aboutOverlay.classList.contains('show') && e.target === aboutOverlay) {
                        hideAboutModal();
                    }

                    if (qaOverlay && qaOverlay.classList.contains('show') && e.target === qaOverlay) {
                        hideQAModal();
                    }
                });

                document.getElementById('aboutCloseBtn')?.addEventListener('click', hideAboutModal);
                document.getElementById('aboutOkBtn')?.addEventListener('click', hideAboutModal);
                document.getElementById('qaCloseBtn')?.addEventListener('click', hideQAModal);
                document.getElementById('qaOkBtn')?.addEventListener('click', hideQAModal);

                // Esc キーで閉じる
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hideAboutModal();
                        hideQAModal();
                    }
                });

                function openMusicDB() {
                    return new Promise((resolve, reject) => {
                        if (_musicDB) return resolve(_musicDB);
                        const req = indexedDB.open('study_music_db', 1);
                        req.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains('files')) {
                                db.createObjectStore('files', { keyPath: 'id' });
                            }
                        };
                        req.onsuccess = (e) => {
                            _musicDB = e.target.result;
                            resolve(_musicDB);
                        };
                        req.onerror = (e) => reject(e);
                    });
                }

                async function saveFileBlobToDB(id, title, file) {
                    const db = await openMusicDB();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('files', 'readwrite');
                        const store = tx.objectStore('files');
                        const req = store.put({ id: id, title: title, blob: file });
                        req.onsuccess = () => resolve();
                        req.onerror = (e) => reject(e);
                    });
                }

                async function getFileBlobFromDB(id) {
                    const db = await openMusicDB();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('files', 'readonly');
                        const store = tx.objectStore('files');
                        const req = store.get(id);
                        req.onsuccess = () => {
                            if (req.result) resolve(req.result.blob);
                            else resolve(null);
                        };
                        req.onerror = (e) => reject(e);
                    });
                }

                async function deleteFileBlobFromDB(id) {
                    const db = await openMusicDB();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('files', 'readwrite');
                        const store = tx.objectStore('files');
                        const req = store.delete(id);
                        req.onsuccess = () => resolve();
                        req.onerror = (e) => reject(e);
                    });
                }

                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) {
                        const val = parts.pop().split(';').shift();
                        try {
                            return decodeURIComponent(val);
                        } catch (e) {
                            console.warn('Cookie decode failed:', e);
                            return val;
                        }
                    }
                    return null;
                }

                function setCookie(name, value, days = 365) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    document.cookie = `${name}=${encodeURIComponent(value)};expires=${date.toUTCString()};path=/`;
                }

                function getData(key) {
                    try {
                        const val = localStorage.getItem(key);
                        if (val !== null) return val;
                    } catch (e) { }
                    return getCookie(key);
                }

                function saveData(key, value) {
                    try {
                        localStorage.setItem(key, value);
                        if (key === 'theme') {
                            console.log('[DEBUG] saveData theme ->', value);
                            console.trace();
                        }
                        // 古いCookieデータを削除して容量を確保・競合を防止
                        // 複数の path パターンで削除を試みる
                        document.cookie = `${key}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                        document.cookie = `${key}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/tool/study/`;
                    } catch (e) {
                        console.error('LocalStorage save failed:', e);
                        setCookie(key, value);
                    }
                }

                function toggleTheme() {
                    const body = document.body;
                    const themeIcon = document.getElementById('themeIcon');
                    if (body.classList.contains('light')) {
                        body.classList.remove('light');
                        body.classList.add('dark');
                        themeIcon.src = 'sun.webp';
                        themeIcon.alt = 'ライトモードに切り替え';
                        saveData('mode', 'dark');
                    } else {
                        body.classList.remove('dark');
                        body.classList.add('light');
                        themeIcon.src = 'moon.webp';
                        themeIcon.alt = 'ダークモードに切り替え';
                        saveData('mode', 'light');
                    }

                    if (getData('graph_enabled') === 'true') {
                        setTimeout(() => updateGraphs(), 100);
                    }
                }

                function changeTheme(themeName) {
                    document.body.setAttribute('data-theme', themeName);
                    saveData('theme', themeName);
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    const matchedThemeOption = document.querySelector(`.theme-option[data-theme="${themeName}"]`);
                    if (matchedThemeOption) {
                        matchedThemeOption.classList.add('selected');
                    }

                    if (getData('graph_enabled') === 'true') {
                        setTimeout(() => updateGraphs(), 100);
                    }
                }

                function toggleFeature(feature) {
                    const toggle = document.getElementById(`toggle${feature.charAt(0).toUpperCase() + feature.slice(1)}`);
                    const isActive = toggle.classList.contains('active');
                    if (isActive) {
                        toggle.classList.remove('active');
                        removeMenuButton(feature);
                        saveData(`feature_${feature}`, 'false');
                    } else {
                        toggle.classList.add('active');
                        addMenuButton(feature);
                        saveData(`feature_${feature}`, 'true');
                    }
                }

                function toggleTitleTime() {
                    const toggle = document.getElementById('toggleTitleTime');
                    const isActive = toggle.classList.contains('active');
                    if (isActive) {
                        toggle.classList.remove('active');
                        saveData('feature_title_time', 'false');
                        document.title = getText('studyTimeManagement'); // 即座に反映
                    } else {
                        toggle.classList.add('active');
                        saveData('feature_title_time', 'true');
                        // タイマー動作中なら次の updateTimer で更新されるのでここでは何もしない、または強制更新
                        updateTimer();
                    }
                }

                function addMenuButton(feature) {
                    const menu = document.getElementById('mainMenu');
                    const btnText = feature === 'music' ? getText('menuMusic') : getText('menuTodo');
                    const existingBtn = Array.from(menu.children).find(btn => btn.getAttribute('data-feature') === feature);
                    if (!existingBtn) {
                        const btn = document.createElement('button');
                        btn.textContent = btnText;
                        btn.onclick = () => showPage(feature);
                        btn.setAttribute('data-feature', feature);
                        btn.setAttribute('data-i18n', feature === 'music' ? 'menuMusic' : 'menuTodo');
                        menu.appendChild(btn);
                    } else {
                        // 既存ボタンのテキスト更新(言語切り替え時など)
                        existingBtn.textContent = btnText;
                    }
                }

                function removeMenuButton(feature) {
                    const menu = document.getElementById('mainMenu');
                    const btn = menu.querySelector(`[data-feature="${feature}"]`);
                    if (btn) btn.remove();
                }

                function showPage(pageName) {
                    if (pageName === 'settings') {
                        const isTimerRunning = startTime !== null && !isPaused;
                        if (isTimerRunning && getData('lock_settings_during_timer') === 'true') {
                            return;
                        }
                    }
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.querySelectorAll('.menu button').forEach(btn => btn.classList.remove('active'));
                    const pages = { 'timer': 'timerPage', 'stats': 'statsPage', 'list': 'listPage', 'music': 'musicPage', 'todo': 'todoPage', 'settings': 'settingsPage' };
                    if (pages[pageName]) {
                        document.getElementById(pages[pageName]).classList.add('active');
                        const menuButtons = Array.from(document.querySelectorAll('.menu button'));
                        const activeBtn = menuButtons.find(btn => {
                            if (btn.dataset.page === pageName) return true;
                            if (btn.dataset.feature === pageName) return true;
                            return false;
                        });
                        if (activeBtn) activeBtn.classList.add('active');
                        if (pageName === 'stats') { loadStats(); updateGraphs(); }
                        if (pageName === 'list') { updateGroupFilter(); loadHistory(); updateGraphs(); }
                        if (pageName === 'music') loadPlaylist();
                        if (pageName === 'todo') loadTodos();
                    }
                }

                // Focus Mode Variables
                let focusEnabled = false;
                let devModeEnabled = false; // Developer mode for testing (Shift+J/F to add/remove time)
                let focusState = 'focus'; // 'focus' or 'break' — only used to detect transitions for sound

                // Developer Mode Functions
                function toggleDevMode() {
                    const toggle = document.getElementById('toggleDevMode');
                    if (!toggle) return;
                    devModeEnabled = !devModeEnabled;
                    toggle.classList.toggle('active', devModeEnabled);
                    saveData('dev_mode_enabled', devModeEnabled ? 'true' : 'false');
                    if (devModeEnabled) {
                        console.log('[DEBUG] Developer Mode enabled. Shift+J to add 1 min, Shift+F to remove 1 min (hold for continuous)');
                    }
                }

                function addTime(minutes) {
                    if (!startTime || isPaused) return; // Only when timer is running
                    startTime -= minutes * 60 * 1000;
                    console.log(`[DEBUG] Time adjusted +${minutes}min. Total elapsed now ~${formatTime(Date.now() - startTime + pausedTime)}`);
                }

                function removeTime(minutes) {
                    if (!startTime || isPaused) return; // Only when timer is running
                    startTime += minutes * 60 * 1000;
                    console.log(`[DEBUG] Time adjusted -${minutes}min. Total elapsed now ~${formatTime(Date.now() - startTime + pausedTime)}`);
                }

                // Developer Mode Keyboard Handler
                let devModeKeyIntervals = {}; // Track active continuous key presses
                window.addEventListener('keydown', (e) => {
                    if (!devModeEnabled || !startTime) return;
                    if (e.code === 'KeyJ' && e.shiftKey && !devModeKeyIntervals['KeyJ']) {
                        addTime(1);
                        devModeKeyIntervals['KeyJ'] = setInterval(() => addTime(1), 200); // Repeat every 200ms on hold
                        e.preventDefault();
                    } else if (e.code === 'KeyF' && e.shiftKey && !devModeKeyIntervals['KeyF']) {
                        removeTime(1);
                        devModeKeyIntervals['KeyF'] = setInterval(() => removeTime(1), 200);
                        e.preventDefault();
                    }
                });
                window.addEventListener('keyup', (e) => {
                    if (e.code === 'KeyJ' && devModeKeyIntervals['KeyJ']) {
                        clearInterval(devModeKeyIntervals['KeyJ']);
                        delete devModeKeyIntervals['KeyJ'];
                    } else if (e.code === 'KeyF' && devModeKeyIntervals['KeyF']) {
                        clearInterval(devModeKeyIntervals['KeyF']);
                        delete devModeKeyIntervals['KeyF'];
                    }
                });

                function formatTimeShort(ms) {
                    const totalSeconds = Math.floor(ms / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }

                function toggleFocusDisplaySetting() {
                    const toggle = document.getElementById('toggleFocusDisplay');
                    const isActive = toggle.classList.contains('active');
                    if (isActive) {
                        toggle.classList.remove('active');
                        saveData('feature_focus_mode_display', 'false');
                        document.getElementById('focusModeToggleContainer').style.display = 'none';
                    } else {
                        toggle.classList.add('active');
                        saveData('feature_focus_mode_display', 'true');
                        document.getElementById('focusModeToggleContainer').style.display = 'block';
                    }
                }

                function saveFocusSettings() {
                    const focusDuration = document.getElementById('focusDurationSelect').value;
                    const breakDuration = document.getElementById('breakDurationSelect').value;
                    saveData('focus_duration', focusDuration);
                    saveData('break_duration', breakDuration);
                }

                function toggleFocusModeMain(isPageLoad = false) {
                    const toggle = document.getElementById('toggleFocusModeMain');
                    const timer = document.getElementById('timer');
                    const subTimer = document.getElementById('totalTimerDisplay');

                    // Determine desired state (load or toggle)
                    let newState = !toggle.classList.contains('active');
                    if (isPageLoad) {
                        const savedState = getData('focus_mode_enabled');
                        newState = savedState === 'true';
                    }

                    if (newState) {
                        toggle.classList.add('active');
                        focusEnabled = true;
                        focusState = 'focus'; // reset transition detector
                        saveData('focus_mode_enabled', 'true');
                        subTimer.style.display = 'block';
                        timer.style.fontSize = '3.5rem';

                        if (!startTime) {
                            const fd = getFocusDurationMs();
                            timer.textContent = `${formatTimeShort(fd)} / 00:00`;
                            subTimer.textContent = '00:00:00';
                        } else {
                            updateTimer();
                        }
                    } else {
                        toggle.classList.remove('active');
                        focusEnabled = false;
                        saveData('focus_mode_enabled', 'false');
                        subTimer.style.display = 'none';
                        timer.style.fontSize = '4rem';

                        if (!startTime) {
                            timer.textContent = '00:00:00';
                        } else {
                            updateTimer();
                        }
                    }
                }

                function getFocusDurationMs() {
                    return parseInt(getData('focus_duration') || '25') * 60 * 1000;
                }

                function getBreakDurationMs() {
                    return parseInt(getData('break_duration') || '5') * 60 * 1000;
                }

                async function playFocusSound() {
                    try {
                        const audio = new Audio('tuuti.wav');
                        await audio.play();
                    } catch (e) {
                        console.log('Notification sound not found or blocked', e);
                    }
                }

                function formatTime(ms) {
                    const totalSeconds = Math.floor(ms / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }

                function formatDateTime(date) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${hours}:${minutes}`;
                }

                // 日付と時刻を両方表示するためのヘルパー
                function formatDateTimeLong(date) {
                    return `${formatDate(date)} ${formatDateTime(date)}`;
                }

                function formatDate(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    if (currentLanguage === 'en') {
                        return `${year}/${month}/${day}`;
                    }
                    return `${year}${getText('year')}${month}${getText('month')}${day}${getText('day')}`;
                }

                // Compute focus mode breakdown from wall elapsed (stateless — no circular dependency)
                function computeFocusCycle(wallElapsed) {
                    const focusDur = getFocusDurationMs();
                    const breakDur = getBreakDurationMs();
                    const cycleDur = focusDur + breakDur;

                    const completedCycles = Math.floor(wallElapsed / cycleDur);
                    const posInCycle = wallElapsed - completedCycles * cycleDur; // avoid floating point issues with %

                    let currentState, cycleElapsed, targetDuration, totalBreakTime;

                    if (posInCycle < focusDur) {
                        currentState = 'focus';
                        cycleElapsed = posInCycle;
                        targetDuration = focusDur;
                        totalBreakTime = completedCycles * breakDur;
                    } else {
                        currentState = 'break';
                        cycleElapsed = posInCycle - focusDur;
                        targetDuration = breakDur;
                        totalBreakTime = completedCycles * breakDur + cycleElapsed;
                    }

                    return { currentState, cycleElapsed, targetDuration, totalBreakTime, netStudyTime: wallElapsed - totalBreakTime };
                }

                function updateTimer() {
                    if (!startTime) return;

                    const wallElapsed = Date.now() - startTime + pausedTime;

                    if (focusEnabled) {
                        const fc = computeFocusCycle(wallElapsed);

                        // Detect state transition → play sound
                        if (fc.currentState !== focusState) {
                            playFocusSound();
                            focusState = fc.currentState;
                        }

                        const targetStr = formatTimeShort(fc.targetDuration);
                        const currentStr = formatTimeShort(fc.cycleElapsed);
                        const totalStr = formatTime(fc.netStudyTime);

                        document.getElementById('timer').textContent = `${targetStr} / ${currentStr}`;
                        document.getElementById('totalTimerDisplay').textContent = totalStr;
                        document.title = `${totalStr} - ${getText('studyTimeManagement')}`;
                    } else {
                        const timeStr = formatTime(wallElapsed);
                        document.getElementById('timer').textContent = timeStr;
                        document.title = `${timeStr} - ${getText('studyTimeManagement')}`;
                    }
                }
                

                function startStudy() {
                    startTime = Date.now();
                    pausedTime = 0;
                    isPaused = false;

                    // Focus Mode Init
                    focusState = 'focus';

                    const startTimeStr = new Date().toISOString();
                    saveData('studyStartTime', startTimeStr);
                    saveData('studyPaused', 'false');
                    saveData('studyPausedAccum', '0');
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('pauseBtn').classList.remove('hidden');
                    document.getElementById('endBtn').classList.remove('hidden');
                    document.getElementById('sessionInfo').textContent = `${getText('startTime')}: ${formatDateTime(new Date())}`;
                    timerInterval = setInterval(updateTimer, 100);
                    updateSettingsButtonState();

                    // Update Focus Mode UI state if enabled
                    if (focusEnabled) {
                        document.getElementById('totalTimerDisplay').style.display = 'block';
                        document.getElementById('timer').style.fontSize = '3.5rem';
                        updateTimer(); // Initial update
                    }
                }

                function pauseStudy() {
                    if (!isPaused) {
                        // 一時停止
                        pausedTime += Date.now() - startTime;
                        isPaused = true;
                        if (timerInterval) clearInterval(timerInterval);
                        document.getElementById('pauseBtn').textContent = getText('resumeButton');
                        saveData('studyPaused', 'true');
                        saveData('studyPausedAccum', String(pausedTime));
                        updateSettingsButtonState();
                    } else {
                        // 再開
                        startTime = Date.now();
                        isPaused = false;
                        timerInterval = setInterval(updateTimer, 100);
                        document.getElementById('pauseBtn').textContent = getText('pauseButton');
                        saveData('studyPaused', 'false');
                        updateSettingsButtonState();
                    }
                }

                function endStudy() {
                    if (timerInterval) clearInterval(timerInterval);
                    document.title = getText('studyTimeManagement');
                    const endTime = new Date();
                    const startCookie = getData('studyStartTime');
                    const groupInput = document.getElementById('groupInput');
                    const groupName = groupInput.value.trim() || '';
                    if (startCookie) {
                        const start = new Date(startCookie);
                        if (isNaN(start.getTime())) {
                            console.warn('Invalid stored start time:', startCookie);
                        } else {
                            // 終了時刻 - 保存された開始時刻 を使って計算
                            const rawWallTime = isPaused ? pausedTime : (endTime.getTime() - start.getTime() + pausedTime);
                            // フォーカスモード有効時は休憩時間を除外
                            let actualStudyTime = rawWallTime;
                            if (focusEnabled) {
                                const fc = computeFocusCycle(rawWallTime);
                                actualStudyTime = fc.netStudyTime;
                            }
                            let history = getData('studyHistory');
                            history = history ? JSON.parse(history) : [];
                            history.unshift({ start: start.toISOString(), end: endTime.toISOString(), duration: actualStudyTime, group: groupName });
                            saveData('studyHistory', JSON.stringify(history));
                            const startDisplay = formatDateTimeLong(start);
                            const endDisplay = formatDateTimeLong(endTime);
                            document.getElementById('sessionInfo').innerHTML = `${getText('startTime')}: ${startDisplay}<br>${getText('endTime')}: ${endDisplay}<br>${getText('studyTime')}: ${formatTime(actualStudyTime)}${groupName ? '<br>' + getText('group') + ': ' + groupName : ''}`;
                        }
                    }
                    // セッション終了時は一時保存データを削除
                    localStorage.removeItem('studyStartTime');
                    localStorage.removeItem('studyPaused');
                    localStorage.removeItem('studyPausedAccum');
                    setCookie('studyStartTime', '', -1);
                    setCookie('studyPaused', '', -1);
                    setCookie('studyPausedAccum', '', -1);
                    document.getElementById('startBtn').classList.remove('hidden');
                    document.getElementById('pauseBtn').classList.add('hidden');
                    document.getElementById('endBtn').classList.add('hidden');
                    document.getElementById('pauseBtn').textContent = getText('pauseButton');
                    groupInput.value = '';
                    startTime = null;
                    pausedTime = 0;
                    isPaused = false;
                    updateSettingsButtonState();
                }

                async function addMusicFile(event) {
                    const allFiles = Array.from(event.target.files || []);
                    const audioFiles = allFiles.filter(f => {
                        if (!f) return false;
                        if (f.type && f.type.startsWith('audio/')) return true;
                        return /\.(mp3|wav|flac|m4a|aac|ogg|webm|opus)$/i.test(f.name);
                    });
                    if (audioFiles.length === 0) {
                        return;
                    }
                    for (let file of audioFiles) {
                        const id = Date.now() + Math.random();
                        try {
                            await saveFileBlobToDB(id, file.name, file);
                            const blob = await getFileBlobFromDB(id);
                            if (blob) {
                                const url = URL.createObjectURL(blob);
                                musicFiles.push({ url: url, title: file.name, id: id });
                            } else {
                                const url = URL.createObjectURL(file);
                                musicFiles.push({ url: url, title: file.name, id: id });
                            }
                        } catch (e) {
                            console.error('Failed to persist file to DB, using in-memory URL', e);
                            const url = URL.createObjectURL(file);
                            musicFiles.push({ url: url, title: file.name, id: id });
                        }
                    }
                    savePlaylist();
                    loadPlaylist();
                }
                function savePlaylist() {
                    const playlistData = musicFiles.map(m => ({ title: m.title, id: m.id }));
                    saveData('musicPlaylist', JSON.stringify(playlistData));
                }

                // 新しいプレイリスト描画(handle と data-index を付与)
                function loadPlaylist() {
                    const playlistDiv = document.getElementById('playlist');
                    if (musicFiles.length === 0) {
                        playlistDiv.innerHTML = `<div class="empty-state">${getText('emptyPlaylist')}</div>`;
                        return;
                    }
                    playlistDiv.innerHTML = musicFiles.map((item, index) => `
        <div class="playlist-item ${index === currentMusicIndex ? 'playing' : ''}" data-index="${index}">
            <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:0;">
                <img src="drag_handle.webp" class="drag-handle" data-index="${index}" aria-label="並べ替えハンドル" data-i18n-aria="dragHandle" style="width: 24px; height: 24px; cursor: grab; touch-action: none;" alt="">
                <div class="playlist-item-info" style="flex:1; min-width:0;">
                    <div class="playlist-item-title">
                        <span class="title-text">${escapeHtml(item.title)}</span>
                    </div>
                </div>
            </div>
            <div class="playlist-item-buttons">
                <button class="secondary" onclick="event.stopPropagation(); startRename(${index})">${getText('renameButton')}</button>
                <button class="delete-btn" onclick="event.stopPropagation(); deleteMusic(${index})">${getText('deleteButton')}</button>
            </div>
        </div>
    `).join('');
                    attachPlaylistHandlers();
                }

                // エスケープ用(簡易)
                function escapeHtml(s) {
                    return String(s).replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]; });
                }

                // ドラッグ & 長押しで並べ替えモード
                let _dragSrcIndex = null;
                function attachPlaylistHandlers() {
                    const playlist = document.getElementById('playlist');

                    // 各プレイリストアイテムにドラッグを有効化
                    playlist.querySelectorAll('.playlist-item').forEach(item => {
                        const idx = parseInt(item.getAttribute('data-index'), 10);
                        item.setAttribute('draggable', 'true');

                        // dragstart: ドラッグ開始
                        item.addEventListener('dragstart', (e) => {
                            _dragSrcIndex = idx;
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('text/plain', String(idx));
                            item.classList.add('dragging');
                        });

                        // dragover: ドラッグ中は常にデフォルト動作を抑止
                        item.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';
                            item.classList.add('drag-over');
                        });

                        // dragleave: ドラッグ対象外になった時
                        item.addEventListener('dragleave', () => {
                            item.classList.remove('drag-over');
                        });

                        // drop: ドロップ時に並べ替え実行
                        item.addEventListener('drop', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            item.classList.remove('drag-over');

                            const targetIndex = parseInt(item.getAttribute('data-index'), 10);
                            const src = _dragSrcIndex !== null ? _dragSrcIndex : parseInt(e.dataTransfer.getData('text/plain') || -1, 10);

                            if (!isNaN(src) && src >= 0 && src !== targetIndex) {
                                reorderMusic(src, targetIndex);
                            }

                            _dragSrcIndex = null;
                        });

                        // dragend: ドラッグ終了
                        item.addEventListener('dragend', () => {
                            item.classList.remove('dragging');
                            item.classList.remove('drag-over');
                            _dragSrcIndex = null;
                        });

                        // クリックで再生(ハンドル以外の場所をクリック時)
                        item.addEventListener('click', (e) => {
                            if (e.target.classList.contains('drag-handle') || e.target.closest('.drag-handle')) {
                                return; // ハンドルクリックは無視
                            }
                            playMusic(idx);
                        });
                    });
                }

                // 実際の並べ替え処理
                function reorderMusic(srcIndex, targetIndex) {
                    if (srcIndex === targetIndex) return;
                    const item = musicFiles.splice(srcIndex, 1)[0];
                    musicFiles.splice(targetIndex, 0, item);
                    savePlaylist();
                    loadPlaylist();
                }

                // 独自の曲名編集(ポップアップ方式)
                let _renamingIndex = null;

                function startRename(index) {
                    _renamingIndex = index;
                    const currentTitle = musicFiles[index].title;
                    const overlay = document.getElementById('renameOverlay');
                    const input = document.getElementById('renameInput');

                    input.value = currentTitle;
                    overlay.classList.add('show');
                    overlay.setAttribute('aria-hidden', 'false');

                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 100);
                }

                function commitRename() {
                    if (_renamingIndex === null) return;
                    const input = document.getElementById('renameInput');
                    const newName = input.value.trim();

                    if (newName && newName !== musicFiles[_renamingIndex].title) {
                        musicFiles[_renamingIndex].title = newName;
                        savePlaylist();
                    }

                    cancelRename();
                }

                function cancelRename() {
                    const overlay = document.getElementById('renameOverlay');
                    overlay.classList.remove('show');
                    overlay.setAttribute('aria-hidden', 'true');
                    _renamingIndex = null;
                    loadPlaylist();
                }

                // rename ポップアップのイベントリスナー
                document.getElementById('renameOkBtn')?.addEventListener('click', commitRename);
                document.getElementById('renameCancelBtn')?.addEventListener('click', cancelRename);
                document.getElementById('renameOverlay')?.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) cancelRename();
                });

                // renameInputでEnterキー対応
                document.getElementById('renameInput')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        commitRename();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelRename();
                    }
                });

                // 汎用: 再生を試み、失敗時はリトライするヘルパー
                function attemptPlay(audio, retries = 3, delay = 400) {
                    return audio.play().catch(err => {
                        if (retries <= 0) return Promise.reject(err);
                        return new Promise(resolve => setTimeout(resolve, delay)).then(() => attemptPlay(audio, retries - 1, Math.min(delay * 2, 2000)));
                    });
                }

                function playMusic(index) {
                    if (musicFiles[index]) {
                        const audio = document.getElementById('audioPlayer');
                        audio.src = musicFiles[index].url;
                        // iOS の場合、バックグラウンド復帰後などで play() が拒否されることがあるため、リトライを行う
                        attemptPlay(audio).then(() => {
                            updatePlayPauseUI(true);
                        }).catch((err) => {
                            console.warn('Playback failed after retries:', err);
                            updatePlayPauseUI(false);
                        });

                        currentMusicIndex = index;
                        const playImg = document.getElementById('playIconImg');
                        if (playImg) { playImg.src = 'pause.webp'; playImg.alt = '一時停止'; }
                        loadPlaylist();
                        updateMediaSession(); // Media Session API更新
                    }
                }

                // Media Session API 更新
                function updateMediaSession() {
                    if (!('mediaSession' in navigator) || currentMusicIndex < 0 || !musicFiles[currentMusicIndex]) return;

                    const file = musicFiles[currentMusicIndex];

                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: file.title,
                        // ユーザー要望のサブタイトル(Artist フィールドを利用)
                        artist: 'Study Time Manager - Music',
                        album: 'Local Playlist',
                        artwork: [
                            { src: 'music.png', sizes: '96x96', type: 'image/webp' },
                            { src: 'music.png', sizes: '180x180', type: 'image/webp' },
                            { src: 'music.png', sizes: '512x512', type: 'image/webp' }
                        ]
                    });

                    navigator.mediaSession.setActionHandler('play', function () {
                        const audio = document.getElementById('audioPlayer');
                        audio.play();
                        togglePlayStateUI(true); // UIのみ更新する関数が必要であれば分離、今回はtogglePlayを呼ぶと停止してしまうので直接制御か、togglePlayを改良
                        // ここでは既存のtogglePlayを呼ぶとトグルしてしまうので、再生用・停止用と分けるのがベターだが、
                        // 簡易的に audio.play() しているので、UI同期のため togglePlay を呼ぶのではなくUI更新処理を入れる
                        updatePlayPauseUI(true);
                    });

                    navigator.mediaSession.setActionHandler('pause', function () {
                        const audio = document.getElementById('audioPlayer');
                        audio.pause();
                        updatePlayPauseUI(false);
                    });

                    navigator.mediaSession.setActionHandler('previoustrack', function () {
                        playPrevious();
                    });

                    navigator.mediaSession.setActionHandler('nexttrack', function () {
                        playNext();
                    });

                    navigator.mediaSession.setActionHandler('seekto', function (details) {
                        const audio = document.getElementById('audioPlayer');
                        if (details.fastSeek && 'fastSeek' in audio) {
                            audio.fastSeek(details.seekTime);
                            return;
                        }
                        audio.currentTime = details.seekTime;
                    });
                }

                // 再生/一時停止UIの同期用ヘルパー
                let userInitiatedPause = false; // ユーザー操作による一時停止かどうかのフラグ

                function updatePlayPauseUI(isPlaying) {
                    const playImg = document.getElementById('playIconImg');
                    if (playImg) {
                        playImg.src = isPlaying ? 'pause.webp' : 'play_arrow.webp';
                        playImg.alt = isPlaying ? '一時停止' : '再生';
                    }
                    // リスト上のplayingクラスは再生中も一時停止中もactiveで良いならそのままだが、
                    // 一時停止中にスタイルを変えたい場合はここで制御。今回は変更なし。
                }

                function togglePlay() {
                    const audio = document.getElementById('audioPlayer');
                    if (audio.paused) {
                        userInitiatedPause = false;
                        if (currentMusicIndex === -1 && musicFiles.length > 0) {
                            playMusic(0);
                        } else {
                            attemptPlay(audio).then(() => {
                                updatePlayPauseUI(true);
                            }).catch(() => {
                                console.warn('Playback blocked on togglePlay');
                                // UIは再生できなかった場合はそのままにしておく
                            });
                        }
                    } else {
                        userInitiatedPause = true;
                        audio.pause();
                        updatePlayPauseUI(false);
                    }
                }

                function playNext() {
                    if (musicFiles.length === 0) return;
                    if (isShuffle) {
                        if (musicFiles.length === 1) {
                            currentMusicIndex = 0;
                        } else {
                            let nextIndex = currentMusicIndex;
                            while (nextIndex === currentMusicIndex) {
                                nextIndex = Math.floor(Math.random() * musicFiles.length);
                            }
                            currentMusicIndex = nextIndex;
                        }
                    } else {
                        currentMusicIndex = (currentMusicIndex + 1) % musicFiles.length;
                    }
                    playMusic(currentMusicIndex);
                }

                function playPrevious() {
                    if (musicFiles.length === 0) return;
                    currentMusicIndex = (currentMusicIndex - 1 + musicFiles.length) % musicFiles.length;
                    playMusic(currentMusicIndex);
                }

                function toggleLoop() {
                    isLoop = !isLoop;
                    const audio = document.getElementById('audioPlayer');
                    audio.loop = isLoop;
                    document.getElementById('loopBtn').style.opacity = isLoop ? '1' : '0.5';
                    const loopImg = document.getElementById('loopBtnImg');
                    if (loopImg) {
                        loopImg.src = isLoop ? 'loop_on.webp' : 'loop_off.webp';
                        loopImg.alt = isLoop ? 'ループオン' : 'ループオフ';
                    }
                }

                function toggleShuffle() {
                    isShuffle = !isShuffle;
                    document.getElementById('shuffleBtn').style.opacity = isShuffle ? '1' : '0.5';
                    const shImg = document.getElementById('shuffleBtnImg');
                    if (shImg) {
                        shImg.src = isShuffle ? 'shuffle_on.webp' : 'shuffle_off.webp';
                        shImg.alt = isShuffle ? 'シャッフルオン' : 'シャッフルオフ';
                    }
                }

                async function renameMusic(index) {
                    startRename(index);
                }

                async function deleteMusic(index) {
                    const confirmed = await customConfirm(getText('deleteMusicConfirm'), getText('deleteConfirmTitle'), 'delete.webp');
                    if (confirmed) {
                        const removed = musicFiles[index];
                        if (currentMusicIndex === index) {
                            const audio = document.getElementById('audioPlayer');
                            if (audio) {
                                audio.pause();
                                audio.src = '';
                            }
                            currentMusicIndex = -1;
                        } else if (currentMusicIndex > index) {
                            currentMusicIndex--;
                        }
                        try {
                            if (removed && removed.id != null) await deleteFileBlobFromDB(removed.id);
                        } catch (e) {
                            console.warn('Failed to delete blob from DB', e);
                        }
                        musicFiles.splice(index, 1);
                        savePlaylist();
                        loadPlaylist();
                    }
                }

                document.getElementById('audioPlayer').addEventListener('ended', function () {
                    if (!isLoop) playNext();
                });

                const audioEl = document.getElementById('audioPlayer');
                audioEl.addEventListener('play', () => {
                    const playImg = document.getElementById('playIconImg');
                    if (playImg) { playImg.src = 'pause.webp'; playImg.alt = '一時停止'; }
                });

                // 自動的に停止された (バックグラウンドや別アプリの影響) 場合は短時間後に再生を試みる
                audioEl.addEventListener('pause', () => {
                    const playImg = document.getElementById('playIconImg');
                    if (playImg) { playImg.src = 'play.webp'; playImg.alt = '再生'; }

                    // ユーザーが明示的に一時停止した場合は復帰しない
                    if (userInitiatedPause) return;

                    // ドキュメントが非表示(バックグラウンド)または iOS の取り扱いで一時停止された可能性がある
                    // 少し間をおいて再生を試みる(最大3回)
                    if (document.hidden || /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        const audio = document.getElementById('audioPlayer');
                        attemptPlay(audio, 3, 600).then(() => {
                            console.info('Resumed playback after unexpected pause');
                            updatePlayPauseUI(true);
                        }).catch((e) => {
                            console.warn('Could not resume playback automatically', e);
                        });
                    }
                });

                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const timeDisplay = document.getElementById('timeDisplay');
                const progressHandle = document.getElementById('progressHandle');
                const volumeBtn = document.getElementById('volumeBtn');
                const volumeBtnImg = document.getElementById('volumeBtnImg');
                const volumeSlider = document.getElementById('volumeSlider');

                function formatTimeShort(msOrSec) {
                    let totalSeconds = Math.floor(msOrSec);
                    if (msOrSec > 1000) totalSeconds = Math.floor(msOrSec / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${minutes}:${String(seconds).padStart(2, '0')}`;
                }

                audioEl.addEventListener('timeupdate', () => {
                    const cur = audioEl.currentTime;
                    const dur = audioEl.duration || 0;
                    const pct = dur ? (cur / dur) * 100 : 0;
                    if (progressBar) progressBar.style.width = `${pct}%`;
                    if (timeDisplay) timeDisplay.textContent = `${formatTimeShort(cur)} / ${formatTimeShort(dur)}`;
                });

                if (progressContainer) {
                    progressContainer.addEventListener('click', (e) => {
                        const rect = progressContainer.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const pct = Math.max(0, Math.min(1, x / rect.width));
                        if (audioEl.duration) audioEl.currentTime = pct * audioEl.duration;
                    });
                }

                if (volumeBtn) {
                    volumeBtn.addEventListener('click', () => {
                        if (volumeSlider.style.display === 'none') volumeSlider.style.display = 'block';
                        else volumeSlider.style.display = 'none';
                    });
                }
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => {
                        audioEl.volume = parseFloat(e.target.value);
                        if (audioEl.volume === 0) volumeBtnImg.src = 'volume_mute.webp';
                        else if (audioEl.volume < 0.5) volumeBtnImg.src = 'volume_low.webp';
                        else volumeBtnImg.src = 'volume.webp';
                    });
                }

                let currentTodoFilter = 'all';

                function addTodo() {
                    const input = document.getElementById('todoInput');
                    const text = input.value.trim();
                    if (!text) return;

                    const repeat = document.getElementById('todoRepeat').value;
                    const priority = document.getElementById('todoPriority').value;

                    // Ver.2: 期間設定を取得
                    const periodStart = document.getElementById('todoPeriodStart').value;
                    const periodEnd = document.getElementById('todoPeriodEnd').value;

                    let todos = getData('todos');
                    try {
                        todos = todos ? JSON.parse(todos) : [];
                        if (!Array.isArray(todos)) {
                            todos = [];
                            saveData('todos', JSON.stringify(todos));
                        }
                    } catch (e) {
                        console.error('Todo data corrupted, resetting:', e);
                        todos = [];
                        saveData('todos', JSON.stringify(todos));
                    }

                    const newTodo = {
                        text: text,
                        completed: false,
                        id: Date.now(),
                        repeat: repeat,
                        priority: priority,
                        createdAt: new Date().toISOString(),
                        // Ver.2: 段階的完了
                        completionStages: {
                            stage1: false,
                            stage2: false,
                            stage3: false
                        },
                        // Ver.2: 期間設定
                        period: {
                            start: periodStart || null,
                            end: periodEnd || null
                        }
                    };

                    if (repeat !== 'none') {
                        newTodo.lastCompleted = null;
                    }

                    todos.push(newTodo);
                    saveData('todos', JSON.stringify(todos));

                    input.value = '';
                    document.getElementById('todoRepeat').value = 'none';
                    document.getElementById('todoPriority').value = 'normal';
                    document.getElementById('todoPeriodStart').value = '';
                    document.getElementById('todoPeriodEnd').value = '';

                    loadTodos();
                }

                function loadTodos() {
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];
                    const todoV2Enabled = getData('todo_v2_enabled') === 'true';

                    const now = new Date();
                    const today = now.toDateString();

                    // Ver.2データ構造への互換性対応
                    todos.forEach(todo => {
                        // 既存データに段階的完了がない場合は追加
                        if (!todo.completionStages) {
                            todo.completionStages = { stage1: false, stage2: false, stage3: false };
                        }
                        // 期間設定がない場合は追加
                        if (!todo.period) {
                            todo.period = { start: null, end: null };
                        }

                        if (todo.repeat !== 'none' && todo.completed && todo.lastCompleted) {
                            const lastCompletedDate = new Date(todo.lastCompleted);
                            let shouldReset = false;

                            if (todo.repeat === 'daily') {
                                shouldReset = lastCompletedDate.toDateString() !== today;
                            } else if (todo.repeat === 'weekly') {
                                const daysDiff = Math.floor((now - lastCompletedDate) / (1000 * 60 * 60 * 24));
                                shouldReset = daysDiff >= 7;
                            } else if (todo.repeat === 'monthly') {
                                shouldReset = lastCompletedDate.getMonth() !== now.getMonth() ||
                                    lastCompletedDate.getFullYear() !== now.getFullYear();
                            }

                            if (shouldReset) {
                                todo.completed = false;
                            }
                        }
                    });

                    saveData('todos', JSON.stringify(todos));

                    let filteredTodos = todos;
                    if (currentTodoFilter === 'active') {
                        filteredTodos = todos.filter(todo => !todo.completed);
                    } else if (currentTodoFilter === 'completed') {
                        filteredTodos = todos.filter(todo => todo.completed);
                    } else if (currentTodoFilter === 'daily') {
                        filteredTodos = todos.filter(todo => todo.repeat === 'daily');
                    } else if (currentTodoFilter === 'weekly') {
                        filteredTodos = todos.filter(todo => todo.repeat === 'weekly');
                    }

                    filteredTodos.sort((a, b) => {
                        const priorityOrder = { high: 0, normal: 1, low: 2 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    });

                    const todosDiv = document.getElementById('todoItems');
                    if (filteredTodos.length === 0) {
                        todosDiv.innerHTML = `<div class="empty-state">${getText('noTasks')}</div>`;
                        return;
                    }

                    todosDiv.innerHTML = filteredTodos.map((todo) => {
                        const index = todos.findIndex(t => t.id === todo.id);
                        const repeatBadge = todo.repeat !== 'none' ?
                            `<span class="todo-repeat-badge">${getRepeatLabel(todo.repeat)}</span>` : '';

                        // Ver.2: 期間表示
                        let periodDisplay = '';
                        if (todoV2Enabled && todo.period && (todo.period.start || todo.period.end)) {
                            const startStr = todo.period.start || getText('notSet');
                            const endStr = todo.period.end || getText('notSet');
                            periodDisplay = `<div class="todo-period">${getText('periodLabel')}: ${startStr} ${getText('rangeSeparator')} ${endStr}</div>`;
                        }

                        // Ver.2: 段階的完了とプログレス表示の統合
                        let v2Details = '';
                        if (todoV2Enabled) {
                            const s1 = todo.completionStages.stage1 ? 'checked' : '';
                            const s2 = todo.completionStages.stage2 ? 'checked' : '';
                            const s3 = todo.completionStages.stage3 ? 'checked' : '';

                            // プログレスバー計算: 各段階25%
                            let progress = 0;
                            if (todo.completed) progress = 100;
                            else if (todo.completionStages.stage3) progress = 75;
                            else if (todo.completionStages.stage2) progress = 50;
                            else if (todo.completionStages.stage1) progress = 25;

                            v2Details = `
                                <div class="todo-v2-details">
                                    <div class="todo-stage-row">
                                        <p>${getText('sinchokudo')}</p><label class="todo-stage-label"><input type="checkbox" class="todo-stage-checkbox" ${s1} onchange="toggleTodoStage(${index}, 1)"></label>
                                        <label class="todo-stage-label"><input type="checkbox" class="todo-stage-checkbox" ${s2} onchange="toggleTodoStage(${index}, 2)"></label>
                                        <label class="todo-stage-label"><input type="checkbox" class="todo-stage-checkbox" ${s3} onchange="toggleTodoStage(${index}, 3)"></label>
                                    </div>
                                    <div class="todo-progress-container">
                                        <div class="todo-progress-bar">
                                            <div class="todo-progress-fill" style="width: ${progress}%;"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        return `
            <div class="todo-item todo-priority-${todo.priority} ${todo.completed ? 'completed' : ''}">
                <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${index})">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span class="todo-text">${todo.text}</span>
                        ${repeatBadge}
                    </div>
                    ${v2Details}
                    ${periodDisplay}
                </div>
                <button class="delete-btn" onclick="deleteTodo(${index})">${getText('deleteButton')}</button>
            </div>
        `;
                    }).join('');
                }

                function getRepeatLabel(repeat) {
                    const labels = {
                        'daily': getText('daily'),
                        'weekly': getText('weekly'),
                        'monthly': getText('monthly')
                    };
                    return labels[repeat] || '';
                }

                function getCategoryLabel(category) {
                    const labels = {
                        'study': getText('study'),
                        'work': getText('work'),
                        'personal': getText('personal'),
                        'shopping': getText('shopping'),
                        'health': getText('health'),
                        'other': getText('other')
                    };
                    return labels[category] || '';
                }

                function filterTodos(filter) {
                    currentTodoFilter = filter;

                    // ボタンのアクティブ状態を更新
                    document.querySelectorAll('.todo-filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

                    loadTodos();
                }

                function toggleTodo(index) {
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];
                    const newState = !todos[index].completed;
                    todos[index].completed = newState;

                    // 繰り返しタスクの場合、完了日を記録
                    if (todos[index].repeat !== 'none' && newState) {
                        todos[index].lastCompleted = new Date().toISOString();
                    }

                    // Ver.2: 全体完了時は全てのステージも同期する
                    if (getData('todo_v2_enabled') === 'true' && todos[index].completionStages) {
                        todos[index].completionStages.stage1 = newState;
                        todos[index].completionStages.stage2 = newState;
                        todos[index].completionStages.stage3 = newState;
                    }

                    saveData('todos', JSON.stringify(todos));
                    loadTodos();
                }

                async function deleteTodo(index) {
                    const confirmed = await customConfirm(getText('deleteTaskConfirm'), getText('deleteConfirmTitle'), 'delete.webp');
                    if (confirmed) {
                        let todos = getData('todos');
                        todos = todos ? JSON.parse(todos) : [];
                        todos.splice(index, 1);
                        saveData('todos', JSON.stringify(todos));
                        loadTodos();
                    }
                }

                // ToDo Ver.2 関数群

                // 段階的完了 - 一括チェック
                function toggleTodoStageAll(index) {
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    const newState = !todos[index].completed;
                    todos[index].completed = newState;

                    // 一括チェックの場合、全ステージも同期
                    if (newState) {
                        todos[index].completionStages.stage1 = true;
                        todos[index].completionStages.stage2 = true;
                        todos[index].completionStages.stage3 = true;
                    } else {
                        todos[index].completionStages.stage1 = false;
                        todos[index].completionStages.stage2 = false;
                        todos[index].completionStages.stage3 = false;
                    }

                    if (todos[index].repeat !== 'none' && newState) {
                        todos[index].lastCompleted = new Date().toISOString();
                    }

                    saveData('todos', JSON.stringify(todos));
                    loadTodos();
                }

                // 段階的完了 - 個別ステージ
                function toggleTodoStage(index, stage) {
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    const stageKey = `stage${stage}`;
                    const newState = !todos[index].completionStages[stageKey];
                    todos[index].completionStages[stageKey] = newState;

                    // ステージ3がチェックされたら全体完了
                    if (stage === 3 && newState) {
                        todos[index].completionStages.stage1 = true;
                        todos[index].completionStages.stage2 = true;
                        todos[index].completed = true;
                        if (todos[index].repeat !== 'none') {
                            todos[index].lastCompleted = new Date().toISOString();
                        }
                    }
                    // ステージ2がチェックされたらステージ1も
                    else if (stage === 2 && newState) {
                        todos[index].completionStages.stage1 = true;
                    }

                    // チェック解除時は完了状態も解除
                    if (!newState) {
                        todos[index].completed = false;
                        // より高いステージのチェックも外す
                        if (stage === 1) {
                            todos[index].completionStages.stage2 = false;
                            todos[index].completionStages.stage3 = false;
                        } else if (stage === 2) {
                            todos[index].completionStages.stage3 = false;
                        }
                    }

                    saveData('todos', JSON.stringify(todos));
                    loadTodos();
                }

                // ビュー切り替え
                let currentTodoView = 'list';

                function switchTodoView(view) {
                    currentTodoView = view;

                    const listView = document.getElementById('todoListView');
                    const calendarView = document.getElementById('todoCalendarView');
                    const listBtn = document.getElementById('todoViewList');
                    const calendarBtn = document.getElementById('todoViewCalendar');

                    if (view === 'list') {
                        listView.style.display = 'block';
                        calendarView.style.display = 'none';
                        listBtn.classList.add('active');
                        calendarBtn.classList.remove('active');
                    } else if (view === 'calendar') {
                        listView.style.display = 'none';
                        calendarView.style.display = 'block';
                        listBtn.classList.remove('active');
                        calendarBtn.classList.add('active');
                        renderCalendar(calendarYear, calendarMonth);
                    }
                }

                // カレンダービュー
                let calendarYear = new Date().getFullYear();
                let calendarMonth = new Date().getMonth();

                function changeCalendarMonth(delta) {
                    calendarMonth += delta;
                    if (calendarMonth > 11) {
                        calendarMonth = 0;
                        calendarYear++;
                    } else if (calendarMonth < 0) {
                        calendarMonth = 11;
                        calendarYear--;
                    }
                    renderCalendar(calendarYear, calendarMonth);
                }

                function renderCalendar(year, month) {
                    const monthYearDiv = document.getElementById('calendarMonthYear');
                    const gridDiv = document.getElementById('calendarGrid');

                    // 月年表示
                    monthYearDiv.textContent = `${year}${getText('year')}${month + 1}${getText('month')}`;

                    // カレンダーグリッド生成
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDay = firstDay.getDay(); // 0=日曜
                    const daysInMonth = lastDay.getDate();

                    // ToDoデータ取得
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    let html = '';

                    // 曜日ヘッダー
                    const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
                    dayHeaders.forEach(day => {
                        html += `<div class="calendar-day-header">${day}</div>`;
                    });

                    // 前月の日付(空白)
                    for (let i = 0; i < startDay; i++) {
                        html += `<div class="calendar-day other-month"></div>`;
                    }

                    // 当月の日付
                    const today = new Date();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentDate = new Date(year, month, day);
                        // ローカル日付を 'YYYY-MM-DD' 形式で生成(toISOString() はUTC変換で日付がずれる)
                        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        const isToday = currentDate.toDateString() === today.toDateString();

                        // この日付に関連するToDoを取得
                        const dayTodos = todos.filter(todo => {
                            if (!todo.period) return false;
                            // 保存された文字列をローカル日付として復元('YYYY-MM-DD' や ISO を扱う)
                            const start = todo.period.start ? parseLocalDate(todo.period.start) : null;
                            const end = todo.period.end ? parseLocalDate(todo.period.end) : null;

                            if (start && end) {
                                return currentDate >= start && currentDate <= end;
                            } else if (start) {
                                return currentDate.toDateString() === start.toDateString();
                            } else if (end) {
                                return currentDate.toDateString() === end.toDateString();
                            }
                            return false;
                        });

                        const hasTodos = dayTodos.length > 0;
                        const indicators = hasTodos ? `<div class="calendar-todo-badge">${dayTodos.length}</div>` : '';

                        const dayClasses = ['calendar-day'];
                        if (isToday) dayClasses.push('today');
                        if (hasTodos) dayClasses.push('has-todos');

                        html += `
                            <div class="${dayClasses.join(' ')}" onclick="openCalendarDayDialog(new Date(${year}, ${month}, ${day}))">
                                <div class="calendar-day-number">${day}</div>
                                <div class="calendar-todo-indicators">${indicators}</div>
                            </div>
                        `;
                    }

                    gridDiv.innerHTML = html;
                }

                // ToDo Ver.2 ポップアップ管理
                let todoV2PopupState = false;

                function showTodoV2Popup() {
                    // 既存データの有無を確認
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    // 新規ユーザー(ToDoが一つもない場合)は確認なしで自動的にV2をONにする
                    if (todos.length === 0 && getData('todo_v2_prompt_shown') !== 'true') {
                        saveData('todo_v2_enabled', 'true');
                        saveData('todo_v2_prompt_shown', 'true');
                        syncTodoV2UI();
                        return;
                    }

                    // 初回表示チェック(既存ユーザー向け)
                    if (getData('todo_v2_prompt_shown') === 'true') return;

                    const overlay = document.getElementById('todoV2PopupOverlay');
                    const toggle = document.getElementById('todoV2Toggle');

                    // デフォルトはOFF
                    const currentState = getData('todo_v2_enabled') === 'true';
                    if (currentState) {
                        toggle.classList.add('active');
                    }
                    todoV2PopupState = currentState;

                    overlay.classList.add('show');
                }

                function toggleTodoV2Popup() {
                    todoV2PopupState = !todoV2PopupState;
                    const toggle = document.getElementById('todoV2Toggle');
                    if (toggle) {
                        toggle.classList.toggle('active', todoV2PopupState);
                    }
                }

                function closeTodoV2Popup() {
                    const overlay = document.getElementById('todoV2PopupOverlay');
                    overlay.classList.remove('show');

                    // 設定を保存
                    saveData('todo_v2_enabled', todoV2PopupState ? 'true' : 'false');
                    saveData('todo_v2_prompt_shown', 'true');

                    // UI同期
                    syncTodoV2UI();

                    // ToDoをリロードしてVer.2を反映
                    loadTodos();
                }

                // カスタム日付ピッカー
                let currentDatePicker = null;  // 'start' or 'end'
                let selectedDate = { start: null, end: null };

                function openDatePicker(type) {
                    currentDatePicker = type;
                    const dropdown = document.getElementById('commonDatePicker');
                    const overlay = document.getElementById('datePickerOverlay');

                    // トグル表示
                    overlay.classList.add('show');
                    dropdown.classList.add('show');

                    // 開いたときは現在の月情報を1日に正規化しておく(例: 1月31日の状態から月移動で2月を表示した際の不整合を防ぐ)
                    if (!datePickerCurrentDate[type]) datePickerCurrentDate[type] = new Date();
                    datePickerCurrentDate[type] = new Date(datePickerCurrentDate[type].getFullYear(), datePickerCurrentDate[type].getMonth(), 1);
                    renderDatePicker(type, datePickerCurrentDate[type]);
                }

                function closeAllDatePickers() {
                    const dropdown = document.getElementById('commonDatePicker');
                    const overlay = document.getElementById('datePickerOverlay');
                    if (dropdown) dropdown.classList.remove('show');
                    if (overlay) overlay.classList.remove('show');
                }

                function renderDatePicker(type, date) {
                    const dropdown = document.getElementById('commonDatePicker');

                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDay = firstDay.getDay();
                    const daysInMonth = lastDay.getDate();

                    const today = new Date();
                    // selectedDate は 'YYYY-MM-DD' 文字列で保存されるため、UTC解釈を避けてローカル日付として復元する
                    const currentSelected = selectedDate[type]
                        ? (function () { const parts = selectedDate[type].split('-').map(Number); return new Date(parts[0], parts[1] - 1, parts[2]); })()
                        : null;

                    let html = `
                        <div class="date-picker-header">
                            <h3 style="margin: 0; font-size: 1rem;">${type === 'start' ? getText('selectStartDate') : getText('selectEndDate')}</h3>
                            <button type="button" class="secondary" onclick="closeAllDatePickers()" style="padding: 4px 10px; font-size: 0.8rem;">${getText('closeButton')}</button>
                        </div>
                        <div class="date-picker-month-selector" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <button class="secondary" onclick="changeDatePickerMonth(-1, '${type}')" type="button">◀</button>
                            <div class="date-picker-month-year" style="font-weight: 500;">${year}${getText('year')}${month + 1}${getText('month')}</div>
                            <button class="secondary" onclick="changeDatePickerMonth(1, '${type}')" type="button">▶</button>
                        </div>
                        <div class="date-picker-grid">
                    `;

                    // 曜日ヘッダー
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach(d => {
                        html += `<div class="date-picker-day-header">${getText('weekday_' + d)}</div>`;
                    });

                    // 空白セル
                    for (let i = 0; i < startDay; i++) {
                        html += `<div class="date-picker-day other-month"></div>`;
                    }

                    // 日付セル
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentDate = new Date(year, month, day);
                        // toISOString() は UTC に変換されて日付ズレを起こすため、ローカル日付を手動で組み立てる
                        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        const isToday = currentDate.toDateString() === today.toDateString();
                        const isSelected = currentSelected && currentDate.toDateString() === currentSelected.toDateString();

                        const classes = ['date-picker-day'];
                        if (isToday) classes.push('today');
                        if (isSelected) classes.push('selected');

                        html += `<div class="${classes.join(' ')}" onclick="selectDate('${type}', '${dateStr}')">${day}</div>`;
                    }

                    html += `</div>`;
                    dropdown.innerHTML = html;
                }

                let datePickerCurrentDate = { start: new Date(), end: new Date() };

                // 文字列からローカル日付を復元するヘルパー('YYYY-MM-DD' または ISO 全体を扱う)
                function parseLocalDate(dateStr) {
                    if (!dateStr) return null;
                    const dateOnly = String(dateStr).split('T')[0];
                    const parts = dateOnly.split('-').map(Number);
                    if (parts.length < 3 || parts.some(p => Number.isNaN(p))) return null;
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }

                function changeDatePickerMonth(delta, type) {
                    if (!datePickerCurrentDate[type]) datePickerCurrentDate[type] = new Date();
                    // 日付オーバーフローの副作用を避けるため、常に対象月の1日に切り替える
                    datePickerCurrentDate[type] = new Date(datePickerCurrentDate[type].getFullYear(), datePickerCurrentDate[type].getMonth() + delta, 1);
                    renderDatePicker(type, datePickerCurrentDate[type]);
                }

                function selectDate(type, dateStr) {
                    selectedDate[type] = dateStr;
                    const inputId = type === 'start' ? 'todoPeriodStart' : 'todoPeriodEnd';
                    document.getElementById(inputId).value = dateStr;

                    // ピッカーを閉じる
                    closeAllDatePickers();
                }

                // 外部クリックでピッカーを閉じる (現在はoverlayのonclickで対応しているが念のため)
                document.addEventListener('click', function (e) {
                    if (e.target.classList.contains('date-picker-overlay')) {
                        closeAllDatePickers();
                    }
                });

                // カレンダー日付クリックでダイアログ表示
                let currentCalendarDate = null;

                function openCalendarDayDialog(date) {
                    currentCalendarDate = date;
                    const dialog = document.getElementById('calendarDayDialog');
                    const titleDiv = document.getElementById('calendarDayDialogTitle');

                    // 日付フォーマット(言語対応)
                    titleDiv.textContent = `${date.getFullYear()}${getText('year')}${date.getMonth() + 1}${getText('month')}${date.getDate()}${getText('day')}`;

                    // その日のToDoを表示
                    renderCalendarDayTodos(date);

                    dialog.classList.add('show');
                }

                function closeCalendarDayDialog() {
                    const dialog = document.getElementById('calendarDayDialog');
                    dialog.classList.remove('show');
                    document.getElementById('calendarAddTodoInput').value = '';
                }

                function renderCalendarDayTodos(date) {
                    // ローカル日付を 'YYYY-MM-DD' 形式で生成(toISOString() はUTC変換で日付がずれる)
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    // その日に関連するToDoを取得
                    const dayTodos = todos.filter((todo, index) => {
                        todo._index = index;  // インデックスを保持
                        if (!todo.period) return false;
                        // 保存された文字列をローカル日付として復元して比較する
                        const start = todo.period.start ? parseLocalDate(todo.period.start) : null;
                        const end = todo.period.end ? parseLocalDate(todo.period.end) : null;

                        if (start && end) {
                            return date >= start && date <= end;
                        } else if (start) {
                            return date.toDateString() === start.toDateString();
                        } else if (end) {
                            return date.toDateString() === end.toDateString();
                        }
                        return false;
                    });

                    const todosDiv = document.getElementById('calendarDayTodos');

                    if (dayTodos.length === 0) {
                        todosDiv.innerHTML = `<div style="opacity: 0.7; text-align: center; padding: 20px;">${getText('noTodosOnThisDay')}</div>`;
                    } else {
                        const todoV2Enabled = getData('todo_v2_enabled') === 'true';

                        todosDiv.innerHTML = dayTodos.map(todo => {
                            const index = todo._index;
                            const completedClass = todo.completed ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';

                            return `
                                <div class="calendar-day-todo-item">
                                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodoFromCalendar(${index})">
                                    <div style="flex: 1;" ${completedClass}>${todo.text}</div>
                                    <button class="delete-btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteTodoFromCalendar(${index})">${getText('deleteButton')}</button>
                                </div>
                            `;
                        }).join('');
                    }
                }

                function addTodoFromCalendar() {
                    const input = document.getElementById('calendarAddTodoInput');
                    const text = input.value.trim();
                    if (!text || !currentCalendarDate) return;

                    const dateStr = `${currentCalendarDate.getFullYear()}-${String(currentCalendarDate.getMonth() + 1).padStart(2, '0')}-${String(currentCalendarDate.getDate()).padStart(2, '0')}`;

                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];

                    const newTodo = {
                        text: text,
                        completed: false,
                        id: Date.now(),
                        repeat: 'none',
                        priority: 'normal',
                        createdAt: new Date().toISOString(),
                        completionStages: {
                            stage1: false,
                            stage2: false,
                            stage3: false
                        },
                        period: {
                            start: dateStr,
                            end: dateStr
                        }
                    };

                    todos.push(newTodo);
                    saveData('todos', JSON.stringify(todos));

                    input.value = '';
                    renderCalendarDayTodos(currentCalendarDate);
                    renderCalendar(calendarYear, calendarMonth);
                    loadTodos();
                }

                function toggleTodoFromCalendar(index) {
                    let todos = getData('todos');
                    todos = todos ? JSON.parse(todos) : [];
                    todos[index].completed = !todos[index].completed;

                    if (todos[index].repeat !== 'none' && todos[index].completed) {
                        todos[index].lastCompleted = new Date().toISOString();
                    }

                    saveData('todos', JSON.stringify(todos));
                    renderCalendarDayTodos(currentCalendarDate);
                    renderCalendar(calendarYear, calendarMonth);
                    loadTodos();
                }

                async function deleteTodoFromCalendar(index) {
                    const confirmed = await customConfirm(getText('deleteTaskConfirm'), getText('confirmDelete'), 'delete.webp');
                    if (confirmed) {
                        let todos = getData('todos');
                        todos = todos ? JSON.parse(todos) : [];
                        todos.splice(index, 1);
                        saveData('todos', JSON.stringify(todos));
                        renderCalendarDayTodos(currentCalendarDate);
                        renderCalendar(calendarYear, calendarMonth);
                        loadTodos();
                    }
                }

                // 設定からのVer.2切り替え
                function toggleTodoV2Setting() {
                    const currentState = getData('todo_v2_enabled') === 'true';
                    const newState = !currentState;

                    saveData('todo_v2_enabled', newState ? 'true' : 'false');

                    syncTodoV2UI();
                    loadTodos();
                }

                // UI同期関数
                function syncTodoV2UI() {
                    const todoV2Enabled = getData('todo_v2_enabled') === 'true';
                    const settingsToggle = document.getElementById('toggleTodoV2');
                    const popupToggle = document.getElementById('todoV2Toggle');

                    if (settingsToggle) settingsToggle.classList.toggle('active', todoV2Enabled);
                    if (popupToggle) popupToggle.classList.toggle('active', todoV2Enabled);

                    updatePeriodSettingsVisibility();
                }

                function updatePeriodSettingsVisibility() {
                    const todoV2Enabled = getData('todo_v2_enabled') === 'true';
                    const periodSettings = document.getElementById('todoPeriodSettings');

                    if (periodSettings) {
                        periodSettings.style.display = todoV2Enabled ? 'flex' : 'none';
                    }
                }

                function loadHistory() {
                    const historyList = document.getElementById('historyList');
                    const searchInput = document.getElementById('searchInput');
                    const groupFilter = document.getElementById('groupFilter');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const selectedGroup = groupFilter ? groupFilter.value : '';
                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    allHistoryItems = [...history];
                    if (selectedGroup) history = history.filter(item => item.group === selectedGroup);
                    if (searchTerm) {
                        history = history.filter(item => {
                            const start = new Date(item.start);
                            const end = new Date(item.end);
                            const dateStr = formatDate(start).toLowerCase();
                            const startTimeStr = formatDateTime(start).toLowerCase();
                            const endTimeStr = formatDateTime(end).toLowerCase();
                            return dateStr.includes(searchTerm) || startTimeStr.includes(searchTerm) || endTimeStr.includes(searchTerm);
                        });
                    }
                    // ソート処理
                    if (currentSort === 'date-desc') {
                        history.sort((a, b) => new Date(b.start) - new Date(a.start));
                    } else if (currentSort === 'date-asc') {
                        history.sort((a, b) => new Date(a.start) - new Date(b.start));
                    } else if (currentSort === 'duration-desc') {
                        history.sort((a, b) => b.duration - a.duration);
                    } else if (currentSort === 'duration-asc') {
                        history.sort((a, b) => a.duration - b.duration);
                    }
                    if (history.length === 0) {
                        historyList.innerHTML = `<div class="empty-state">${getText('noHistory')}</div>`;
                        updateActionButtons();
                        return;
                    }
                    historyList.innerHTML = history.map((item, index) => {
                        const actualIndex = allHistoryItems.findIndex(h => h.start === item.start && h.end === item.end && h.duration === item.duration);
                        const start = new Date(item.start);
                        const end = new Date(item.end);
                        const groupBadge = item.group ? `<div class="group-badge">${item.group}</div>` : '';
                        const isSelected = selectedItems.has(actualIndex);
                        const dateDisplay = (formatDate(start) === formatDate(end)) ? formatDate(start) : `${formatDate(start)}<br><small>→ ${formatDate(end)}</small>`;
                        const startDisplay = formatDateTime(start);
                        const endDisplay = formatDateTime(end);
                        return `<div class="history-item ${isSelected ? 'selected' : ''}" onclick="toggleSelection(event, ${actualIndex})"><input type="checkbox" class="history-item-checkbox" ${isSelected ? 'checked' : ''} onclick="toggleSelection(event, ${actualIndex})"><div class="history-item-date">${dateDisplay}</div><div class="history-item-time">${getText('start')}: ${startDisplay}<br>${getText('end')}: ${endDisplay}</div><div class="history-item-duration">${getText('studyTime')}: ${formatTime(item.duration)}</div>${groupBadge}</div>`;
                    }).join('');
                    updateActionButtons();
                }

                let currentSort = 'date-desc'; // デフォルトは新しい順

                function sortHistory(sortType) {
                    currentSort = sortType;
                    const buttons = document.querySelectorAll('[data-sort]');
                    buttons.forEach(btn => {
                        if (btn.getAttribute('data-sort') === sortType) btn.classList.add('active');
                        else btn.classList.remove('active');
                    });
                    loadHistory();
                }

                function toggleSelection(event, index) {
                    event.stopPropagation();
                    if (selectedItems.has(index)) selectedItems.delete(index);
                    else selectedItems.add(index);
                    loadHistory();
                }

                function toggleSelectAll() {
                    const searchInput = document.getElementById('searchInput');
                    const groupFilter = document.getElementById('groupFilter');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const selectedGroup = groupFilter ? groupFilter.value : '';
                    let history = [...allHistoryItems];
                    if (selectedGroup) history = history.filter(item => item.group === selectedGroup);
                    if (searchTerm) {
                        history = history.filter(item => {
                            const start = new Date(item.start);
                            const end = new Date(item.end);
                            const dateStr = formatDate(start).toLowerCase();
                            const startTimeStr = formatDateTime(start).toLowerCase();
                            const endTimeStr = formatDateTime(end).toLowerCase();
                            return dateStr.includes(searchTerm) || startTimeStr.includes(searchTerm) || endTimeStr.includes(searchTerm);
                        });
                    }
                    const visibleIndices = history.map(item => allHistoryItems.findIndex(h => h.start === item.start && h.end === item.end && h.duration === item.duration));
                    const allSelected = visibleIndices.every(i => selectedItems.has(i));
                    if (allSelected) visibleIndices.forEach(i => selectedItems.delete(i));
                    else visibleIndices.forEach(i => selectedItems.add(i));
                    loadHistory();
                }

                function updateActionButtons() {
                    const moveContainer = document.getElementById('moveGroupContainer');
                    const deleteBtn = document.getElementById('deleteBtn');
                    const hasSelection = selectedItems.size > 0;
                    if (moveContainer) {
                        if (hasSelection) moveContainer.classList.add('active');
                        else moveContainer.classList.remove('active');
                    }
                    if (deleteBtn) deleteBtn.disabled = !hasSelection;
                    const moveCount = document.getElementById('moveCount');
                    if (moveCount) moveCount.textContent = hasSelection ? `${selectedItems.size}${getText('itemsToMove')}` : '';
                }

                async function deleteSelected() {
                    if (selectedItems.size === 0) return;
                    const confirmed = await customConfirm(getText('deleteSelectedConfirm').replace('{n}', selectedItems.size), getText('deleteConfirmTitle'), 'delete.webp');
                    if (confirmed) {
                        let history = getData('studyHistory');
                        history = history ? JSON.parse(history) : [];
                        const indicesToDelete = Array.from(selectedItems).sort((a, b) => b - a);
                        indicesToDelete.forEach(index => { history.splice(index, 1); });
                        saveData('studyHistory', JSON.stringify(history));
                        selectedItems.clear();
                        updateGroupFilter();
                        loadHistory();
                    }
                }

                function hideMoveGroup() {
                    selectedItems.clear();
                    const sel = document.getElementById('moveGroupSelect');
                    if (sel) sel.selectedIndex = 0;
                    const moveCount = document.getElementById('moveCount');
                    if (moveCount) moveCount.textContent = '';
                    loadHistory();
                }

                function moveSelectedToGroup() {
                    const sel = document.getElementById('moveGroupSelect');
                    const newGroup = sel ? sel.value.trim() : '';
                    if (selectedItems.size === 0) return;
                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    Array.from(selectedItems).forEach(index => {
                        if (history[index]) history[index].group = newGroup;
                    });
                    saveData('studyHistory', JSON.stringify(history));
                    selectedItems.clear();
                    if (sel) sel.selectedIndex = 0;
                    updateGroupFilter();
                    loadHistory();
                }

                function updateGroupFilter() {
                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    const groups = [...new Set(history.map(item => item.group).filter(g => g))];
                    const groupFilter = document.getElementById('groupFilter');
                    groupFilter.innerHTML = `<option value="">${getText('allGroupsFilter')}</option>`;
                    groups.forEach(group => {
                        groupFilter.innerHTML += `<option value="${group}">${group}</option>`;
                    });
                    // populate move target select as well
                    const moveSel = document.getElementById('moveGroupSelect');
                    if (moveSel) {
                        const prev = moveSel.value;
                        moveSel.innerHTML = `<option value="">${getText('selectDestinationGroup')}</option>`;
                        groups.forEach(group => {
                            moveSel.innerHTML += `<option value="${group}">${group}</option>`;
                        });
                        try { moveSel.value = prev; } catch (e) { }
                    }
                }

                function calculateStreak() {
                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    if (history.length === 0) return 0;
                    const dates = [...new Set(history.map(item => {
                        const date = new Date(item.start);
                        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    }))].sort().reverse();
                    let streak = 0;
                    const today = new Date();
                    for (let i = 0; i < dates.length; i++) {
                        const expectedDate = new Date(today);
                        expectedDate.setDate(today.getDate() - i);
                        const expectedStr = `${expectedDate.getFullYear()}-${String(expectedDate.getMonth() + 1).padStart(2, '0')}-${String(expectedDate.getDate()).padStart(2, '0')}`;
                        if (dates[i] === expectedStr) streak++;
                        else break;
                    }
                    return streak;
                }

                function loadStats() {
                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    const totalTime = history.reduce((sum, item) => sum + item.duration, 0);
                    const streak = calculateStreak();
                    const totalSessions = history.length;
                    const statsContainer = document.getElementById('statsContainer');
                    statsContainer.innerHTML = `<div class="stat-card"><div class="stat-label">${getText('totalTime')}</div><div class="stat-value">${formatTime(totalTime)}</div></div><div class="stat-card"><div class="stat-label">${getText('consecutiveDays')}</div><div class="stat-value">${streak}${getText('days')}</div></div><div class="stat-card"><div class="stat-label">${getText('totalSessions')}</div><div class="stat-value">${totalSessions}</div></div>`;
                    const groups = {};
                    history.forEach(item => {
                        const group = item.group || getText('uncategorized');
                        if (!groups[group]) groups[group] = 0;
                        groups[group] += item.duration;
                    });
                    const groupStatsSelector = document.getElementById('groupStatsSelector');
                    const groupStats = document.getElementById('groupStats');
                    if (Object.keys(groups).length > 0) {
                        groupStatsSelector.innerHTML = `<h2>${getText('groupStats')}</h2>`;
                        groupStats.innerHTML = Object.entries(groups).sort((a, b) => b[1] - a[1]).map(([group, duration]) => `<div class="stat-card" style="margin-bottom: 15px;"><div class="stat-label">${group}</div><div class="stat-value">${formatTime(duration)}</div></div>`).join('');
                    }
                }

                async function clearHistory() {
                    const confirmed = await customConfirm(getText('clearHistoryConfirm'), getText('clearAllConfirmTitle'), 'warning.webp');
                    if (confirmed) {
                        saveData('studyHistory', JSON.stringify([]));
                        selectedItems.clear();
                        loadHistory();
                    }
                }

                function exportData() {
                    const data = {
                        version: 1,
                        exportedAt: new Date().toISOString(),
                        studyHistory: JSON.parse(getData('studyHistory') || '[]'),
                        todos: JSON.parse(getData('todos') || '[]'),
                        theme: getData('theme') || 'blue',
                        mode: getData('mode') || 'light',
                        feature_music: getData('feature_music') || 'false',
                        feature_todo: getData('feature_todo') || 'false',
                        focus_mode_enabled: getData('focus_mode_enabled') || 'false',
                    };

                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `studytime_backup_${new Date().getTime()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                function importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            // バージョン確認
                            if (!data.version) throw new Error(getText('invalidFileFormat'));

                            // 確認ダイアログを表示
                            const confirmed = await customConfirm(
                                getText('importConfirm').replace('{historyCount}', data.studyHistory?.length || 0).replace('{todoCount}', data.todos?.length || 0),
                                getText('importDataTitle'),
                                'warning.webp'
                            );

                            if (confirmed) {
                                // データを復元
                                if (data.studyHistory) saveData('studyHistory', JSON.stringify(data.studyHistory));
                                if (data.todos) saveData('todos', JSON.stringify(data.todos));
                                if (data.theme) {
                                    saveData('theme', data.theme);
                                    changeTheme(data.theme);
                                }
                                if (data.mode) {
                                    saveData('mode', data.mode);
                                    if (data.mode === 'dark') {
                                        document.body.classList.remove('light');
                                        document.body.classList.add('dark');
                                    } else {
                                        document.body.classList.remove('dark');
                                        document.body.classList.add('light');
                                    }
                                    const themeIcon = document.getElementById('themeIcon');
                                    if (themeIcon) themeIcon.src = data.mode === 'dark' ? 'sun.webp' : 'moon.webp';
                                }
                                if (typeof data.focus_mode_enabled !== 'undefined') {
                                    saveData('focus_mode_enabled', data.focus_mode_enabled);
                                }
                                // break_time_accum and focus_cycle_base are no longer needed (stateless computation)

                                // 表示設定を復元
                                if (data.feature_music !== undefined) {
                                    saveData('feature_music', data.feature_music);
                                    const toggle = document.getElementById('toggleMusic');
                                    if (data.feature_music === 'true') {
                                        toggle.classList.add('active');
                                        addMenuButton('music');
                                    } else {
                                        toggle.classList.remove('active');
                                        removeMenuButton('music');
                                    }
                                }
                                if (data.feature_todo !== undefined) {
                                    saveData('feature_todo', data.feature_todo);
                                    const toggle = document.getElementById('toggleTodo');
                                    if (data.feature_todo === 'true') {
                                        toggle.classList.add('active');
                                        addMenuButton('todo');
                                    } else {
                                        toggle.classList.remove('active');
                                        removeMenuButton('todo');
                                    }
                                }

                                // 履歴をリロード
                                if (document.getElementById('historyList')) loadHistory();
                                if (document.getElementById('todoItems')) loadTodos();
                                if (document.getElementById('statsContainer')) loadStats();
                            }
                        } catch (error) {
                            await customConfirm(`${getText('importFailed')}: ${error.message}`, getText('errorTitle'), 'warning.webp');
                        }
                    };
                    reader.readAsText(file);

                    // ファイル選択をリセット
                    event.target.value = '';
                }

                // チュートリアル関連
                let currentTutorialStep = 0;
                const tutorialSteps = [
                    {
                        titleKey: 'tutorialStartTitle',
                        messageKey: 'tutorialStartMessage',
                        target: '#startBtn',
                        position: 'top',
                        action: 'click',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialTimerStartedTitle',
                        messageKey: 'tutorialTimerStartedMessage',
                        target: '#timer',
                        position: 'bottom',
                        action: 'view',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialPauseTitle',
                        messageKey: 'tutorialPauseMessage',
                        target: '#pauseBtn',
                        position: 'top',
                        action: 'click',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialPausedTitle',
                        messageKey: 'tutorialPausedMessage',
                        target: '#pauseBtn',
                        position: 'top',
                        action: 'view',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialEndTitle',
                        messageKey: 'tutorialEndMessage',
                        target: '#endBtn',
                        position: 'top',
                        action: 'click',
                        page: 'timer'
                    },
                    {
                        titleKey: 'focusMode',
                        messageKey: 'tutorialFocusModeMessage',
                        target: '#focusModeToggleContainer',
                        position: 'bottom',
                        action: 'view',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialGroupTitle',
                        messageKey: 'tutorialGroupMessage',
                        target: '#groupInput',
                        position: 'top',
                        action: 'view',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialStatsTitle',
                        messageKey: 'tutorialStatsMessage',
                        target: '.menu button:nth-child(2)',
                        position: 'bottom',
                        action: 'click',
                        page: 'timer'
                    },
                    {
                        titleKey: 'tutorialHistoryTitle',
                        messageKey: 'tutorialHistoryMessage',
                        target: '.menu button:nth-child(3)',
                        position: 'bottom',
                        action: 'click',
                        page: 'stats'
                    },
                    {
                        titleKey: 'tutorialDarkModeTitle',
                        messageKey: 'tutorialDarkModeMessage',
                        target: '.theme-toggle',
                        position: 'left',
                        action: 'click',
                        page: 'list'
                    },
                    {
                        titleKey: 'tutorialSettingsTitle',
                        messageKey: 'tutorialSettingsMessage',
                        target: '.settings-btn',
                        position: 'left',
                        action: 'click',
                        page: 'list'
                    },
                    {
                        titleKey: 'tutorialDisplaySettingsTitle',
                        messageKey: 'tutorialDisplaySettingsMessage',
                        target: '.settings-section:nth-child(1)',
                        position: 'bottom',
                        action: 'view',
                        page: 'settings'
                    },
                    {
                        titleKey: 'tutorialThemeColorTitle',
                        messageKey: 'tutorialThemeColorMessage',
                        target: '.theme-selector',
                        position: 'top',
                        action: 'view',
                        page: 'settings'
                    },
                    {
                        titleKey: 'tutorialGraphDisplayTitle',
                        messageKey: 'tutorialGraphDisplayMessage',
                        target: '.settings-section:nth-child(3)',
                        position: 'top',
                        action: 'view',
                        page: 'settings'
                    },
                    {
                        titleKey: 'tutorialDataManagementTitle',
                        messageKey: 'tutorialDataManagementMessage',
                        target: '.settings-section:nth-child(4)',
                        position: 'top',
                        action: 'view',
                        page: 'settings'
                    },
                    {
                        titleKey: 'tutorialCompletedTitle',
                        messageKey: 'tutorialCompletedMessage',
                        target: null,
                        position: 'center',
                        action: 'finish',
                        page: 'settings'
                    }
                ];

                function showTutorialWelcome() {
                    const completed = getData('tutorial_completed') === 'true';
                    if (!completed) {
                        document.getElementById('tutorialWelcome').style.display = 'block';
                    }
                }

                function closeTutorial() {
                    document.getElementById('tutorialWelcome').style.display = 'none';
                    saveData('tutorial_completed', 'true');
                }

                function startTutorial() {
                    document.getElementById('tutorialWelcome').style.display = 'none';
                    currentTutorialStep = 0;
                    showTutorialStep();
                }

                function restartTutorial() {
                    currentTutorialStep = 0;
                    showPage('timer');
                    setTimeout(() => {
                        showTutorialStep();
                    }, 300);
                }

                function skipTutorial() {
                    hideTutorialStep();
                    saveData('tutorial_completed', 'true');
                }

                function nextTutorialStep() {
                    const step = tutorialSteps[currentTutorialStep];

                    if (step.action === 'click') {
                        return;
                    }

                    if (currentTutorialStep < tutorialSteps.length - 1) {
                        currentTutorialStep++;
                        showTutorialStep();
                    } else {
                        hideTutorialStep();
                        saveData('tutorial_completed', 'true');
                    }
                }

                function prevTutorialStep() {
                    if (currentTutorialStep > 0) {
                        currentTutorialStep--;
                        // 戻る時は必要なページに戻る
                        const prevStep = tutorialSteps[currentTutorialStep];
                        if (prevStep.page) {
                            showPage(prevStep.page);
                        }
                        setTimeout(() => {
                            showTutorialStep();
                        }, 300);
                    }
                }

                function showTutorialStep() {
                    const step = tutorialSteps[currentTutorialStep];
                    const overlay = document.getElementById('tutorialOverlay');
                    const box = document.getElementById('tutorialBox');
                    const arrow = document.getElementById('tutorialArrow');

                    // ページ切替が必要な場合
                    if (step.page) {
                        const pages = { 'timer': 'timerPage', 'stats': 'statsPage', 'list': 'listPage', 'settings': 'settingsPage' };
                        const currentActivePage = document.querySelector('.page.active');
                        const targetPageId = pages[step.page];

                        if (currentActivePage && currentActivePage.id !== targetPageId) {
                            showPage(step.page);
                            // ページ切替後に少し待つ
                            setTimeout(() => {
                                continueShowingStep();
                            }, 400);
                            return;
                        }
                    }

                    continueShowingStep();

                    function continueShowingStep() {
                        // 完了画面の場合
                        if (step.action === 'finish') {
                            overlay.classList.add('show');
                            box.style.display = 'block';
                            arrow.style.display = 'none';

                            document.getElementById('tutorialStepInfo').textContent = '';
                            document.getElementById('tutorialStepInfo').textContent = '';
                            document.getElementById('tutorialTitle').textContent = getText(step.titleKey);
                            document.getElementById('tutorialMessage').textContent = getText(step.messageKey);

                            const prevBtn = document.getElementById('tutorialPrevBtn');
                            const nextBtn = document.getElementById('tutorialNextBtn');
                            prevBtn.style.display = 'block';
                            prevBtn.textContent = getText('backButton');
                            prevBtn.onclick = prevTutorialStep;
                            nextBtn.style.display = 'block';
                            nextBtn.textContent = getText('finishButton');
                            nextBtn.onclick = () => {
                                hideTutorialStep();
                                saveData('tutorial_completed', 'true');
                            };

                            // 画面中央に配置
                            box.style.left = '50%';
                            box.style.top = '50%';
                            box.style.transform = 'translate(-50%, -50%)';
                            box.style.bottom = 'auto';

                            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                                el.classList.remove('tutorial-highlight');
                            });

                            const clickArea = document.getElementById('tutorialClickArea');
                            if (clickArea) clickArea.remove();

                            return;
                        }

                        const target = document.querySelector(step.target);

                        if (!target) {
                            nextTutorialStep();
                            return;
                        }

                        // ターゲットが表示されるまで待つ
                        const targetVisible = target.offsetParent !== null;
                        if (!targetVisible) {
                            setTimeout(() => {
                                showTutorialStep();
                            }, 200);
                            return;
                        }

                        overlay.classList.add('show');
                        box.style.display = 'block';

                        document.getElementById('tutorialStepInfo').textContent = `${getText('step')} ${currentTutorialStep + 1}/${tutorialSteps.length}`;
                        document.getElementById('tutorialTitle').textContent = getText(step.titleKey);
                        document.getElementById('tutorialMessage').textContent = getText(step.messageKey);

                        const prevBtn = document.getElementById('tutorialPrevBtn');
                        const nextBtn = document.getElementById('tutorialNextBtn');
                        prevBtn.style.display = currentTutorialStep === 0 ? 'none' : 'block';
                        prevBtn.textContent = getText('backButton');
                        prevBtn.onclick = prevTutorialStep;

                        if (step.action === 'click') {
                            nextBtn.style.display = 'none';
                        } else {
                            nextBtn.style.display = 'block';
                            nextBtn.textContent = getText('nextButton');
                            nextBtn.onclick = nextTutorialStep;
                        }

                        document.querySelectorAll('.tutorial-highlight').forEach(el => {
                            el.classList.remove('tutorial-highlight');
                        });
                        target.classList.add('tutorial-highlight');

                        // クリック可能エリアを作成
                        const existingClickArea = document.getElementById('tutorialClickArea');
                        if (existingClickArea) existingClickArea.remove();

                        if (step.action === 'click') {
                            const clickArea = document.createElement('div');
                            clickArea.id = 'tutorialClickArea';
                            clickArea.className = 'tutorial-click-area';

                            setTimeout(() => {
                                const targetRect = target.getBoundingClientRect();
                                clickArea.style.left = targetRect.left + 'px';
                                clickArea.style.top = targetRect.top + 'px';
                                clickArea.style.width = targetRect.width + 'px';
                                clickArea.style.height = targetRect.height + 'px';
                            }, 50);

                            clickArea.onclick = () => {
                                target.click();
                                setTimeout(() => {
                                    if (currentTutorialStep < tutorialSteps.length - 1) {
                                        currentTutorialStep++;
                                        showTutorialStep();
                                    } else {
                                        hideTutorialStep();
                                        saveData('tutorial_completed', 'true');
                                    }
                                }, 300);
                            };
                            document.body.appendChild(clickArea);
                        }

                        // 位置計算
                        setTimeout(() => {
                            const targetRect = target.getBoundingClientRect();
                            const boxWidth = Math.min(400, window.innerWidth - 40);
                            const boxPadding = 20;

                            arrow.className = 'tutorial-arrow';
                            box.style.transform = 'none';

                            if (step.position === 'top') {
                                const leftPos = Math.max(boxPadding, Math.min(window.innerWidth - boxWidth - boxPadding, targetRect.left + targetRect.width / 2 - boxWidth / 2));
                                box.style.left = leftPos + 'px';
                                box.style.top = Math.max(boxPadding, targetRect.top - 20) + 'px';
                                box.style.bottom = 'auto';
                                box.style.transform = 'translateY(-100%)';

                                arrow.classList.add('tutorial-arrow-down');
                                arrow.style.left = (targetRect.left + targetRect.width / 2 - 10) + 'px';
                                arrow.style.top = (targetRect.top - 10) + 'px';
                                arrow.style.display = 'block';
                            } else if (step.position === 'bottom') {
                                const leftPos = Math.max(boxPadding, Math.min(window.innerWidth - boxWidth - boxPadding, targetRect.left + targetRect.width / 2 - boxWidth / 2));
                                box.style.left = leftPos + 'px';
                                box.style.top = (targetRect.bottom + 20) + 'px';
                                box.style.bottom = 'auto';
                                box.style.transform = 'none';

                                arrow.classList.add('tutorial-arrow-up');
                                arrow.style.left = (targetRect.left + targetRect.width / 2 - 10) + 'px';
                                arrow.style.top = (targetRect.bottom + 10) + 'px';
                                arrow.style.display = 'block';
                            } else if (step.position === 'left') {
                                // スマホでは左配置は使いにくいので下に変更
                                if (window.innerWidth <= 768) {
                                    const leftPos = Math.max(boxPadding, Math.min(window.innerWidth - boxWidth - boxPadding, targetRect.left + targetRect.width / 2 - boxWidth / 2));
                                    box.style.left = leftPos + 'px';
                                    box.style.top = (targetRect.bottom + 20) + 'px';
                                    box.style.bottom = 'auto';
                                    box.style.transform = 'none';

                                    arrow.classList.add('tutorial-arrow-up');
                                    arrow.style.left = (targetRect.left + targetRect.width / 2 - 10) + 'px';
                                    arrow.style.top = (targetRect.bottom + 10) + 'px';
                                    arrow.style.display = 'block';
                                } else {
                                    box.style.left = Math.max(boxPadding, targetRect.left - boxWidth - 20) + 'px';
                                    box.style.top = Math.max(boxPadding, targetRect.top + targetRect.height / 2 - 100) + 'px';
                                    box.style.bottom = 'auto';
                                    box.style.transform = 'none';

                                    arrow.classList.add('tutorial-arrow-right');
                                    arrow.style.left = (targetRect.left - 10) + 'px';
                                    arrow.style.top = (targetRect.top + targetRect.height / 2 - 10) + 'px';
                                    arrow.style.display = 'block';
                                }
                            } else if (step.position === 'right') {
                                box.style.left = Math.min(window.innerWidth - boxWidth - boxPadding, targetRect.right + 20) + 'px';
                                box.style.top = Math.max(boxPadding, targetRect.top + targetRect.height / 2 - 100) + 'px';
                                box.style.bottom = 'auto';
                                box.style.transform = 'none';

                                arrow.classList.add('tutorial-arrow-left');
                                arrow.style.left = (targetRect.right + 10) + 'px';
                                arrow.style.top = (targetRect.top + targetRect.height / 2 - 10) + 'px';
                                arrow.style.display = 'block';
                            }

                            // 画面外チェック
                            setTimeout(() => {
                                const boxRect = box.getBoundingClientRect();
                                if (boxRect.bottom > window.innerHeight - 20) {
                                    const newTop = window.innerHeight - boxRect.height - 20;
                                    box.style.top = newTop + 'px';
                                    if (step.position === 'top') {
                                        box.style.transform = 'none';
                                    }
                                }
                                if (boxRect.right > window.innerWidth - 20) {
                                    box.style.left = (window.innerWidth - boxRect.width - 20) + 'px';
                                }
                                if (boxRect.left < 20) {
                                    box.style.left = '20px';
                                }
                            }, 10);
                        }, 150);
                    }
                }

                function hideTutorialStep() {
                    document.getElementById('tutorialOverlay').classList.remove('show');
                    document.getElementById('tutorialBox').style.display = 'none';
                    document.getElementById('tutorialArrow').style.display = 'none';
                    document.querySelectorAll('.tutorial-highlight').forEach(el => {
                        el.classList.remove('tutorial-highlight');
                    });
                    const clickArea = document.getElementById('tutorialClickArea');
                    if (clickArea) clickArea.remove();
                }

                document.getElementById('tutorialOverlay').addEventListener('click', skipTutorial);

                function showLicenseModal() {
                    const overlay = document.getElementById('licenseOverlay');
                    overlay.classList.add('show');
                    overlay.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('no-scroll');
                    const okBtn = document.getElementById('licenseOkBtn');
                    try { if (okBtn) okBtn.focus(); } catch (e) {}
                }

                function hideLicenseModal() {
                    const overlay = document.getElementById('licenseOverlay');
                    overlay.classList.remove('show');
                    overlay.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('no-scroll');
                }

                document.getElementById('licenseOkBtn').addEventListener('click', hideLicenseModal);
                document.getElementById('licenseOverlay').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) hideLicenseModal();
                });

                function saveFontSettings() {
                    const fontJa = document.getElementById('fontJaSelect').value;
                    const fontEn = document.getElementById('fontEnSelect').value;

                    saveData('font_ja', fontJa);
                    saveData('font_en', fontEn);

                    applyFonts();
                }

                function applyFonts() {
                    const fontJa = getData('font_ja') || 'Zen Kaku Gothic Antique';
                    const fontEn = getData('font_en') || '';

                    document.documentElement.style.setProperty('--font-ja', `'${fontJa}'`);
                    document.documentElement.style.setProperty('--font-en', fontEn ? `'${fontEn}'` : '');

                    const jaSelect = document.getElementById('fontJaSelect');
                    const enSelect = document.getElementById('fontEnSelect');
                    if (jaSelect) jaSelect.value = fontJa;
                    if (enSelect) enSelect.value = fontEn;
                }

                function finishLoading() {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        const showAnim = getData('feature_loading_anim') !== 'false';
                        if (!showAnim) {
                            overlay.style.display = 'none';
                            overlay.remove();
                            return;
                        }
                        const primaryHover = getComputedStyle(document.body).getPropertyValue('--primary-hover');
                        if (primaryHover) {
                            overlay.style.backgroundColor = primaryHover.trim();
                        }
                        overlay.classList.add('wipe-out');
                        setTimeout(() => {
                            overlay.remove();
                        }, 1200);
                    }
                }

                window.onload = async function () {

                    // 言語設定を読み込んで適用
                    const savedLanguage = getData('app_language') || 'ja';
                    currentLanguage = savedLanguage;
                    applyTranslations();
                    applyFonts();

                    // Debug helpers for theme persistence (enable to trace where theme changes come from)
                    const DEBUG_THEME = true;
                    if (DEBUG_THEME) {
                        window.addEventListener('storage', (e) => {
                            if (e.key === 'theme') {
                                console.log('[DEBUG] storage event theme changed:', e.oldValue, '=>', e.newValue);
                                const newTheme = (e.newValue || '').trim();
                                if (newTheme) changeTheme(newTheme);
                            }
                        });

                        const bodyObserver = new MutationObserver(mutations => {
                            for (const m of mutations) {
                                if (m.type === 'attributes' && m.attributeName === 'data-theme') {
                                    console.log('[DEBUG] body data-theme changed to', document.body.getAttribute('data-theme'));
                                    console.trace();
                                }
                            }
                        });
                        bodyObserver.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });

                        console.log('[DEBUG] initial stored theme:', getData('theme'));
                    }

                    const mode = getData('mode');
                    const theme = (getData('theme') || '').trim();
                    const themeIcon = document.getElementById('themeIcon');
                    if (mode === 'dark') {
                        document.body.classList.remove('light');
                        document.body.classList.add('dark');
                        themeIcon.src = 'sun.webp';
                        themeIcon.alt = getText('toggleLightMode');
                    }
                    if (theme) {
                        document.body.setAttribute('data-theme', theme);
                        document.querySelectorAll('.theme-option').forEach(option => { option.classList.remove('selected'); });
                        const matchedThemeOption = document.querySelector(`.theme-option[data-theme="${theme}"]`);
                        if (matchedThemeOption) matchedThemeOption.classList.add('selected');
                    } else {
                        // No stored theme found — persist the current body theme to avoid reverting to default unexpectedly
                        const currentTheme = document.body.getAttribute('data-theme') || 'blue';
                        console.log('[DEBUG] No stored theme found on load. Saving current body theme ->', currentTheme);
                        saveData('theme', currentTheme);
                    }
                    const musicEnabled = getData('feature_music') === 'true';
                    const todoEnabled = getData('feature_todo') === 'true';

                    // Initialize Focus Mode Settings
                    const focusInfoEnabled = getData('feature_focus_mode_display') !== 'false'; // Default to true
                    if (focusInfoEnabled) {
                        document.getElementById('toggleFocusDisplay').classList.add('active');
                        document.getElementById('focusModeToggleContainer').style.display = 'block';
                    } else {
                        document.getElementById('toggleFocusDisplay').classList.remove('active');
                        document.getElementById('focusModeToggleContainer').style.display = 'none';
                    }

                    const savedFocusDuration = getData('focus_duration');
                    if (savedFocusDuration) {
                        document.getElementById('focusDurationSelect').value = savedFocusDuration;
                    }

                    const savedBreakDuration = getData('break_duration');
                    if (savedBreakDuration) {
                        document.getElementById('breakDurationSelect').value = savedBreakDuration;
                    }

                    // Restore focus mode state
                    const savedFocusState = getData('focus_mode_enabled');
                    if (savedFocusState === 'true') {
                        // Initialize UI for focus mode without forcing a cycle advance
                        toggleFocusModeMain(true);
                    } else {
                        toggleFocusModeMain(true);
                    }

                    // Load developer mode state
                    const savedDevMode = getData('dev_mode_enabled');
                    if (savedDevMode === 'true') {
                        devModeEnabled = true;
                        const devToggle = document.getElementById('toggleDevMode');
                        if (devToggle) devToggle.classList.add('active');
                    }

                    // Persist current theme on visibility change and beforeunload to avoid lost writes


                    // Defensive: ignore programmatic (synthetic) clicks on theme options which may be triggered by other scripts
                    document.querySelectorAll('.theme-option').forEach(option => {
                        const themeName = option.getAttribute('data-theme');
                        // Remove inline onclick to avoid duplicate handlers and replace with a trusted-only handler
                        try { option.onclick = null; } catch (e) { /* ignore */ }
                        option.setAttribute('role', 'button');
                        option.tabIndex = 0;
                        option.addEventListener('click', (e) => {
                            if (!e.isTrusted) {
                                console.log('[DEBUG] Ignored synthetic click on theme-option', themeName);
                                return;
                            }
                            changeTheme(themeName);
                        });
                        option.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                changeTheme(themeName);
                            }
                        });
                    });

                    if (musicEnabled) {
                        document.getElementById('toggleMusic').classList.add('active');
                        addMenuButton('music');
                    }
                    if (todoEnabled) {
                        document.getElementById('toggleTodo').classList.add('active');
                        addMenuButton('todo');
                    }

                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];
                    if (history.length > 0) {
                        const last = history[0];
                        const start = new Date(last.start);
                        const end = new Date(last.end);
                        document.getElementById('sessionInfo').innerHTML =
                            `${getText('previousSession')}<br>${getText('startTime')}: ${formatDateTime(start)}<br>${getText('endTime')}: ${formatDateTime(end)}<br>${getText('studyTime')}: ${formatTime(last.duration)}`;
                    }

                    // 以前のセッションがあれば復元(リロードやタブ閉じ後も継続)
                    (function restoreOngoingSession() {
                        const startCookie = getData('studyStartTime');
                        if (!startCookie) return;

                        // クッキーの妥当性チェック(古いクッキーを無視)
                        const startDate = new Date(startCookie);
                        if (isNaN(startDate.getTime())) return; // 無効な日付形式

                        const now = Date.now();
                        const startTime_ms = startDate.getTime();
                        const MAX_SESSION_HOURS = 24; // セッションの最大時間(24時間)

                        // セッション開始時刻が未来または24時間以上前の場合は無視
                        if (startTime_ms > now || (now - startTime_ms) > MAX_SESSION_HOURS * 60 * 60 * 1000) {
                            // 古いクッキーをクリア
                            setCookie('studyStartTime', '', -1);
                            setCookie('studyPaused', '', -1);
                            setCookie('studyPausedAccum', '', -1);
                            return;
                        }

                        const pausedAccum = parseInt(getData('studyPausedAccum') || '0', 10) || 0;
                        const pausedFlag = getData('studyPaused') === 'true';

                        // pausedAccum の妥当性チェック(負数や異常に大きい値は無視)
                        if (pausedAccum < 0 || pausedAccum > MAX_SESSION_HOURS * 60 * 60 * 1000) {
                            setCookie('studyStartTime', '', -1);
                            setCookie('studyPaused', '', -1);
                            setCookie('studyPausedAccum', '', -1);
                            return;
                        }

                        // 表示・ボタン状態
                        document.getElementById('startBtn').classList.add('hidden');
                        document.getElementById('pauseBtn').classList.remove('hidden');
                        document.getElementById('endBtn').classList.remove('hidden');
                        document.getElementById('sessionInfo').textContent = `${getText('startTime')}: ${formatDateTime(startDate)}`;
                        // 変数復元
                        startTime = startTime_ms;
                        pausedTime = pausedAccum;
                        isPaused = pausedFlag;
                        if (isPaused) {
                            document.getElementById('pauseBtn').textContent = '再開';
                            // 表示は一時停止時の時間
                            document.getElementById('timer').textContent = formatTime(pausedTime);
                        } else {
                            document.getElementById('pauseBtn').textContent = '一時停止';
                            if (timerInterval) clearInterval(timerInterval);
                            timerInterval = setInterval(updateTimer, 100);
                            updateTimer();
                        }
                        updateSettingsButtonState();
                    })();

                    // 各種設定のロード(グラフ以外)
                    if (getData('lock_settings_during_timer') === 'true') {
                        document.getElementById('toggleLockSettings').classList.add('active');
                    }
                    if (getData('feature_music') === 'true') {
                        document.getElementById('toggleMusic').classList.add('active');
                        addMenuButton('music');
                    }
                    if (getData('feature_todo') === 'true') {
                        document.getElementById('toggleTodo').classList.add('active');
                        addMenuButton('todo');
                    }
                    if (getData('feature_title_time') !== 'false') { // デフォルトON
                        document.getElementById('toggleTitleTime').classList.add('active');
                    }
                    if (getData('feature_loading_anim') !== 'false') { // デフォルトON
                        const toggle = document.getElementById('toggleLoadingAnim');
                        if (toggle) toggle.classList.add('active');
                    }

                    const loopImg = document.getElementById('loopBtnImg');
                    if (loopImg) {
                        loopImg.src = isLoop ? 'loop_on.webp' : 'loop_off.webp';
                        loopImg.alt = isLoop ? 'ループオン' : 'ループオフ';
                        document.getElementById('loopBtn').style.opacity = isLoop ? '1' : '0.5';
                    }
                    const shImg = document.getElementById('shuffleBtnImg');
                    if (shImg) {
                        shImg.src = isShuffle ? 'shuffle_on.webp' : 'shuffle_off.webp';
                        shImg.alt = isShuffle ? 'シャッフルオン' : 'シャッフルオフ';
                        document.getElementById('shuffleBtn').style.opacity = isShuffle ? '1' : '0.5';
                    }
                    const playImg = document.getElementById('playIconImg');
                    if (playImg) {
                        playImg.src = 'play.webp';
                        playImg.alt = '再生';
                    }

                    const audioEl = document.getElementById('audioPlayer');
                    const volumeSlider = document.getElementById('volumeSlider');
                    const volumeBtnImg = document.getElementById('volumeBtnImg');
                    if (audioEl) {
                        audioEl.volume = 1;
                        if (volumeSlider) {
                            volumeSlider.value = audioEl.volume;
                            volumeSlider.style.display = 'none';
                        }
                        if (volumeBtnImg) volumeBtnImg.src = 'volume.webp';
                    }
                    await (async () => {
                        try {
                            const playlistCookie = getData('musicPlaylist');
                            if (playlistCookie) {
                                const list = JSON.parse(playlistCookie);
                                for (const item of list) {
                                    try {
                                        const blob = await getFileBlobFromDB(item.id);
                                        if (blob) {
                                            const url = URL.createObjectURL(blob);
                                            musicFiles.push({ url: url, title: item.title, id: item.id });
                                        }
                                    } catch (e) {
                                        console.warn('Error loading blob for', item, e);
                                    }
                                }
                                if (musicFiles.length > 0) loadPlaylist();
                            }
                        } catch (e) {
                            console.error('Failed to restore playlist from DB', e);
                        }
                    })();

                    const todoInput = document.getElementById('todoInput');
                    const addButton = document.querySelector('.todo-input button');
                    if (addButton) {
                        addButton.addEventListener('click', function (e) {
                            e.preventDefault();
                            if (todoInput.value.trim()) {
                                addTodo();
                            }
                        });
                    }

                    document.getElementById('todoInput').addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addTodo();
                        }
                    });

                    (function () {
                        const dropdownArrow = document.getElementById('musicDropdownArrow');
                        const dropdownMenu = document.getElementById('musicDropdownMenu');
                        const chooseFolder = document.getElementById('chooseFolderItem');
                        const folderInput = document.getElementById('musicFolderInput');
                        const fileLabel = document.querySelector('.file-select-label');

                        function closeMenu() {
                            if (dropdownMenu) { dropdownMenu.style.display = 'none'; dropdownMenu.setAttribute('aria-hidden', 'true'); }
                            if (dropdownArrow) dropdownArrow.setAttribute('aria-expanded', 'false');
                        }

                        function openMenu() {
                            if (dropdownMenu) { dropdownMenu.style.display = 'block'; dropdownMenu.setAttribute('aria-hidden', 'false'); }
                            if (dropdownArrow) dropdownArrow.setAttribute('aria-expanded', 'true');
                        }

                        if (dropdownArrow) {
                            dropdownArrow.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (!dropdownMenu) return;
                                if (dropdownMenu.style.display === 'block') closeMenu();
                                else openMenu();
                            });
                            dropdownArrow.addEventListener('mousedown', (e) => e.stopPropagation());
                            dropdownArrow.addEventListener('pointerdown', (e) => e.stopPropagation());
                            dropdownArrow.addEventListener('touchstart', (e) => e.stopPropagation());
                        }

                        if (fileLabel) {
                            fileLabel.addEventListener('click', (e) => {
                                if (e.target && e.target.closest && e.target.closest('.file-select-arrow')) return;
                                const fileInput = document.getElementById('musicFileInput');
                                if (fileInput) fileInput.click();
                                closeMenu();
                            });
                        }

                        if (chooseFolder && folderInput) {
                            chooseFolder.addEventListener('click', (e) => {
                                e.stopPropagation();
                                folderInput.click();
                                closeMenu();
                            });
                        }

                        document.addEventListener('click', (e) => {
                            const target = e.target;
                            if (!dropdownMenu) return;
                            if (!dropdownMenu.contains(target) && target !== dropdownArrow) closeMenu();
                        });
                    })();
                    // 初回訪問時のチュートリアル表示
                    setTimeout(() => {
                        showTutorialWelcome();
                    }, 500);
                    const graphEnabled = getData('graph_enabled') === 'true';
                    if (graphEnabled) {
                        document.getElementById('toggleGraph').classList.add('active');
                        document.getElementById('graphSettings').style.display = 'block';

                        const graphType = getData('graph_type') || 'bar';
                        const graphPeriod = getData('graph_period') || '30';
                        const graphLocation = getData('graph_location') || 'list';

                        document.getElementById('graphType').value = graphType;
                        document.getElementById('graphPeriod').value = graphPeriod;
                        document.getElementById('graphLocation').value = graphLocation;

                        setTimeout(() => updateGraphs(), 200);
                    } else {
                        // グラフが無効の場合はデフォルト設定を適用
                        setCookie('graph_enabled', 'true');
                        setCookie('graph_type', 'bar');
                        setCookie('graph_period', '30');
                        setCookie('graph_location', 'list');
                        document.getElementById('toggleGraph').classList.add('active');
                        document.getElementById('graphSettings').style.display = 'block';
                        setTimeout(() => updateGraphs(), 200);
                    }

                    // ショートカットキーの処理
                    document.addEventListener('keydown', (e) => {
                        // IME入力中は無視
                        if (e.isComposing) return;

                        const activePageId = Array.from(document.querySelectorAll('.page')).find(p => {
                            const style = window.getComputedStyle(p);
                            return style.display !== 'none';
                        })?.id;

                        // 音楽ページのショートカット
                        if (activePageId === 'musicPage') {
                            if (e.code === 'Space') {
                                e.preventDefault();
                                togglePlay();
                            } else if (e.key.toLowerCase() === 'n') {
                                e.preventDefault();
                                playNext();
                            } else if (e.key.toLowerCase() === 'b') {
                                e.preventDefault();
                                playPrevious();
                            } else if (e.key.toLowerCase() === 's') {
                                e.preventDefault();
                                toggleShuffle();
                            } else if (e.key.toLowerCase() === 'r') {
                                e.preventDefault();
                                toggleLoop();
                            }
                        }

                        // タイマーページのショートカット
                        if (activePageId === 'timerPage') {
                            if (e.key.toLowerCase() === 's') {
                                e.preventDefault();
                                const startBtn = document.getElementById('startBtn');
                                const endBtn = document.getElementById('endBtn');

                                if (!startBtn.classList.contains('hidden')) {
                                    startStudy();
                                } else if (!endBtn.classList.contains('hidden')) {
                                    endStudy();
                                }
                            } else if (e.code === 'Space') {
                                e.preventDefault();
                                const pauseBtn = document.getElementById('pauseBtn');

                                // 一時停止ボタンが表示されている場合のみ動作
                                if (!pauseBtn.classList.contains('hidden')) {
                                    pauseStudy();
                                }
                            }
                        }
                    });

                    // Finish loading after all initializations
                    finishLoading();
                };
                let studyChart = null;
                let statsChart = null;

                function toggleLoadingAnim() {
                    const toggle = document.getElementById('toggleLoadingAnim');
                    const isActive = toggle.classList.contains('active');

                    if (isActive) {
                        toggle.classList.remove('active');
                        saveData('feature_loading_anim', 'false');
                    } else {
                        toggle.classList.add('active');
                        saveData('feature_loading_anim', 'true');
                    }
                }

                function toggleLockSettingsDuringTimer() {
                    const toggle = document.getElementById('toggleLockSettings');
                    const isActive = toggle.classList.contains('active');
                    if (isActive) {
                        toggle.classList.remove('active');
                        saveData('lock_settings_during_timer', 'false');
                    } else {
                        toggle.classList.add('active');
                        saveData('lock_settings_during_timer', 'true');
                    }
                    updateSettingsButtonState();
                }

                function updateSettingsButtonState() {
                    const isTimerRunning = startTime !== null && !isPaused;
                    const lockDuringTimer = getData('lock_settings_during_timer') === 'true';
                    const settingsBtn = document.getElementById('settingsBtn');
                    const settingsIcon = document.getElementById('settingsIcon');
                    if (!settingsBtn || !settingsIcon) return;

                    if (isTimerRunning && lockDuringTimer) {
                        settingsIcon.src = 'no_settings.webp';
                        settingsBtn.style.pointerEvents = 'none';
                        settingsBtn.style.opacity = '0.7';
                    } else {
                        settingsIcon.src = 'settings.webp';
                        settingsBtn.style.pointerEvents = 'auto';
                        settingsBtn.style.opacity = '1';
                    }
                }

                function toggleGraph() {
                    const toggle = document.getElementById('toggleGraph');
                    const settings = document.getElementById('graphSettings');
                    const isActive = toggle.classList.contains('active');

                    if (isActive) {
                        toggle.classList.remove('active');
                        settings.style.display = 'none';
                        saveData('graph_enabled', 'false');
                        hideGraphs();
                    } else {
                        toggle.classList.add('active');
                        settings.style.display = 'block';
                        saveData('graph_enabled', 'true');
                        saveGraphSettings();
                    }
                }

                function saveGraphSettings() {
                    const type = document.getElementById('graphType').value;
                    const period = document.getElementById('graphPeriod').value;
                    const location = document.getElementById('graphLocation').value;

                    saveData('graph_type', type);
                    saveData('graph_period', period);
                    saveData('graph_location', location);

                    updateGraphs();
                }

                function hideGraphs() {
                    document.getElementById('studyGraphContainer').style.display = 'none';
                    document.getElementById('statsGraphContainer').style.display = 'none';
                    if (studyChart) {
                        studyChart.destroy();
                        studyChart = null;
                    }
                    if (statsChart) {
                        statsChart.destroy();
                        statsChart = null;
                    }
                }

                function showGraphs() {
                    document.getElementById('studyGraphContainer').style.display = 'block';
                    document.getElementById('statsGraphContainer').style.display = 'block';
                }

                function updateGraphs() {
                    const enabled = getData('graph_enabled') === 'true';
                    if (!enabled) {
                        hideGraphs();
                        return;
                    }

                    const location = getData('graph_location') || 'list';

                    if (location === 'list' || location === 'both') {
                        const container = document.getElementById('studyGraphContainer');
                        if (container) {
                            container.style.display = 'block';
                            setTimeout(() => renderGraph('studyChart', 'studyChart'), 50);
                        }
                    } else {
                        document.getElementById('studyGraphContainer').style.display = 'none';
                    }

                    if (location === 'stats' || location === 'both') {
                        const container = document.getElementById('statsGraphContainer');
                        if (container) {
                            container.style.display = 'block';
                            setTimeout(() => renderGraph('statsChart', 'statsChart'), 50);
                        }
                    } else {
                        document.getElementById('statsGraphContainer').style.display = 'none';
                    }
                }

                function getPrimaryColor() {
                    const theme = document.body.getAttribute('data-theme') || 'blue';
                    const colors = {
                        'blue': '#9db4c8',
                        'green': '#a8c9a8',
                        'purple': '#b8a8c9',
                        'orange': '#d9b4a0',
                        'pink': '#d9a8b4',
                        'teal': '#a0c9c9',
                        'white': '#ededed'
                    };
                    return colors[theme] || colors['blue'];
                }

                function renderGraph(canvasId, chartVar) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;

                    const type = getData('graph_type') || 'bar';
                    const period = getData('graph_period') || '30';

                    let history = getData('studyHistory');
                    history = history ? JSON.parse(history) : [];

                    if (history.length === 0) {
                        console.log('No history data for graph');
                        return;
                    }

                    const now = new Date();
                    let startDate = new Date();

                    if (period === 'all') {
                        startDate = new Date(0);
                    } else {
                        startDate.setDate(now.getDate() - parseInt(period));
                    }

                    history = history.filter(item => {
                        const itemDate = new Date(item.start);
                        return itemDate >= startDate;
                    });

                    if (history.length === 0) {
                        console.log('No history data after date filter');
                        return;
                    }

                    const dailyData = {};
                    history.forEach(item => {
                        const date = new Date(item.start);
                        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                        if (!dailyData[dateKey]) {
                            dailyData[dateKey] = 0;
                        }
                        dailyData[dateKey] += item.duration;
                    });

                    const sortedDates = Object.keys(dailyData).sort();
                    const labels = sortedDates.map(date => {
                        const d = new Date(date);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    });
                    const data = sortedDates.map(date => dailyData[date] / (1000 * 60 * 60));

                    if (chartVar === 'studyChart' && studyChart) {
                        studyChart.destroy();
                        studyChart = null;
                    } else if (chartVar === 'statsChart' && statsChart) {
                        statsChart.destroy();
                        statsChart = null;
                    }

                    const isDark = document.body.classList.contains('dark');
                    const textColor = isDark ? '#e8e8e8' : '#323232';
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const primaryColor = getPrimaryColor();

                    const config = {
                        type: type === 'area' ? 'line' : type,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '勉強時間(時間)',
                                data: data,
                                backgroundColor: type === 'area' ? primaryColor + '40' : primaryColor,
                                borderColor: primaryColor,
                                borderWidth: 2,
                                fill: type === 'area',
                                tension: type === 'line' || type === 'area' ? 0.4 : 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: textColor
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                }
                            }
                        }
                    };

                    const ctx = canvas.getContext('2d');
                    if (chartVar === 'studyChart') {
                        studyChart = new Chart(ctx, config);
                    } else {
                        statsChart = new Chart(ctx, config);
                    }
                }

                const todoInput = document.getElementById("todoInput");

                todoInput.addEventListener("compositionstart", () => {
                    todoInput.isComposing = true;
                });

                todoInput.addEventListener("compositionend", () => {
                    todoInput.isComposing = false;
                });

                // ToDo Ver.2 初期化
                function initTodoV2() {
                    // 初回ポップアップ表示
                    showTodoV2Popup();

                    // UI同期 (設定画面など)
                    syncTodoV2UI();
                }

                // ページ読み込み時にToDo Ver.2を初期化
                setTimeout(() => {
                    initTodoV2();
                }, 1000); // ローディングアニメーション後に表示

                // Trigger loading overlay wipe animation
                // Trigger loading overlay wipe animation (Moved to window.onload)

            </script>
</body>

</html>